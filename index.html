<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAVMIS DATA COLLECTOR MODULE | Offline Satellite</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --sidebar-width: 480px; 
            --primary: #2c3e50; 
            --accent: #3498db; 
            --success: #27ae60; 
            --valuation: #f39c12; 
            --panel-bg: #ffffff; 
            --warning: #e74c3c;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border: #e0e0e0;
            --light-bg: #f8f9fa;
            --firebase: #FFA611;
        }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%; 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            overflow: hidden; 
            display: flex; 
            background-color: #f5f7fa;
            color: var(--text-primary);
        }
        
        /* LOGIN MODAL STYLES - White theme */
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--accent);
            text-align: center;
        }
        
        .login-container h2 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-input-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .login-input-group input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .login-input-group input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .login-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        
        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.3);
        }
        
        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .login-error {
            color: var(--warning);
            font-size: 0.85rem;
            margin-top: 5px;
            min-height: 20px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }
        
        .login-logo i {
            font-size: 36px;
            color: white;
        }
        
        .login-footer {
            margin-top: 25px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        
        .login-attempts {
            font-size: 0.75rem;
            color: var(--valuation);
            margin-top: 10px;
            font-weight: 500;
        }
        
        .locked-out {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* BACKUP PROGRESS MODAL */
        #backupProgressModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .backup-progress-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border-top: 4px solid var(--accent);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .backup-progress-container h3 {
            color: var(--accent);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--light-bg);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .backup-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            text-align: left;
        }
        
        .backup-stat {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .backup-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .backup-stat-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .backup-success {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }
        
        .backup-success i {
            color: var(--success);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        /* HIDE MAIN CONTENT BEFORE LOGIN */
        #mainContent {
            display: none;
            width: 100%;
            height: 100%;
        }
        
        /* SIDEBAR - White Theme */
        #sidebar { 
            width: var(--sidebar-width); 
            background: white; 
            color: var(--text-primary); 
            padding: 20px; 
            overflow-y: auto; 
            z-index: 2000; 
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        
        #map { 
            flex-grow: 1; 
            height: 100%; 
            z-index: 1; 
            background: #f0f2f5; 
            cursor: crosshair;
        }
        
        .status-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .indicator { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            letter-spacing: 0.5px;
        }
        
        .on { background: #e8f6ef; color: var(--success); border: 1px solid #d5f0e1; }
        .off { background: #fdeaea; color: var(--warning); border: 1px solid #f9d6d6; }
        .warning-ind { background: #fef9e7; color: var(--valuation); border: 1px solid #fcf3cf; }
        .firebase-ind { background: #fff3e0; color: var(--firebase); border: 1px solid #ffe0b2; }

        .panel { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: box-shadow 0.2s;
        }
        
        .panel:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .panel h3 {
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .cache-controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 10px; 
        }
        
        /* BUTTONS - Modern White Theme */
        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        button.warning { 
            background: var(--warning); 
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
        }
        
        button.success { 
            background: var(--success); 
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.2);
        }
        
        button.secondary { 
            background: #95a5a6; 
            box-shadow: 0 2px 4px rgba(149, 165, 166, 0.2);
        }
        
        button.point { 
            background: #8e44ad; 
            box-shadow: 0 2px 4px rgba(142, 68, 173, 0.2);
        }
        
        button.info { 
            background: #3498db; 
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
        }
        
        button.firebase { 
            background: linear-gradient(135deg, #FFA611 0%, #F57C00 100%); 
            box-shadow: 0 2px 4px rgba(255, 166, 17, 0.3);
        }
        
        /* INPUTS & SELECTS - White Theme */
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 8px; 
            border: 1px solid var(--border);
            box-sizing: border-box;
            font-size: 0.9rem;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .small-input {
            font-size: 0.85rem !important;
            padding: 10px !important;
        }
        
        .property-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 10px 0;
        }
        
        .property-fields.full-width {
            grid-template-columns: 1fr;
        }
        
        .field-group {
            margin: 8px 0;
        }
        
        .field-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .required::after {
            content: " *";
            color: var(--warning);
        }
        
        .optional::after {
            content: " (Optional)";
            color: var(--text-secondary);
            font-size: 0.8em;
            font-weight: normal;
        }
        
        .registration-type-toggle {
            display: flex;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .registration-type-toggle button {
            flex: 1;
            border-radius: 0;
            padding: 12px;
            background: transparent;
            color: var(--text-secondary);
            box-shadow: none;
        }
        
        .registration-type-toggle button.active {
            background: var(--accent);
            color: white;
        }
        
        .location-toggle {
            display: flex;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .location-toggle button {
            flex: 1;
            border-radius: 0;
            padding: 12px;
            background: transparent;
            color: var(--text-secondary);
            box-shadow: none;
        }
        
        .location-toggle button.active {
            background: var(--accent);
            color: white;
        }
        
        .gps-status {
            padding: 15px;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
        }
        
        .gps-accuracy-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .gps-accuracy-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s, background 0.5s;
        }
        
        .gps-status-text {
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .table-container { 
            background: var(--light-bg); 
            border-radius: 8px; 
            overflow-x: auto; 
            max-height: 180px;
            font-size: 0.8rem; 
            flex-grow: 1;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        
        .log-container {
            background: var(--light-bg);
            border-radius: 8px;
            overflow-x: auto;
            max-height: 180px;
            font-size: 0.8rem;
            flex-grow: 1;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .log-header {
            padding: 12px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }
        
        .log-content {
            padding: 12px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .log-entry {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid var(--accent);
            font-size: 0.8rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .log-entry.success {
            border-left-color: var(--success);
            background: linear-gradient(to right, #e8f6ef 0%, white 100%);
        }
        
        .log-entry.warning {
            border-left-color: var(--valuation);
            background: linear-gradient(to right, #fef9e7 0%, white 100%);
        }
        
        .log-entry.error {
            border-left-color: var(--warning);
            background: linear-gradient(to right, #fdeaea 0%, white 100%);
        }
        
        .log-entry.firebase {
            border-left-color: var(--firebase);
            background: linear-gradient(to right, #fff3e0 0%, white 100%);
        }
        
        .log-entry.rejected {
            border-left-color: #e74c3c;
            background: linear-gradient(to right, #fdeaea 0%, white 100%);
            animation: pulse-rejected 2s infinite;
        }
        
        .log-entry.notification {
            border-left-color: #9b59b6;
            background: linear-gradient(to right, #f4ecf7 0%, white 100%);
        }
        
        @keyframes pulse-rejected {
            0%, 100% { box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
            50% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }
        }
        
        .log-time {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .log-message {
            color: var(--text-primary);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        th, td { 
            padding: 10px 12px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
        }
        
        th {
            background: white;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover { 
            background: rgba(52, 152, 219, 0.05); 
            cursor: pointer; 
        }
        
        .preview-panel {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .preview-panel h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.9rem;
        }
        
        .preview-item {
            margin-bottom: 8px;
        }
        
        .preview-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .preview-value {
            color: var(--text-primary);
            word-break: break-word;
        }
        
        .evidence-container {
            margin: 15px 0;
        }
        
        .camera-btn {
            width: 100%;
            margin: 5px 0;
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%) !important;
            color: white;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #coordinates {
            font-size: 0.85rem;
            color: var(--text-primary);
            text-align: center;
            padding: 12px;
            background: var(--light-bg);
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid var(--border);
            font-weight: 500;
        }
        
        @media (max-width: 768px) { 
            body { flex-direction: column; } 
            #sidebar { width: 100%; height: 50%; } 
            #map { height: 50%; } 
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-controls button {
            background: white;
            color: var(--primary);
            border-radius: 8px;
            padding: 12px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid var(--border);
            width: 45px;
            height: 45px;
        }
        
        .manual-marker {
            background: none;
            border: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .gps-accuracy-threshold {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }
        
        .auto-center-control {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .auto-center-control button {
            background: white;
            color: var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid var(--border);
        }
        
        .auto-center-control button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .storage-status {
            padding: 15px;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }
        
        .storage-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .storage-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(90deg, #27ae60, #f39c12);
            transition: width 0.5s;
        }
        
        .storage-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .storage-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .modal h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-backup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .section-title {
            color: var(--primary);
            font-size: 0.95rem;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light-bg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Danger confirmation modal styles */
        .danger-confirmation {
            z-index: 5000;
        }
        
        .danger-modal {
            background: white;
            border: 2px solid #e74c3c;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.15);
            animation: danger-pulse 2s infinite;
        }
        
        @keyframes danger-pulse {
            0% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.15); }
            50% { box-shadow: 0 0 40px rgba(231, 76, 60, 0.25); }
            100% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.15); }
        }
        
        .danger-modal h3 {
            color: #e74c3c !important;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
            text-align: center;
        }
        
        .danger-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            color: white !important;
            font-weight: 600 !important;
            border: none !important;
        }
        
        .danger-btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important;
        }
        
        /* User info in status bar */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            background: rgba(52, 152, 219, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            color: var(--accent);
            font-weight: 500;
        }
        
        .logout-btn {
            background: transparent !important;
            color: #e74c3c !important;
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
            border: 1px solid #e74c3c !important;
            box-shadow: none !important;
        }
        
        .logout-btn:hover {
            background: #e74c3c !important;
            color: white !important;
        }
        
        /* Auto-backup notification */
        .auto-backup-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 4000;
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideUp 0.3s ease-out;
            border: none;
        }
        
        .firebase-sync-notification {
            background: linear-gradient(135deg, var(--firebase) 0%, #F57C00 100%) !important;
        }
        
        .rejection-notification {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            z-index: 4001;
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .auto-backup-notification i {
            font-size: 1.2rem;
        }
        
        .auto-backup-notification span {
            font-weight: 600;
        }
        
        /* Admin Feedback Alert */
        #adminFeedbackAlert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 4003;
            display: none;
            border-left: 5px solid #e74c3c;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        
        #adminFeedbackAlert.approval {
            border-left-color: var(--success);
        }
        
        .feedback-content {
            padding: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-primary);
        }
        
        .feedback-content.rejected {
            background: linear-gradient(to right, #fdeaea 0%, white 100%);
        }
        
        .feedback-content.approved {
            background: linear-gradient(to right, #e8f6ef 0%, white 100%);
        }
        
        .feedback-content.reviewed {
            background: linear-gradient(to right, #fff3e0 0%, white 100%);
        }
        
        .feedback-content button {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .feedback-content button:hover {
            background: #2980b9;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Leaflet map controls - White theme */
        .leaflet-control-zoom {
            border: 1px solid var(--border) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            border-radius: 8px !important;
            overflow: hidden;
        }
        
        .leaflet-control-zoom a {
            background: white !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--border) !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: var(--light-bg) !important;
        }
        
        .leaflet-control-attribution {
            background: rgba(255, 255, 255, 0.9) !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
        }
        
        /* Toggle switch for manual entry */
        .manual-entry-toggle {
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        .toggle-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
        }
        
        .toggle-link:hover {
            color: #2980b9;
        }
        
        /* Sync status indicator */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .sync-pending { background: #fff3cd; color: #856404; }
        .sync-synced { background: #d4edda; color: #155724; }
        .sync-failed { background: #f8d7da; color: #721c24; }
        .sync-queued { background: #cce5ff; color: #004085; }
        
        /* Firebase status panel */
        .firebase-status {
            padding: 12px;
            margin: 10px 0;
            background: #fff3e0;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid #ffe0b2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .firebase-status.online {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }
        
        .firebase-status.offline {
            background: #ffebee;
            border-color: #ffcdd2;
        }
        
        .firebase-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .firebase-stat {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .firebase-stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .firebase-stat-value {
            font-size: 1rem;
            color: var(--firebase);
            font-weight: 600;
        }
        
        /* Rejection feedback styles */
        .rejection-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 350px;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            z-index: 4002;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .rejection-feedback h4 {
            color: #e74c3c;
            margin: 0 0 10px 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rejection-content {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
        }
        
        .rejection-property-id {
            background: #fdeaea;
            padding: 8px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
            color: #e74c3c;
        }
        
        .rejection-reason {
            background: #fef9e7;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid #f39c12;
        }
        
        .rejection-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Data Collector Notification Styles */
        .collector-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            width: 350px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            overflow: hidden;
            animation: slideInRight 0.3s ease;
            border-left: 5px solid var(--warning);
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        
        .collector-notification.approval {
            border-left-color: var(--success);
        }
        
        .collector-notification-header {
            padding: 15px;
            background: var(--light-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .collector-notification-body {
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-primary);
        }
        
        .collector-notification-footer {
            padding: 10px 15px;
            background: var(--light-bg);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Notification badge */
        .notification-badge {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .notification-icon-btn {
            background: transparent !important;
            color: var(--accent) !important;
            box-shadow: none !important;
            padding: 8px !important;
            width: 40px !important;
            height: 40px !important;
        }
        
        .notification-icon-btn:hover {
            background: rgba(52, 152, 219, 0.1) !important;
        }
        
        .notification-icon-btn.has-notifications {
            color: #e74c3c !important;
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>

<!-- LOGIN MODAL (MANDATORY) -->
<div id="loginModal">
    <div class="login-container">
        <div class="login-logo">
            <i class="fa-solid fa-map-location-dot"></i>
        </div>
        
        <h2><i class="fa-solid fa-lock"></i> LAVMIS ACCESS</h2>
        
        <div class="login-input-group">
            <label for="username"><i class="fa-solid fa-user"></i> EMAIL</label>
            <input type="email" id="username" placeholder="Enter your email" autocomplete="username" required>
        </div>
        
        <div class="login-input-group">
            <label for="password"><i class="fa-solid fa-key"></i> PASSWORD</label>
            <input type="password" id="password" placeholder="Enter password" autocomplete="current-password" required>
        </div>
        
        <div class="login-error" id="loginError"></div>
        
        <div class="login-attempts" id="loginAttempts">
            Attempts remaining: 5
        </div>
        
        <button class="login-button" id="loginButton">
            <i class="fa-solid fa-right-to-bracket"></i> LOGIN TO LAVMIS
        </button>
        
        <div class="login-footer">
            <p><i class="fa-solid fa-triangle-exclamation"></i> Authorized Personnel Only</p>
            <p style="font-size: 0.7rem; color: #7f8c8d;">District Valuation & Market Analysis System</p>
            <p style="font-size: 0.7rem; color: #FFA611; margin-top: 5px;">
                <i class="fa-solid fa-cloud"></i> Firebase Cloud Sync Enabled
            </p>
        </div>
    </div>
</div>

<!-- BACKUP PROGRESS MODAL -->
<div id="backupProgressModal">
    <div class="backup-progress-container">
        <h3><i class="fa-solid fa-download"></i> CREATING BACKUP</h3>
        
        <div class="progress-bar">
            <div class="progress-fill" id="backupProgressFill"></div>
        </div>
        
        <div class="progress-text" id="backupProgressText">Preparing backup...</div>
        
        <div class="backup-stats">
            <div class="backup-stat">
                <div class="backup-stat-label">Records to backup</div>
                <div class="backup-stat-value" id="backupRecordCount">0</div>
            </div>
            <div class="backup-stat">
                <div class="backup-stat-label">Backup Size</div>
                <div class="backup-stat-value" id="backupSize">0 MB</div>
            </div>
        </div>
        
        <div class="backup-success" id="backupSuccess">
            <i class="fa-solid fa-check-circle"></i>
            <div style="font-weight: bold; margin-bottom: 5px;">Backup Completed Successfully!</div>
            <div style="font-size: 0.8rem;" id="backupFileName">Backup file has been saved</div>
        </div>
        
        <div style="margin-top: 20px;">
            <button id="continueLogoutBtn" class="success" onclick="finishLogout()" style="display: none; width: 100%;">
                <i class="fa-solid fa-right-from-bracket"></i> Continue with Logout
            </button>
            <button id="cancelBackupBtn" class="secondary" onclick="cancelBackup()" style="width: 100%;">
                <i class="fa-solid fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- AUTO-BACKUP NOTIFICATION -->
<div class="auto-backup-notification" id="autoBackupNotification">
    <i class="fa-solid fa-shield-alt"></i>
    <div>
        <span>Auto-backup in progress...</span>
        <div style="font-size: 0.8rem; opacity: 0.9;">Data is being backed up before logout</div>
    </div>
</div>

<!-- FIREBASE SYNC NOTIFICATION -->
<div class="auto-backup-notification firebase-sync-notification" id="firebaseSyncNotification">
    <i class="fa-solid fa-cloud-upload-alt"></i>
    <div>
        <span id="firebaseSyncMessage">Firebase sync in progress...</span>
        <div style="font-size: 0.8rem; opacity: 0.9;" id="firebaseSyncDetails">Syncing data to cloud</div>
    </div>
</div>

<!-- REJECTION FEEDBACK NOTIFICATION -->
<div class="auto-backup-notification rejection-notification" id="rejectionNotification" style="display: none;">
    <i class="fa-solid fa-exclamation-triangle"></i>
    <div>
        <span id="rejectionNotificationTitle">Submission Rejected</span>
        <div style="font-size: 0.8rem; opacity: 0.9;" id="rejectionNotificationDetails">Click to view details</div>
    </div>
</div>

<!-- REJECTION FEEDBACK MODAL -->
<div class="rejection-feedback" id="rejectionFeedback">
    <h4><i class="fa-solid fa-exclamation-triangle"></i> SUBMISSION REJECTED</h4>
    <div class="rejection-content">
        <div class="rejection-property-id" id="rejectionPropertyId">PRO-001</div>
        <p><strong>Reason for rejection:</strong></p>
        <div class="rejection-reason" id="rejectionReasonText">Your submission was rejected due to incomplete information.</div>
        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
            <i class="fa-solid fa-lightbulb"></i> Please review the feedback and resubmit with corrections.
        </p>
    </div>
    <div class="rejection-actions">
        <button onclick="hideRejectionFeedback()" class="secondary" style="flex: 1;">
            <i class="fa-solid fa-times"></i> Dismiss
        </button>
        <button onclick="loadRejectedPropertyIntoForm()" class="warning" style="flex: 1;">
            <i class="fa-solid fa-edit"></i> Edit & Resubmit
        </button>
    </div>
</div>

<!-- ADMIN FEEDBACK ALERT -->
<div id="adminFeedbackAlert" style="display: none;">
    <div class="feedback-content" id="feedbackContent">
        <!-- Feedback content will be injected here -->
    </div>
</div>

<!-- MAIN CONTENT (HIDDEN UNTIL LOGIN) -->
<div id="mainContent">
    <div id="sidebar">
        <div class="status-bar">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="net-label" class="indicator on">ONLINE</span>
                <span id="firebase-status-ind" class="indicator firebase-ind" style="display: none;">
                    <i class="fa-solid fa-cloud"></i> FIREBASE
                </span>
                <div class="user-info" id="userInfo">
                    <i class="fa-solid fa-user-check"></i>
                    <span id="loggedInUser">User</span>
                    <button class="logout-btn" onclick="initiateLogout()" title="Logout" id="logoutBtn">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
                <!-- Notification button -->
                <div class="notification-badge" id="notificationBadge" style="display: none;">
                    <button class="notification-icon-btn" onclick="showAllNotifications()" id="notificationButton" title="Notifications">
                        <i class="fa-solid fa-bell"></i>
                        <span class="notification-count" id="notificationCount">0</span>
                    </button>
                </div>
            </div>
            <span style="font-size: 1.2rem; font-weight: bold; color: var(--valuation);">LAVMIS DATA COLLECTOR MODULE</span>
        </div>

        <!-- Firebase Status Panel -->
        <div class="panel" id="firebaseStatusPanel" style="display: none;">
            <h3><i class="fa-solid fa-fire"></i> Firebase Cloud Status</h3>
            
            <div class="firebase-status" id="firebaseConnectionStatus">
                <i class="fa-solid fa-cloud"></i>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 600; font-size: 0.9rem;" id="firebaseStatusText">Connecting to Firebase...</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);" id="firebaseStatusDetail">
                        Syncing with cloud database
                    </div>
                </div>
            </div>
            
            <div class="firebase-stats">
                <div class="firebase-stat">
                    <div class="firebase-stat-label">Synced Records</div>
                    <div class="firebase-stat-value" id="syncedRecords">0</div>
                </div>
                <div class="firebase-stat">
                    <div class="firebase-stat-label">Pending Sync</div>
                    <div class="firebase-stat-value" id="pendingSync">0</div>
                </div>
            </div>
            
            <button onclick="syncAllToFirebase()" class="firebase" style="width: 100%; margin-top: 10px;">
                <i class="fa-solid fa-cloud-arrow-up"></i> Sync All to Firebase
            </button>
        </div>

        <div class="panel">
            <h3><i class="fa-solid fa-map"></i> Offline Map Cache</h3>
            <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">Zoom into your project area while online, then click "Cache Visible Area" to save imagery for offline use.</p>
            <div class="cache-controls">
                <button onclick="cacheTiles()" style="background: var(--valuation); color: white;">
                    <i class="fa-solid fa-download"></i> Cache Area
                </button>
                <button onclick="clearCache()" class="secondary">
                    <i class="fa-solid fa-trash"></i> Clear Map
                </button>
            </div>
            <div id="cache-status" style="font-size: 0.8rem; margin-top: 10px; color: var(--text-secondary);">
                <i class="fa-solid fa-hard-drive"></i> Storage Used: Calculating...
            </div>
        </div>

        <div class="panel">
            <h3><i class="fa-solid fa-location-crosshairs"></i> Data Capture</h3>
            
            <div class="section-title">
                <i class="fa-solid fa-id-card"></i> Property Information
            </div>
            
            <div class="property-fields">
                <div class="field-group">
                    <label for="propertyId" class="required">Property ID</label>
                    <input type="text" id="propertyId" placeholder="Auto-generated" class="small-input" readonly>
                    <span id="propertySyncStatus" class="sync-status" style="display: none;"></span>
                </div>
                <div class="field-group">
                    <label for="propertyName" class="optional">Property Name</label>
                    <input type="text" id="propertyName" placeholder="Enter Property Name (Optional)" class="small-input">
                </div>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-file-signature"></i> Registration Type
            </div>
            
            <div class="registration-type-toggle" id="registrationTypeToggle">
                <button id="titledToggle" class="active" onclick="setRegistrationType('titled')">
                    <i class="fa-solid fa-file-contract"></i> Titled
                </button>
                <button id="untitledToggle" onclick="setRegistrationType('untitled')">
                    <i class="fa-solid fa-file-alt"></i> Untitled
                </button>
            </div>
            
            <div class="property-fields" id="titleFields">
                <div class="field-group">
                    <label for="plotNumber">Plot Number</label>
                    <input type="text" id="plotNumber" placeholder="Enter Plot Number" class="small-input">
                </div>
                <div class="field-group">
                    <label for="blockNumber">Block Number</label>
                    <input type="text" id="blockNumber" placeholder="Enter Block Number" class="small-input">
                </div>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-location-dot"></i> Location Information
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="districtCity" class="required">District/City</label>
                    <select id="districtCity" class="small-input" onchange="updateSubcounties()">
                        <option value="">Select District/City</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('districtCity')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="districtCityManual" placeholder="Type District/City manually" class="small-input" style="display: none;">
                </div>
            </div>
            
            <div class="property-fields">
                <div class="field-group">
                    <label for="subcounty" class="required">Subcounty</label>
                    <select id="subcounty" class="small-input" onchange="updateParishes()" disabled>
                        <option value="">Select Subcounty</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('subcounty')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="subcountyManual" placeholder="Type Subcounty manually" class="small-input" style="display: none;">
                </div>
                <div class="field-group">
                    <label for="parish" class="required">Parish</label>
                    <select id="parish" class="small-input" onchange="updateVillages()" disabled>
                        <option value="">Select Parish</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('parish')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="parishManual" placeholder="Type Parish manually" class="small-input" style="display: none;">
                </div>
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="village" class="required">Village</label>
                    <select id="village" class="small-input" disabled>
                        <option value="">Select Village</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('village')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="villageManual" placeholder="Type Village manually" class="small-input" style="display: none;">
                </div>
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="description" class="optional">Description/Remarks</label>
                    <textarea id="description" placeholder="Enter any remarks or description about the property" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: white; color: var(--text-primary); font-size: 0.9rem; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="dataSource" class="required">Data Source</label>
                    <select id="dataSource" class="small-input">
                        <option value="">Select Data Source</option>
                        <option value="Field Survey">Field Survey</option>
                        <option value="Land Registry">Land Registry</option>
                        <option value="Local Government">Local Government</option>
                        <option value="Property Owner">Property Owner</option>
                        <option value="Real Estate Agent">Real Estate Agent</option>
                        <option value="Community Leader">Community Leader</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-chart-line"></i> Location & Valuation
            </div>
            
            <div class="location-toggle">
                <button id="gpsToggle" class="active" onclick="setLocationMode('gps')">
                    <i class="fa-solid fa-satellite"></i> GPS Auto
                </button>
                <button id="manualToggle" onclick="setLocationMode('manual')">
                    <i class="fa-solid fa-map-pin"></i> Map Point
                </button>
            </div>
            
            <div class="gps-status">
                <i class="fa-solid fa-satellite" id="gpsIcon" style="color: var(--accent); font-size: 1.2rem;"></i>
                <div style="flex-grow: 1;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 500;">
                        <span id="gpsStatusText">Acquiring GPS...</span>
                        <span id="gpsAccuracy">-- m</span>
                    </div>
                    <div class="gps-accuracy-bar">
                        <div id="gpsAccuracyFill" class="gps-accuracy-fill" style="width: 0%; background: #e74c3c;"></div>
                    </div>
                    <div class="gps-status-text" id="gpsStatusDetail">
                        Need 3-20m accuracy to save data
                    </div>
                </div>
            </div>
            
            <div id="coordinates">Waiting for GPS...</div>
            
            <div style="margin: 15px 0;">
                <button onclick="clearManualPoint()" class="secondary" style="width: 100%;" id="clearPointBtn" disabled>
                    <i class="fa-solid fa-trash"></i> Clear Selected Point
                </button>
            </div>
            
            <div class="property-fields">
                <div class="field-group">
                    <label for="price" class="required">Total Price ($)</label>
                    <input type="number" id="price" placeholder="Total Price" step="0.01">
                </div>
                <div class="field-group">
                    <label for="size" class="required">Size (Ha)</label>
                    <input type="number" id="size" placeholder="Size (Ha)" step="0.01">
                </div>
            </div>
            
            <div class="field-group">
                <label for="use" class="required">Land Use</label>
                <select id="use">
                    <option value="">Select Land Use</option>
                    <option>Residential</option>
                    <option>Commercial</option>
                    <option>Agricultural</option>
                    <option>Industrial</option>
                    <option>Recreational</option>
                    <option>Mixed Use</option>
                    <option>Vacant Land</option>
                    <option>Forest</option>
                    <option>Wetland</option>
                </select>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-camera"></i> Evidence
            </div>
            
            <div class="evidence-container">
                <button class="camera-btn" onclick="capturePhoto()">
                    <i class="fa-solid fa-camera"></i> ADD EVIDENCE PHOTO (Optional)
                </button>
                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoUpload(event)">
                <img id="imagePreview" class="image-preview" alt="Evidence Preview">
                <button id="removePhotoBtn" class="warning" onclick="removePhoto()" style="display: none; width: 100%; margin-top: 10px;">
                    <i class="fa-solid fa-trash"></i> Remove Photo
                </button>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-user-tie"></i> Data Collector Information
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="officerName" class="required">Name of Officer (Data Collector)</label>
                    <input type="text" id="officerName" placeholder="Enter your full name">
                </div>
            </div>
            
            <button id="saveBtn" onclick="saveData()" class="success" style="width: 100%; margin-top: 15px; padding: 14px;" disabled>
                <i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD
            </button>
        </div>

        <div class="panel">
            <h3><i class="fa-solid fa-database"></i> Storage Status</h3>
            
            <div class="firebase-status" id="syncStatusInfo" style="display: none;">
                <i class="fa-solid fa-cloud"></i>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 600; font-size: 0.9rem;">Cloud Sync Status</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                        <span id="syncStatusText">Checking sync status...</span>
                    </div>
                </div>
            </div>
            
            <div class="storage-status">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: 500;">
                    <span>Local Data Usage</span>
                    <span id="recordCount">0 records</span>
                </div>
                <div class="storage-bar">
                    <div id="storageFill" class="storage-fill" style="width: 0%"></div>
                </div>
                <div class="storage-info">
                    <span id="storageUsed">0 MB</span>
                    <span id="storageTotal">Calculating...</span>
                </div>
            </div>
            
            <div class="storage-actions">
                <button onclick="showBackupModal()" class="info">
                    <i class="fa-solid fa-download"></i> Backup
                </button>
                <button onclick="showRestoreModal()" class="secondary">
                    <i class="fa-solid fa-upload"></i> Restore
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <button onclick="syncAllToFirebase()" class="firebase">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Sync Cloud
                </button>
                <button onclick="restoreFromFirebase()" class="warning">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Restore Cloud
                </button>
            </div>
            
            <button onclick="clearAllData()" class="warning" style="width: 100%; margin-top: 15px;">
                <i class="fa-solid fa-trash"></i> Clear All Data
            </button>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Property ID</th>
                        <th>Name</th>
                        <th>Plot No.</th>
                        <th>Rate/Ha</th>
                        <th>Sync</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="log-container">
            <div class="log-header">
                <h4 style="margin: 0; font-size: 1rem;"><i class="fa-solid fa-clipboard-list"></i> Activity Log</h4>
                <button onclick="clearLog()" class="secondary" style="padding: 6px 10px; font-size: 0.8rem;">
                    <i class="fa-solid fa-trash"></i> Clear
                </button>
            </div>
            <div class="log-content" id="logContent">
                <!-- Log entries will be added here -->
            </div>
        </div>
        
        <div id="dataPreview" class="preview-panel">
            <h4><i class="fa-solid fa-eye"></i> PROPERTY RECORD PREVIEW</h4>
            <div class="preview-grid" id="previewContent">
                <!-- Preview content will be injected here -->
            </div>
            <button onclick="hidePreview()" class="secondary" style="width: 100%; margin-top: 15px;">
                <i class="fa-solid fa-times"></i> Close Preview
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
            <button onclick="exportData()" class="success">
                <i class="fa-solid fa-file-excel"></i> Export Excel
            </button>
            <button onclick="exportGeoJSON()" class="info">
                <i class="fa-solid fa-globe"></i> Export GeoJSON
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div class="gps-accuracy-threshold" id="accuracyThreshold">
        <i class="fa-solid fa-bullseye"></i> GPS Accuracy: 3-20m required
    </div>

    <div class="auto-center-control">
        <button id="autoCenterToggle" onclick="toggleAutoCenter()" title="Auto-center on GPS">
            <i class="fa-solid fa-location-crosshairs"></i>
        </button>
    </div>

    <div class="map-controls">
        <button onclick="centerOnGPS()" title="Center on GPS" id="centerGPSBtn">
            <i class="fa-solid fa-location-arrow"></i>
        </button>
        <button onclick="clearAllMarkers()" class="warning" title="Clear all markers">
            <i class="fa-solid fa-trash"></i>
        </button>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal-overlay">
        <div class="modal">
            <h3><i class="fa-solid fa-download"></i> Data Backup</h3>
            <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5;">Backup your data to a file or to Firebase Cloud.</p>
            
            <div class="data-backup">
                <button onclick="backupData('json')" class="info">
                    <i class="fa-solid fa-code"></i> Backup as JSON
                </button>
                <button onclick="backupData('csv')" class="success">
                    <i class="fa-solid fa-file-csv"></i> Backup as CSV
                </button>
                <button onclick="backupToFirebase()" class="firebase" style="grid-column: span 2;">
                    <i class="fa-solid fa-cloud-upload-alt"></i> Backup to Firebase
                </button>
            </div>
            
            <div style="margin-top: 20px;">
                <h4 style="font-size: 1rem;"><i class="fa-solid fa-file-export"></i> Export Formats</h4>
                <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5;">
                    <p><strong>JSON</strong>: Full data including photos (base64 encoded)</p>
                    <p><strong>CSV</strong>: Tabular data only (photos excluded)</p>
                    <p><strong>Firebase</strong>: Cloud backup with real-time sync</p>
                </div>
            </div>
            
            <button onclick="hideModal()" class="secondary" style="width: 100%; margin-top: 20px;">
                <i class="fa-solid fa-times"></i> Close
            </button>
        </div>
    </div>

    <!-- Restore Modal -->
    <div id="restoreModal" class="modal-overlay">
        <div class="modal">
            <h3><i class="fa-solid fa-upload"></i> Data Restore</h3>
            <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5;">Restore data from a previously created backup file or from Firebase Cloud.</p>
            
            <div style="margin: 20px 0;">
                <input type="file" id="restoreFile" accept=".json,.csv" style="width: 100%; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
                <button onclick="restoreData()" class="success" style="width: 100%; margin-top: 15px;">
                    <i class="fa-solid fa-upload"></i> Restore from File
                </button>
            </div>
            
            <div style="margin: 20px 0;">
                <button onclick="restoreFromFirebase()" class="firebase" style="width: 100%;">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Restore from Firebase
                </button>
            </div>
            
            <div style="background: #fef9e7; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #fcf3cf;">
                <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #f39c12;">
                    <i class="fa-solid fa-triangle-exclamation"></i> Warning
                </h4>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                    Restoring data will replace all existing records. Make sure you have a current backup before proceeding.
                </p>
            </div>
            
            <button onclick="hideModal()" class="secondary" style="width: 100%; margin-top: 20px;">
                <i class="fa-solid fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
<script src="https://unpkg.com/leaflet.tilelayer.pouchdbcached@1.0.0/L.TileLayer.PouchDBCached.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script>
    /**
     * LAVMIS PROFESSIONAL OFFLINE DATABASE ENGINE (IndexedDB)
     * Handles Gigabytes of storage for photos/evidence.
     */
    class LocalDatabase {
        constructor() {
            this.dbName = 'LAVMIS_SECURE_DB';
            this.storeName = 'properties';
            this.logStoreName = 'activity_logs';
            this.syncQueueName = 'sync_queue';
            this.notificationsName = 'notifications';
            this.db = null;
        }

        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, 5); // Version 5 for new features

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create properties store if it doesn't exist
                    if (!db.objectStoreNames.contains(this.storeName)) {
                        const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                        store.createIndex('status', 'status', { unique: false });
                        store.createIndex('syncStatus', 'syncStatus', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                        store.createIndex('propertyId', 'propertyId', { unique: true });
                        store.createIndex('firebaseId', 'firebaseId', { unique: false });
                    }
                    
                    // Create logs store if it doesn't exist
                    if (!db.objectStoreNames.contains(this.logStoreName)) {
                        const logStore = db.createObjectStore(this.logStoreName, { keyPath: 'id', autoIncrement: true });
                        logStore.createIndex('timestamp', 'timestamp', { unique: false });
                        logStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    // Create sync queue store if it doesn't exist
                    if (!db.objectStoreNames.contains(this.syncQueueName)) {
                        const syncStore = db.createObjectStore(this.syncQueueName, { keyPath: 'id', autoIncrement: true });
                        syncStore.createIndex('status', 'status', { unique: false });
                        syncStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    // Create notifications store if it doesn't exist
                    if (!db.objectStoreNames.contains(this.notificationsName)) {
                        const notifStore = db.createObjectStore(this.notificationsName, { keyPath: 'id', autoIncrement: true });
                        notifStore.createIndex('read', 'read', { unique: false });
                        notifStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log(" LAVMIS Secure Database System Online");
                    resolve(this.db);
                };

                request.onerror = (event) => {
                    console.error("Database Error:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async saveRecord(record) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.storeName], 'readwrite');
                const store = tx.objectStore(this.storeName);
                const request = store.put(record);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async getAllRecords() {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.storeName], 'readonly');
                const store = tx.objectStore(this.storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        async getRecord(id) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.storeName], 'readonly');
                const store = tx.objectStore(this.storeName);
                const request = store.get(Number(id));
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async getRecordByPropertyId(propertyId) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.storeName], 'readonly');
                const store = tx.objectStore(this.storeName);
                const index = store.index('propertyId');
                const request = index.get(propertyId);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async deleteRecord(id) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.storeName], 'readwrite');
                const store = tx.objectStore(this.storeName);
                const request = store.delete(Number(id));
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async clearDatabase() {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.storeName, this.logStoreName, this.syncQueueName, this.notificationsName], 'readwrite');
                tx.objectStore(this.storeName).clear();
                tx.objectStore(this.logStoreName).clear();
                tx.objectStore(this.syncQueueName).clear();
                tx.objectStore(this.notificationsName).clear();
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async addLogEntry(message, type = 'info') {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.logStoreName], 'readwrite');
                const store = tx.objectStore(this.logStoreName);
                const entry = {
                    timestamp: new Date().toISOString(),
                    message: message,
                    type: type
                };
                const request = store.add(entry);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async getLogs(limit = 100) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.logStoreName], 'readonly');
                const store = tx.objectStore(this.logStoreName);
                const index = store.index('timestamp');
                const request = index.openCursor(null, 'prev');
                const logs = [];
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor && logs.length < limit) {
                        logs.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(logs);
                    }
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        async addToSyncQueue(recordId, action = 'sync', data = null) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.syncQueueName], 'readwrite');
                const store = tx.objectStore(this.syncQueueName);
                const entry = {
                    recordId: recordId,
                    action: action,
                    data: data,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    attempts: 0
                };
                const request = store.add(entry);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ========== FIXED: getSyncQueue method with robust error handling ==========
        async getSyncQueue(status = 'pending') {
            // Ensure status is a valid string
            if (!status || typeof status !== 'string') {
                console.warn(" Skipping IDB fetch: Status key is invalid or undefined");
                return [];
            }
            
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.syncQueueName], 'readonly');
                const store = tx.objectStore(this.syncQueueName);
                const index = store.index('status');
                
                // Create a safe key range
                let request;
                try {
                    const keyRange = IDBKeyRange.only(status);
                    request = index.getAll(keyRange);
                } catch (e) {
                    console.error("Error creating IDBKeyRange:", e);
                    // Fallback to getting all records and filtering manually
                    request = index.getAll();
                }
                
                request.onsuccess = () => {
                    const results = request.result || [];
                    // If we got all records (fallback), filter them
                    if (!request.keyRange && status) {
                        resolve(results.filter(item => item.status === status));
                    } else {
                        resolve(results);
                    }
                };
                
                request.onerror = (event) => {
                    console.error("Error in getSyncQueue:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        // ===========================================================================

        async updateSyncQueueItem(id, updates) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.syncQueueName], 'readwrite');
                const store = tx.objectStore(this.syncQueueName);
                const request = store.get(id);
                
                request.onsuccess = () => {
                    const item = request.result;
                    if (item) {
                        Object.assign(item, updates);
                        store.put(item).onsuccess = () => resolve();
                    } else {
                        reject(new Error('Item not found'));
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        async addNotification(title, message, type = 'info', data = null) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.notificationsName], 'readwrite');
                const store = tx.objectStore(this.notificationsName);
                const notification = {
                    title: title,
                    message: message,
                    type: type,
                    data: data,
                    read: false,
                    timestamp: new Date().toISOString()
                };
                const request = store.add(notification);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async getUnreadNotifications() {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.notificationsName], 'readonly');
                const store = tx.objectStore(this.notificationsName);
                const index = store.index('read');
                
                const keyRange = IDBKeyRange.only(false);
                const request = index.getAll(keyRange);
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        async markNotificationAsRead(id) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.notificationsName], 'readwrite');
                const store = tx.objectStore(this.notificationsName);
                const request = store.get(id);
                
                request.onsuccess = () => {
                    const notification = request.result;
                    if (notification) {
                        notification.read = true;
                        store.put(notification).onsuccess = () => resolve();
                    } else {
                        reject(new Error('Notification not found'));
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        async clearRejectionNotifications(propertyId) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction([this.notificationsName], 'readwrite');
                const store = tx.objectStore(this.notificationsName);
                const index = store.index('read');
                
                const keyRange = IDBKeyRange.only(false);
                const request = index.getAll(keyRange);
                
                request.onsuccess = async () => {
                    const notifications = request.result || [];
                    const promises = [];
                    
                    notifications.forEach(notification => {
                        if (notification.data && notification.data.propertyId === propertyId && 
                            (notification.type === 'rejection' || notification.title.includes('Rejected'))) {
                            notification.read = true;
                            promises.push(new Promise((res, rej) => {
                                const putRequest = store.put(notification);
                                putRequest.onsuccess = () => res();
                                putRequest.onerror = () => rej();
                            }));
                        }
                    });
                    
                    await Promise.all(promises);
                    resolve();
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        async getStorageEstimate() {
            if (navigator.storage && navigator.storage.estimate) {
                return await navigator.storage.estimate();
            }
            return null;
        }

        async autoPurge(daysToKeep = 3) {
            console.log(` Starting Auto-Purge (Records older than ${daysToKeep} days)...`);
            
            try {
                const storeName = this.storeName;
                const tx = this.db.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                const index = store.index('syncStatus');
                
                const keyRange = IDBKeyRange.only('synced');
                const request = index.getAll(keyRange);
                
                request.onsuccess = async () => {
                    const syncedRecords = request.result || [];
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
                    
                    let deletedCount = 0;
                    
                    for (const record of syncedRecords) {
                        if (new Date(record.date) < cutoffDate) {
                            await this.deleteRecord(record.id);
                            deletedCount++;
                        }
                    }
                    
                    if (deletedCount > 0) {
                        console.log(` Auto-Purged ${deletedCount} old synced records.`);
                        this.addLogEntry(`System auto-purged ${deletedCount} old records to free up space`, 'warning');
                        
                        if (typeof refreshDataDisplay === 'function') {
                            refreshDataDisplay();
                        }
                    } else {
                        console.log(" Auto-Purge complete: No records needed deletion.");
                    }
                };
                
                request.onerror = (e) => {
                    console.error("Auto-Purge failed:", e.target.error);
                };
            } catch (error) {
                console.error("Auto-Purge error:", error);
            }
        }
    }

    // ==========================================
    // GLOBAL VARIABLES & CONFIGURATION
    // ==========================================
    const db = new LocalDatabase();
    let map, savedLayer, liveLayer, manualLayer, accuracyLayer;
    let satelliteTileLayer;
    let locationMode = 'gps';
    let currentPos = null;
    let currentAccuracy = null;
    let manualPos = null;
    let evidencePhoto = null;
    let isAutoCentering = true;
    let propertyIdCounter = 1;
    let gpsWatchId = null;
    let manualMarker = null;
    let firebaseApp = null;
    let firebaseDb = null;
    let firebaseAuth = null;
    let firebaseStorage = null;
    let firebaseDatabase = null;
    let currentFirebaseUser = null;
    let loginSystem = null;
    let firebaseInitialized = false;
    let firebaseRealtimeListener = null;
    let isSyncing = false;
    let syncInterval = null;
    
    let isSystemReady = false;
    let isMapReady = false;
    let isUserAuthenticated = false;
    
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyA944hBt8QoOLeRKPoRrl2RemV9vlBc6ug",
        authDomain: "lavmis-1410e.firebaseapp.com",
        projectId: "lavmis-1410e",
        storageBucket: "lavmis-1410e.firebasestorage.app",
        messagingSenderId: "710897502113",
        appId: "1:710897502113:web:e5bfefc423af1b51632de0",
        measurementId: "G-ZWTN2R2RB2",
        databaseURL: "https://lavmis-1410e-default-rtdb.firebaseio.com"
    };

    // Geographical Data
    const geographicalData = [
         {
  "DISTRICT/CITY": "MUKONO",
  "SUBCOUNTY": "01 KOOME ISLANDS",
  "PARISH": "01 BUGOMBE",
  "VILLAGES": "01 BUGAZI"
 },
 {
  "DISTRICT/CITY": "MUKONO",
  "SUBCOUNTY": "09 NAMATABA TOWN COUNCIL",
  "PARISH": "44 NAMATABA B WARD",
  "VILLAGES": "07 NAKASEETA I"
 }
    ];
    
    const districts = [...new Set(geographicalData.map(item => item["DISTRICT/CITY"]))];
    
    // ==========================================
    // INITIALIZATION & MIGRATION
    // ==========================================
    window.onload = async function() {
        try {
            await db.init();
            await migrateLegacyData();

            loginSystem = new LoginSystem();
            
            await loadLogs();

            initializeGeographicalDropdowns();
            
            generatePropertyId();

            await checkNotifications();

            await db.autoPurge(3);

        } catch (error) {
            console.error("Initialization error:", error);
            alert("System initialization failed: " + error.message);
        }
    };

    async function migrateLegacyData() {
        const oldData = localStorage.getItem('lavmis_pro_db');
        if (oldData) {
            try {
                const records = JSON.parse(oldData);
                if (records.length > 0) {
                    console.log(`Migrating ${records.length} records to IndexedDB...`);
                    
                    for (const r of records) {
                        const newRecord = {
                            ...r,
                            id: Number(r.id) || Date.now(),
                            date: r.date || new Date().toISOString()
                        };
                        await db.saveRecord(newRecord);
                    }
                    
                    const oldLogs = localStorage.getItem('lavmis_logs');
                    if (oldLogs) {
                        const logs = JSON.parse(oldLogs);
                        for (const log of logs) {
                            await db.addLogEntry(log.message, log.type || 'info');
                        }
                    }
                    
                    console.log("Migration completed successfully");
                    localStorage.removeItem('lavmis_pro_db');
                    localStorage.removeItem('lavmis_logs');
                    localStorage.removeItem('lavmis_sync_queue');
                }
            } catch (e) {
                console.error("Migration error:", e);
            }
        }
    }

    // ==========================================
    // FIREBASE AUTHENTICATION & SYNC SYSTEM
    // ==========================================

    function initializeFirebase() {
        try {
            if (firebase.apps.length > 0) {
                firebaseApp = firebase.apps[0];
            } else {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            }
            
            firebaseDb = firebase.firestore();
            firebaseAuth = firebase.auth();
            firebaseStorage = firebase.storage();
            firebaseDatabase = firebase.database();
            
            firebaseDb.settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            
            firebaseDb.enablePersistence()
                .then(() => {
                    console.log('Firebase offline persistence enabled');
                    firebaseInitialized = true;
                    
                    initAutoSyncListeners();
                })
                .catch((err) => {
                    console.warn('Firebase persistence error (continuing online only):', err);
                    firebaseInitialized = true;
                    
                    initAutoSyncListeners();
                });
                
            console.log('Firebase initialized successfully');
            
            setupAuthStateListener();
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            addLogEntry('Firebase initialization failed: ' + error.message, 'error');
        }
    }

    function initAutoSyncListeners() {
        console.log(" Initializing Auto-Sync Listeners...");

        window.addEventListener('online', () => {
            addLogEntry('Device back online. Attempting sync...', 'success');
            updateFirebaseStatus('online', 'Connection restored');
            triggerAutoSync();
        });

        window.addEventListener('offline', () => {
            addLogEntry('Device offline. Sync paused.', 'warning');
            updateFirebaseStatus('offline', 'Working offline - changes will sync when online');
        });

        if (firebaseDatabase) {
            const connectedRef = firebaseDatabase.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    console.log(" Firebase Connection Established");
                    updateFirebaseStatus('online', 'Connected to Firebase');
                    triggerAutoSync();
                } else {
                    console.log(" Firebase Connection Lost");
                    updateFirebaseStatus('offline', 'Firebase connection lost');
                }
            });
        }
    }

    async function triggerAutoSync() {
        if (isSystemReady && isUserAuthenticated && !isSyncing) {
            addLogEntry('Auto-sync triggered by connection...', 'firebase');
            await processSyncQueue();
        }
    }

    /**
     * Enhanced Auth State Listener with Silent Restore
     */
    function setupAuthStateListener() {
        firebaseAuth.onAuthStateChanged(async (user) => {
            if (user) {
                currentFirebaseUser = user;
                isUserAuthenticated = true;
                console.log(' User authenticated:', user.email);
                
                // Show status panel
                document.getElementById('firebaseStatusPanel').style.display = 'block';
                document.getElementById('firebase-status-ind').style.display = 'inline-flex';
                
                updateFirebaseStatus('online', 'Logged in as ' + user.email);
                
                // AUTOMATIC RESTORE: Sync server IDs to prevent duplicates
                // We call this "silently" so it doesn't interrupt the user
                await silentRestoreFromFirebase();
                
                // Start sync processes
                setupFeedbackListener();
                
                if (isSystemReady) {
                    setupRealtimeListener();
                    await processSyncQueue();
                    await syncFromFirebase();
                    startPeriodicSync();
                } else {
                    console.log('System not ready yet, deferring Firebase operations...');
                }
                
            } else {
                currentFirebaseUser = null;
                isUserAuthenticated = false;
                console.log(' No user signed in (Offline mode)');
                
                document.getElementById('firebaseStatusPanel').style.display = 'none';
                document.getElementById('firebase-status-ind').style.display = 'none';
                
                updateFirebaseStatus('offline', 'Working offline');
                
                stopFeedbackListener();
                stopPeriodicSync();
                
                if (firebaseRealtimeListener) {
                    firebaseRealtimeListener();
                    firebaseRealtimeListener = null;
                }
            }
        });
    }

    /**
     * A "Safe" restore that only adds missing records and updates the ID counter
     */
    async function silentRestoreFromFirebase() {
        if (!currentFirebaseUser) return;
        
        try {
            const userId = currentFirebaseUser.uid;
            const snapshot = await firebaseDb.collection('properties')
                .where('userId', '==', userId)
                .get();

            if (snapshot.empty) return;

            let addedCount = 0;
            for (const doc of snapshot.docs) {
                const serverData = doc.data();
                const localRecord = await db.getRecordByPropertyId(serverData.propertyId);

                if (!localRecord) {
                    // Only add if it doesn't exist locally to avoid overwriting pending edits
                    const record = { 
                        id: Date.now() + Math.random(), 
                        ...serverData, 
                        firebaseId: doc.id, 
                        syncStatus: 'synced',
                        date: serverData.date || new Date().toISOString()
                    };
                    await db.saveRecord(record);
                    addedCount++;
                }
            }
            
            if (addedCount > 0) {
                console.log(` Auto-restored ${addedCount} records to sync ID counter.`);
                addLogEntry(`Silently restored ${addedCount} records from Firebase`, 'firebase');
                await refreshDataDisplay(); // This updates the local Property ID counter
            }
        } catch (error) {
            console.error('Silent restore failed:', error);
        }
    }

    function updateFirebaseStatus(status, message = '') {
        const statusElement = document.getElementById('firebaseConnectionStatus');
        const statusText = document.getElementById('firebaseStatusText');
        const statusDetail = document.getElementById('firebaseStatusDetail');
        
        if (status === 'online') {
            statusElement.className = 'firebase-status online';
            statusText.textContent = 'Firebase Connected';
            statusDetail.textContent = message || 'Real-time sync active';
        } else if (status === 'offline') {
            statusElement.className = 'firebase-status offline';
            statusText.textContent = 'Firebase Offline';
            statusDetail.textContent = message || 'Working offline - changes will sync when online';
        } else if (status === 'syncing') {
            statusElement.className = 'firebase-status';
            statusText.textContent = 'Syncing with Firebase...';
            statusDetail.textContent = message || 'Uploading changes to cloud';
        } else {
            statusElement.className = 'firebase-status';
            statusText.textContent = 'Firebase Status';
            statusDetail.textContent = message || 'Checking connection...';
        }
    }

    function showFirebaseSyncNotification(message, details = '') {
        const notification = document.getElementById('firebaseSyncNotification');
        const messageEl = document.getElementById('firebaseSyncMessage');
        const detailsEl = document.getElementById('firebaseSyncDetails');
        
        messageEl.textContent = message;
        detailsEl.textContent = details;
        notification.style.display = 'flex';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }

    // ========== FIXED: processSyncQueue with safe status check ==========
    async function processSyncQueue() {
        if (!isSystemReady || !isUserAuthenticated || isSyncing || !currentFirebaseUser) return;
        
        isSyncing = true;
        updateFirebaseStatus('syncing', 'Processing sync queue...');
        
        try {
            // Ensure 'pending' is a valid string
            const queueItems = await db.getSyncQueue('pending');
            let syncedCount = 0;
            let failedCount = 0;
            
            for (const item of queueItems) {
                try {
                    const success = await processSyncItem(item);
                    if (success) {
                        await db.updateSyncQueueItem(item.id, { 
                            status: 'completed',
                            syncedAt: new Date().toISOString()
                        });
                        syncedCount++;
                    } else {
                        throw new Error('Sync failed');
                    }
                } catch (error) {
                    console.error('Sync item failed:', error);
                    const attempts = (item.attempts || 0) + 1;
                    const newStatus = attempts >= 3 ? 'permanent_failure' : 'pending';
                    
                    await db.updateSyncQueueItem(item.id, { 
                        status: newStatus,
                        error: error.message,
                        attempts: attempts
                    });
                    
                    if (newStatus === 'permanent_failure') {
                        failedCount++;
                    }
                }
            }
            
            if (syncedCount > 0) {
                showFirebaseSyncNotification(`${syncedCount} items synced to Firebase`, 'Changes uploaded successfully');
                await refreshDataDisplay();
            }
            
            if (failedCount > 0) {
                addLogEntry(`${failedCount} sync items failed permanently`, 'error');
            }
            
        } catch (error) {
            console.error('Sync queue processing error:', error);
            addLogEntry('Sync queue processing failed: ' + error.message, 'error');
        } finally {
            isSyncing = false;
            updateFirebaseStatus('online', 'Sync complete');
        }
    }
    // ====================================================================

    async function processSyncItem(item) {
        if (!currentFirebaseUser) throw new Error('No user authenticated');

        const record = await db.getRecord(item.recordId);
        if (!record && item.action !== 'delete') {
            return false;
        }

        const userEmail = currentFirebaseUser.email;
        const userId = currentFirebaseUser.uid;

        try {
            switch(item.action) {
                case 'create':
                case 'update':
                case 'sync':
                    let firebaseData = { ...record };

                    // ===== CRITICAL FIX: Check for server-side duplicates =====
                    if (firebaseData.propertyId) {
                        const duplicateCheck = await firebaseDb.collection('properties')
                            .where('propertyId', '==', firebaseData.propertyId)
                            .limit(1)
                            .get();

                        if (!duplicateCheck.empty) {
                            console.warn(` Conflict: ${firebaseData.propertyId} already exists on server.`);
                            
                            // Find the highest ID on the server to generate a new one
                            const highestIdQuery = await firebaseDb.collection('properties')
                                .orderBy('propertyId', 'desc')
                                .limit(1)
                                .get();
                                
                            let newPropertyId;
                            if (!highestIdQuery.empty) {
                                const lastId = highestIdQuery.docs[0].data().propertyId;
                                const lastNum = parseInt(lastId.split('-')[1]) || 0;
                                newPropertyId = `PRO-${(lastNum + 1).toString().padStart(3, '0')}`;
                            } else {
                                newPropertyId = `PRO-${Math.floor(Math.random() * 999).toString().padStart(3, '0')}`;
                            }

                            console.log(` Re-assigning duplicate ID ${firebaseData.propertyId} to ${newPropertyId}`);
                            firebaseData.propertyId = newPropertyId;
                            
                            // Update the local record so the collector knows the ID has changed
                            record.propertyId = newPropertyId;
                            await db.saveRecord(record); 
                            addLogEntry(`Conflict resolved: ID updated to ${newPropertyId}`, "warning");
                        }
                    }

                    if (firebaseData.photo && firebaseData.photo.startsWith('data:image')) {
                        try {
                            const storageRef = firebaseStorage.ref();
                            const filename = `evidence/${userId}/${firebaseData.propertyId}_${Date.now()}.jpg`;
                            const imageRef = storageRef.child(filename);

                            const response = await fetch(firebaseData.photo);
                            const blob = await response.blob();

                            const metadata = { customMetadata: { propertyId: firebaseData.propertyId, uploader: userEmail } };
                            const snapshot = await imageRef.put(blob, metadata);
                            const downloadURL = await snapshot.ref.getDownloadURL();

                            firebaseData.photo = downloadURL;
                            firebaseData.photoPath = filename;

                        } catch (uploadError) {
                            console.error("Image upload failed:", uploadError);
                            throw new Error("Image upload failed: " + uploadError.message);
                        }
                    }

                    firebaseData.userId = userId;
                    firebaseData.userEmail = userEmail;
                    
                    if (!firebaseData.officerEmail) {
                        firebaseData.officerEmail = userEmail;
                    }
                    
                    firebaseData.lastUpdated = new Date().toISOString();
                    firebaseData.syncStatus = 'synced';
                    
                    delete firebaseData.id;

                    if (record.firebaseId) {
                        await firebaseDb.collection('properties')
                            .doc(record.firebaseId)
                            .set(firebaseData, { merge: true });
                    } else {
                        const docRef = await firebaseDb.collection('properties').add(firebaseData);
                        
                        record.firebaseId = docRef.id;
                        record.syncStatus = 'synced';
                        await db.saveRecord(record);
                    }
                    break;

                case 'delete':
                    if (record && record.firebaseId) {
                        await firebaseDb.collection('properties').doc(record.firebaseId).delete();
                    }
                    break;
            }
            return true;
        } catch (error) {
            console.error('Process sync item error:', error);
            throw error;
        }
    }

    function setupRealtimeListener() {
        if (!isSystemReady || !currentFirebaseUser || firebaseRealtimeListener) return;
        
        const userId = currentFirebaseUser.uid;
        
        firebaseRealtimeListener = firebaseDb.collection('properties')
            .where('userId', '==', userId)
            .onSnapshot(async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        await handleRemoteUpdate(change.doc);
                    } else if (change.type === 'removed') {
                        await handleRemoteDelete(change.doc.id);
                    }
                });
                
                updateSyncStats();
            }, (error) => {
                console.error('Realtime listener error:', error);
                addLogEntry('Realtime sync error: ' + error.message, 'error');
            });
    }

    async function handleRemoteUpdate(doc) {
        if (!isSystemReady) {
            console.log('System not ready, skipping remote update...');
            return;
        }
        
        const remoteData = doc.data();
        const localRecord = await db.getRecordByPropertyId(remoteData.propertyId);
        
        if (remoteData.status === 'rejected' && remoteData.rejectionReason) {
            await handleRejectionNotification(remoteData);
            return;
        }
        
        if (remoteData.status === 'approved') {
            await handleApprovalNotification(remoteData);
            return;
        }
        
        if (localRecord) {
            const updatedRecord = {
                ...localRecord,
                ...remoteData,
                firebaseId: doc.id,
                syncStatus: 'synced',
                lastSynced: new Date().toISOString()
            };
            
            await db.saveRecord(updatedRecord);
            addLogEntry(`Record ${remoteData.propertyId} updated from Firebase`, 'firebase');
        } else {
            const newRecord = {
                id: Date.now(),
                ...remoteData,
                firebaseId: doc.id,
                syncStatus: 'synced',
                date: remoteData.date || new Date().toISOString()
            };
            
            await db.saveRecord(newRecord);
            addLogEntry(`Record ${remoteData.propertyId} added from Firebase`, 'firebase');
        }
        
        await refreshDataDisplay();
    }

    async function handleRemoteDelete(firebaseId) {
        if (!isSystemReady) return;
        
        const records = await db.getAllRecords();
        const recordToDelete = records.find(r => r.firebaseId === firebaseId);
        
        if (recordToDelete) {
            await db.deleteRecord(recordToDelete.id);
            addLogEntry(`Record ${recordToDelete.propertyId} deleted via Firebase`, 'firebase');
            await refreshDataDisplay();
        }
    }

    async function handleRejectionNotification(remoteData) {
        if (!isSystemReady) return;
        
        await db.addNotification(
            'Submission Rejected',
            `Property ${remoteData.propertyId} was rejected by administrator`,
            'rejection',
            remoteData
        );
        
        const localRecord = await db.getRecordByPropertyId(remoteData.propertyId);
        if (localRecord) {
            localRecord.status = 'rejected';
            localRecord.rejectionReason = remoteData.rejectionReason || 'No specific reason provided';
            localRecord.rejectionFeedback = remoteData.rejectionFeedback || 'Please check the details and resubmit';
            localRecord.syncStatus = 'synced';
            await db.saveRecord(localRecord);
        }
        
        showRejectionNotification(remoteData);
        await refreshDataDisplay();
        await checkNotifications();
    }

    async function handleApprovalNotification(remoteData) {
        if (!isSystemReady) return;
        
        await db.addNotification(
            'Submission Approved',
            `Property ${remoteData.propertyId} was approved by administrator`,
            'approval',
            remoteData
        );
        
        const localRecord = await db.getRecordByPropertyId(remoteData.propertyId);
        if (localRecord) {
            localRecord.status = 'approved';
            localRecord.syncStatus = 'synced';
            await db.saveRecord(localRecord);
        }
        
        await refreshDataDisplay();
        await checkNotifications();
    }

    function showRejectionNotification(remoteData) {
        const notification = document.getElementById('rejectionNotification');
        const title = document.getElementById('rejectionNotificationTitle');
        const details = document.getElementById('rejectionNotificationDetails');
        
        title.textContent = 'Submission Rejected';
        details.textContent = `Property ${remoteData.propertyId} - Click to view details`;
        notification.style.display = 'flex';
        
        notification.onclick = () => {
            showRejectionFeedback(remoteData);
            notification.style.display = 'none';
        };
    }

    function showRejectionFeedback(remoteData) {
        const modal = document.getElementById('rejectionFeedback');
        const propertyId = document.getElementById('rejectionPropertyId');
        const reasonText = document.getElementById('rejectionReasonText');
        
        propertyId.textContent = remoteData.propertyId;
        reasonText.textContent = remoteData.rejectionReason || remoteData.rejectionFeedback || 'No specific reason provided';
        
        modal.style.display = 'block';
    }

    async function updateSyncStats() {
        if (!currentFirebaseUser) return;
        
        try {
            const records = await db.getAllRecords();
            const syncedCount = records.filter(r => r.syncStatus === 'synced').length;
            const pendingCount = records.filter(r => r.syncStatus === 'pending').length;
            
            document.getElementById('syncedRecords').textContent = syncedCount;
            document.getElementById('pendingSync').textContent = pendingCount;
            
            const syncStatusText = document.getElementById('syncStatusText');
            if (syncStatusText) {
                syncStatusText.textContent = `${syncedCount} synced, ${pendingCount} pending`;
            }
            
        } catch (error) {
            console.error('Update sync stats error:', error);
        }
    }

    function startPeriodicSync() {
        if (!isSystemReady) return;
        
        if (syncInterval) {
            clearInterval(syncInterval);
        }
        
        syncInterval = setInterval(async () => {
            if (navigator.onLine && currentFirebaseUser && !isSyncing && isSystemReady) {
                await processSyncQueue();
            }
        }, 120000);
    }

    function stopPeriodicSync() {
        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
        }
    }

    async function syncAllToFirebase() {
        if (!currentFirebaseUser) {
            alert('Please log in to sync with Firebase');
            return;
        }
        
        const records = await db.getAllRecords();
        const pendingRecords = records.filter(r => r.syncStatus !== 'synced');
        
        if (pendingRecords.length === 0) {
            alert('All records are already synced with Firebase');
            return;
        }
        
        showFirebaseSyncNotification(`Syncing ${pendingRecords.length} records...`, 'Please wait');
        
        for (const record of pendingRecords) {
            await db.addToSyncQueue(record.id, 'sync', record);
        }
        
        await processSyncQueue();
    }

    async function syncFromFirebase() {
        if (!currentFirebaseUser) return;
        
        try {
            const userId = currentFirebaseUser.uid;
            const snapshot = await firebaseDb.collection('properties')
                .where('userId', '==', userId)
                .get();
            
            let newCount = 0;
            let updateCount = 0;
            
            for (const doc of snapshot.docs) {
                const remoteData = doc.data();
                const localRecord = await db.getRecordByPropertyId(remoteData.propertyId);
                
                if (!localRecord) {
                    const newRecord = {
                        id: Date.now() + newCount,
                        ...remoteData,
                        firebaseId: doc.id,
                        syncStatus: 'synced',
                        date: remoteData.date || new Date().toISOString()
                    };
                    await db.saveRecord(newRecord);
                    newCount++;
                } else if (new Date(remoteData.lastUpdated || 0) > new Date(localRecord.lastUpdated || 0)) {
                    const updatedRecord = {
                        ...localRecord,
                        ...remoteData,
                        firebaseId: doc.id,
                        syncStatus: 'synced',
                        lastSynced: new Date().toISOString()
                    };
                    await db.saveRecord(updatedRecord);
                    updateCount++;
                }
            }
            
            if (newCount > 0 || updateCount > 0) {
                addLogEntry(`Synced from Firebase: ${newCount} new, ${updateCount} updated`, 'firebase');
                await refreshDataDisplay();
            }
            
        } catch (error) {
            console.error('Sync from Firebase error:', error);
            addLogEntry('Firebase sync failed: ' + error.message, 'error');
        }
    }

    async function restoreFromFirebase() {
        if (!currentFirebaseUser) {
            alert('Please log in to restore from Firebase');
            return;
        }
        
        if (!confirm('This will replace all local data with data from Firebase. Continue?')) {
            return;
        }
        
        try {
            showFirebaseSyncNotification('Restoring from Firebase...', 'Downloading data');
            
            const userId = currentFirebaseUser.uid;
            const snapshot = await firebaseDb.collection('properties')
                .where('userId', '==', userId)
                .get();
            
            await db.clearDatabase();
            
            let restoredCount = 0;
            snapshot.forEach((doc) => {
                const data = doc.data();
                const record = {
                    id: Date.now() + restoredCount,
                    ...data,
                    firebaseId: doc.id,
                    syncStatus: 'synced'
                };
                
                db.saveRecord(record);
                restoredCount++;
            });
            
            await refreshDataDisplay();
            await loadLogs();
            
            showFirebaseSyncNotification(`${restoredCount} records restored`, 'Data downloaded successfully');
            addLogEntry(`Restored ${restoredCount} records from Firebase`, 'firebase');
            
        } catch (error) {
            console.error('Restore from Firebase error:', error);
            alert('Failed to restore from Firebase: ' + error.message);
            addLogEntry('Firebase restore failed: ' + error.message, 'error');
        }
    }

    async function backupToFirebase() {
        if (!currentFirebaseUser) {
            alert('Please log in to backup to Firebase');
            return;
        }
        
        try {
            const records = await db.getAllRecords();
            const logs = await db.getLogs(1000);
            
            const backupData = {
                version: '2.0',
                timestamp: new Date().toISOString(),
                app: 'LAVMIS Pro',
                data: records,
                logs: logs,
                metadata: {
                    totalRecords: records.length,
                    totalLogs: logs.length,
                    backupType: 'manual',
                    userId: currentFirebaseUser.uid,
                    userEmail: currentFirebaseUser.email
                }
            };
            
            const storageRef = firebaseStorage.ref();
            const backupRef = storageRef.child(`backups/lavmis_backup_${new Date().toISOString()}.json`);
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            await backupRef.put(blob);
            
            await firebaseDb.collection('backups').add({
                userId: currentFirebaseUser.uid,
                userEmail: currentFirebaseUser.email,
                filename: `lavmis_backup_${new Date().toISOString()}.json`,
                timestamp: new Date().toISOString(),
                recordCount: records.length,
                size: blob.size
            });
            
            showFirebaseSyncNotification('Backup created in Firebase', 'Data secured in cloud storage');
            addLogEntry(`Backup created in Firebase: ${records.length} records`, 'firebase');
            
        } catch (error) {
            console.error('Backup to Firebase error:', error);
            alert('Failed to backup to Firebase: ' + error.message);
            addLogEntry('Firebase backup failed: ' + error.message, 'error');
        }
    }

    async function checkNotifications() {
        try {
            const notifications = await db.getUnreadNotifications();
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationCount = document.getElementById('notificationCount');
            const notificationButton = document.getElementById('notificationButton');
            
            if (notifications.length > 0) {
                notificationBadge.style.display = 'inline-flex';
                notificationCount.textContent = notifications.length;
                notificationButton.classList.add('has-notifications');
            } else {
                notificationBadge.style.display = 'none';
                notificationButton.classList.remove('has-notifications');
            }
        } catch (error) {
            console.error('Error checking notifications:', error);
        }
    }

    function showAllNotifications() {
        alert('Notification center - Premium feature. Notifications are stored locally and will appear here.');
    }

    async function loadLogs() {
        const logs = await db.getLogs(50);
        const logContainer = document.getElementById('logContent');
        if (logContainer) {
            logContainer.innerHTML = '';
            logs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = `log-entry ${log.type}`;
                logElement.innerHTML = `
                    <div class="log-time">${formatTime(log.timestamp)}</div>
                    <div class="log-message">${log.message}</div>
                `;
                logContainer.appendChild(logElement);
            });
        }
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + 
               ' ' + date.toLocaleDateString([], {month: 'short', day: 'numeric'});
    }

    function addLogEntry(message, type = 'info') {
        db.addLogEntry(message, type);
        
        const logContainer = document.getElementById('logContent');
        if (logContainer) {
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            logElement.innerHTML = `
                <div class="log-time">${formatTime(new Date().toISOString())}</div>
                <div class="log-message">${message}</div>
            `;
            logContainer.insertBefore(logElement, logContainer.firstChild);
            
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
    }

    function clearLog() {
        if (confirm("Clear all log entries?")) {
            const logContainer = document.getElementById('logContent');
            if (logContainer) {
                logContainer.innerHTML = '';
            }
            addLogEntry("Log cleared", "info");
        }
    }

    // ==========================================
    // NOTIFICATION LISTENER FOR ADMIN FEEDBACK
    // ==========================================
    let notificationListener = null;

    function setupFeedbackListener() {
        if (!currentFirebaseUser || notificationListener) return;

        const userEmail = currentFirebaseUser.email;

        notificationListener = firebaseDb.collection('notifications')
            .where('recipientEmail', '==', userEmail)
            .where('read', '==', false)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const note = change.doc.data();
                        showAdminFeedbackAlert(note.status, note.message, change.doc.id);
                        
                        db.addNotification(
                            `Admin ${note.status.toUpperCase()}`,
                            note.message,
                            note.status === 'rejected' ? 'rejection' : note.status === 'approved' ? 'approval' : 'info',
                            note
                        );
                        
                        checkNotifications();
                    }
                });
            }, error => {
                console.error('Notification listener error:', error);
            });
            
        console.log(' Admin feedback listener started for:', userEmail);
    }

    function stopFeedbackListener() {
        if (notificationListener) {
            notificationListener();
            notificationListener = null;
            console.log(' Admin feedback listener stopped');
        }
    }

    function showAdminFeedbackAlert(status, message, noteId) {
        const feedbackEl = document.getElementById('adminFeedbackAlert');
        const feedbackContent = document.getElementById('feedbackContent');
        
        if (!feedbackEl) {
            alert(`ADMIN FEEDBACK (${status}): ${message}`);
            return;
        }
        
        feedbackEl.className = '';
        if (status === 'rejected') {
            feedbackEl.style.borderLeftColor = '#e74c3c';
        } else if (status === 'approved') {
            feedbackEl.style.borderLeftColor = '#27ae60';
            feedbackEl.classList.add('approval');
        } else {
            feedbackEl.style.borderLeftColor = '#f39c12';
        }
        
        feedbackContent.className = `feedback-content ${status}`;
        feedbackContent.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="flex-shrink: 0; font-size: 1.2rem;">
                    ${status === 'rejected' ? '<i class="fa-solid fa-exclamation-triangle" style="color: #e74c3c;"></i>' : 
                      status === 'approved' ? '<i class="fa-solid fa-check-circle" style="color: #27ae60;"></i>' : 
                      '<i class="fa-solid fa-info-circle" style="color: #f39c12;"></i>'}
                </div>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 600; margin-bottom: 5px; font-size: 1rem;">
                        Admin ${status.toUpperCase()}
                    </div>
                    <div style="font-size: 0.9rem; color: #2c3e50; line-height: 1.4;">
                        ${message}
                    </div>
                    <button onclick="markNotificationRead('${noteId}')" style="margin-top: 12px; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                        <i class="fa-solid fa-check"></i> Acknowledge
                    </button>
                </div>
            </div>
        `;
        
        feedbackEl.style.display = 'block';
        
        setTimeout(() => {
            if (feedbackEl.style.display === 'block') {
                markNotificationRead(noteId);
            }
        }, 30000);
    }

    async function markNotificationRead(noteId) {
        try {
            await firebaseDb.collection('notifications').doc(noteId).update({ read: true });
            
            document.getElementById('adminFeedbackAlert').style.display = 'none';
            
            await checkNotifications();
            
            addLogEntry(`Admin feedback acknowledged: ${noteId}`, 'info');
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    // ==========================================
    // LOGIN SYSTEM - FIXED AUTHENTICATION BUG
    // ==========================================
    class LoginSystem {
        constructor() {
            this.maxAttempts = 5;
            this.remainingAttempts = this.maxAttempts;
            this.lockoutTime = 5 * 60 * 1000;
            this.isLocked = false;
            this.lockoutTimer = null;
            
            this.setupLoginEvents();
            this.initializeFirebaseAndCheckSession();
        }
        
        initializeFirebaseAndCheckSession() {
            initializeFirebase();
            
            setTimeout(() => {
                if (firebaseAuth) {
                    const user = firebaseAuth.currentUser;
                    if (user) {
                        this.loginSuccess(user.email, true);
                    }
                }
            }, 1000);
        }
        
        setupLoginEvents() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    passwordInput.focus();
                }
            });
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.attemptFirebaseLogin();
                }
            });
            
            document.getElementById('loginButton').addEventListener('click', () => {
                this.attemptFirebaseLogin();
            });
            
            setTimeout(() => usernameInput.focus(), 100);
        }
        
        attemptFirebaseLogin() {
            if (this.isLocked) {
                return;
            }
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            
            errorElement.textContent = '';
            
            if (!username || !password) {
                errorElement.textContent = 'Please enter both email and password';
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(username)) {
                errorElement.textContent = 'Please enter a valid email address';
                return;
            }
            
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> AUTHENTICATING...';
            
            firebaseAuth.signInWithEmailAndPassword(username, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    this.loginSuccess(user.email, false);
                })
                .catch((error) => {
                    this.handleFirebaseError(error);
                    
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> LOGIN TO LAVMIS';
                });
        }
        
        handleFirebaseError(error) {
            this.remainingAttempts--;
            
            const errorElement = document.getElementById('loginError');
            let errorMessage = '';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email format';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'This account has been disabled';
                    break;
                case 'auth/user-not-found':
                    errorMessage = 'No account found with this email';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'Incorrect password';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Too many failed attempts. Try again later';
                    this.lockout(this.lockoutTime);
                    return;
                default:
                    errorMessage = `Authentication failed: ${error.message}`;
            }
            
            if (this.remainingAttempts <= 0) {
                this.lockout(this.lockoutTime);
                
                errorElement.textContent = 'Too many failed attempts. System locked for 5 minutes.';
                errorElement.style.color = '#e74c3c';
                
                document.querySelector('.login-container').classList.add('locked-out');
                setTimeout(() => {
                    document.querySelector('.login-container').classList.remove('locked-out');
                }, 500);
            } else {
                errorElement.textContent = `${errorMessage}. ${this.remainingAttempts} attempt(s) remaining.`;
                errorElement.style.color = '#f39c12';
                
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
            
            this.updateAttemptsDisplay();
        }
        
        lockout(timeRemaining) {
            this.isLocked = true;
            
            const loginButton = document.getElementById('loginButton');
            const errorElement = document.getElementById('loginError');
            
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fa-solid fa-lock"></i> SYSTEM LOCKED';
            
            this.lockoutTimer = setInterval(() => {
                timeRemaining -= 1000;
                
                if (timeRemaining <= 0) {
                    clearInterval(this.lockoutTimer);
                    this.isLocked = false;
                    
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> LOGIN TO LAVMIS';
                    
                    errorElement.textContent = '';
                    this.remainingAttempts = this.maxAttempts;
                    this.updateAttemptsDisplay();
                }
            }, 1000);
        }
        
        updateAttemptsDisplay() {
            const attemptsElement = document.getElementById('loginAttempts');
            
            if (this.isLocked) {
                attemptsElement.style.display = 'none';
            } else {
                attemptsElement.style.display = 'block';
                attemptsElement.textContent = `Attempts remaining: ${this.remainingAttempts}`;
                
                if (this.remainingAttempts <= 2) {
                    attemptsElement.style.color = '#e74c3c';
                    attemptsElement.style.fontWeight = 'bold';
                } else if (this.remainingAttempts <= 3) {
                    attemptsElement.style.color = '#f39c12';
                } else {
                    attemptsElement.style.color = '#f39c12';
                }
            }
        }
        
        // =============== FIXED: showMainApp now properly sets auth flags ===============
        loginSuccess(email, fromSession = false) {
            this.remainingAttempts = this.maxAttempts;
            
            this.showMainApp(email);
            
            if (!fromSession) {
                addLogEntry(`User "${email}" logged in successfully`, "success");
            }
        }
        
        showMainApp(email) {
            document.getElementById('loginModal').style.display = 'none';
            
            document.getElementById('mainContent').style.display = 'flex';
            
            document.getElementById('loggedInUser').textContent = email;
            
            // CRITICAL FIX: Explicitly set global auth flags and update UI
            isUserAuthenticated = true;
            
            // Also update the status indicator in the UI
            const netLabel = document.getElementById('net-label');
            if (netLabel) {
                netLabel.textContent = 'ONLINE';
                netLabel.className = 'indicator on';
            }
            
            // Update Firebase status panel if user exists
            if (currentFirebaseUser) {
                document.getElementById('firebaseStatusPanel').style.display = 'block';
                document.getElementById('firebase-status-ind').style.display = 'inline-flex';
                updateFirebaseStatus('online', 'Logged in as ' + email);
            }
            
            initializeApp();
        }
        // ============================================================================
        
        initiateLogout() {
            if (confirm("Are you sure you want to logout?")) {
                this.finishLogout();
            }
        }
        
        finishLogout() {
            if (firebaseAuth) {
                firebaseAuth.signOut();
            }
            
            stopFeedbackListener();
            
            const email = document.getElementById('loggedInUser').textContent;
            addLogEntry(`User "${email}" logged out`, "info");
            
            resetAppState();
            
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
        }
    }

    function attemptLogin() {
        if (loginSystem) {
            loginSystem.attemptFirebaseLogin();
        }
    }

    function initiateLogout() {
        if (loginSystem) {
            loginSystem.initiateLogout();
        }
    }

    // ==========================================
    // APPLICATION INITIALIZATION
    // ==========================================
    function initializeApp() {
        initMap();
        
        startGPS();
        
        refreshDataDisplay();
        
        updateStorageUsage();
        
        setLocationMode('gps');
        
        setupMapHandlers();
        
        updateSyncStats();
        
        isSystemReady = true;
        console.log(" System fully initialized and ready");
        
        if (isUserAuthenticated && currentFirebaseUser) {
            console.log("Starting deferred Firebase operations...");
            setTimeout(async () => {
                setupRealtimeListener();
                await processSyncQueue();
                await syncFromFirebase();
                startPeriodicSync();
            }, 1000);
        }
        
        addLogEntry("LAVMIS Pro application started", "success");
    }

    function initMap() {
        map = L.map('map', { 
            zoomControl: false,
            zoomSnap: 0.1,
            zoomDelta: 0.5
        }).setView([0.3476, 32.5825], 13);
        
        satelliteTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles  Esri',
            maxZoom: 19,
            useCache: true,
            crossOrigin: true,
            cacheMaxAge: 30 * 24 * 3600 * 1000
        }).addTo(map);

        savedLayer = L.featureGroup().addTo(map);
        liveLayer = L.layerGroup().addTo(map);
        manualLayer = L.layerGroup().addTo(map);
        accuracyLayer = L.layerGroup().addTo(map);
        
        L.control.zoom({ position: 'topright' }).addTo(map);
        
        satelliteTileLayer.on('seedprogress', function(seedData) {
            const percent = Math.floor((seedData.progress / seedData.total) * 100);
            const statusDiv = document.getElementById('cache-status');
            if(statusDiv) statusDiv.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Downloading Map: ${percent}%`;
        });

        satelliteTileLayer.on('seedend', function(seedData) {
            const statusDiv = document.getElementById('cache-status');
            if(statusDiv) statusDiv.innerHTML = `<i class="fa-solid fa-check"></i> Map Area Cached Successfully!`;
            alert("Map area downloaded for offline use.");
        });

        isMapReady = true;
        console.log(" Map initialized with Caching");
    }

    function setupMapHandlers() {
        map.on('click', function(e) {
            if (locationMode === 'manual') {
                manualPos = [e.latlng.lat, e.latlng.lng];
                
                manualLayer.clearLayers();
                
                manualMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'manual-marker',
                        html: `<div style="
                            width: 32px;
                            height: 32px;
                            background: rgba(142, 68, 173, 0.8);
                            border: 3px solid white;
                            border-radius: 50%;
                            box-shadow: 0 0 10px rgba(142, 68, 173, 0.8);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                        "><i class="fa-solid fa-map-pin"></i></div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    }),
                    zIndexOffset: 1000
                }).addTo(manualLayer);
                
                updateCoordinatesDisplay(manualPos[0], manualPos[1], 'Selected Point');
                
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('clearPointBtn').disabled = false;
                
                map.setView(e.latlng, Math.max(map.getZoom(), 16));
                
                addLogEntry("Point selected on map: " + manualPos.map(c => c.toFixed(6)).join(", "), "info");
            }
        });
    }

    function resetAppState() {
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
            gpsWatchId = null;
        }
        
        currentPos = null;
        currentAccuracy = null;
        manualPos = null;
        evidencePhoto = null;
        manualMarker = null;
        isAutoCentering = true;
        
        if (map) {
            map.remove();
            map = null;
        }
        
        savedLayer = null;
        liveLayer = null;
        manualLayer = null;
        accuracyLayer = null;
        satelliteTileLayer = null;
        
        currentFirebaseUser = null;
        firebaseRealtimeListener = null;
        stopFeedbackListener();
        stopPeriodicSync();
        
        isSystemReady = false;
        isMapReady = false;
        isUserAuthenticated = false;
    }

    // ==========================================
    // GPS FUNCTIONS
    // ==========================================
    function startGPS() {
        if (!navigator.geolocation) {
            updateGpsStatus(null);
            addLogEntry("GPS hardware not available", "error");
            alert("GPS is not available on this device.");
            return;
        }
        
        const options = {
            enableHighAccuracy: true,
            maximumAge: 2000,
            timeout: 10000
        };
        
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
        }
        
        gpsWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                currentPos = [lat, lng];
                currentAccuracy = accuracy;
                
                updateGpsStatus(accuracy, currentPos);
                
                if (locationMode === 'gps') {
                    liveLayer.clearLayers();
                    
                    L.circleMarker(currentPos, {
                        radius: 8,
                        color: '#fff',
                        fillColor: '#3498db',
                        fillOpacity: 0.9,
                        weight: 2
                    }).addTo(liveLayer);
                    
                    updateCoordinatesDisplay(currentPos[0], currentPos[1], 'GPS Location', accuracy);
                    
                    if (isAutoCentering) {
                        map.setView(currentPos, Math.max(map.getZoom(), 16));
                    }
                }
            },
            (error) => {
                console.error('GPS Error:', error);
                
                let errorMsg = 'GPS Error: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'GPS permission denied. Please enable location services.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'GPS position unavailable. Check device GPS.';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'GPS timeout. Retrying...';
                        setTimeout(startGPS, 1000);
                        break;
                    default:
                        errorMsg = `GPS Error: ${error.message}`;
                }
                
                addLogEntry(errorMsg, "error");
                updateGpsStatus(null);
                updateCoordinatesDisplay(null, null, errorMsg);
            },
            options
        );
    }
    
    function updateGpsStatus(accuracy, position = null) {
        const accuracyText = document.getElementById('gpsAccuracy');
        const accuracyFill = document.getElementById('gpsAccuracyFill');
        const gpsIcon = document.getElementById('gpsIcon');
        const statusText = document.getElementById('gpsStatusText');
        const statusDetail = document.getElementById('gpsStatusDetail');
        const saveBtn = document.getElementById('saveBtn');
        
        if (accuracy === null) {
            accuracyText.textContent = '-- m';
            accuracyFill.style.width = '0%';
            accuracyFill.style.background = '#e74c3c';
            gpsIcon.className = 'fa-solid fa-satellite-slash';
            statusText.textContent = 'GPS Not Available';
            statusDetail.textContent = 'Waiting for GPS signal...';
            saveBtn.disabled = true;
            return;
        }
        
        accuracyText.textContent = `${accuracy.toFixed(1)} m`;
        
        let accuracyPercent;
        if (accuracy <= 3) {
            accuracyPercent = 100;
        } else if (accuracy >= 50) {
            accuracyPercent = 0;
        } else {
            accuracyPercent = Math.max(0, 100 - ((accuracy - 3) / 47 * 100));
        }
        
        accuracyFill.style.width = `${accuracyPercent}%`;
        
        if (accuracy >= 3 && accuracy <= 20) {
            accuracyFill.style.background = '#27ae60';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'GPS Ready';
            statusDetail.textContent = 'Good accuracy for data collection';
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
        } else if (accuracy < 3) {
            accuracyFill.style.background = '#f39c12';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'High Accuracy';
            statusDetail.textContent = 'Accuracy too high (possible mock location)';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Accuracy Too High';
        } else if (accuracy <= 30) {
            accuracyFill.style.background = '#f39c12';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'Moderate Accuracy';
            statusDetail.textContent = 'Move for better GPS signal';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> WAIT FOR BETTER GPS';
        } else {
            accuracyFill.style.background = '#e74c3c';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'Poor Accuracy';
            statusDetail.textContent = 'Move to open area for better GPS';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> NEED BETTER GPS';
        }
        
        if (position) {
            updateAccuracyCircle(position, accuracy);
        }
    }
    
    function updateAccuracyCircle(position, accuracy) {
        accuracyLayer.clearLayers();
        
        if (accuracy && accuracy <= 100) {
            const circle = L.circle(position, {
                radius: accuracy,
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.1,
                weight: 1,
                dashArray: '5, 5'
            }).addTo(accuracyLayer);
        }
    }
    
    function centerOnGPS() {
        if (currentPos) {
            map.setView(currentPos, Math.max(map.getZoom(), 16));
            addLogEntry("Map centered on current GPS position", "info");
        } else {
            alert("No GPS position available. Waiting for GPS signal...");
        }
    }
    
    function toggleAutoCenter() {
        isAutoCentering = !isAutoCentering;
        const toggleBtn = document.getElementById('autoCenterToggle');
        
        if (isAutoCentering) {
            toggleBtn.classList.add('active');
            toggleBtn.title = 'Auto-center ON - Click to disable';
            addLogEntry("Auto-center enabled", "info");
            
            if (currentPos) {
                map.setView(currentPos, Math.max(map.getZoom(), 16));
            }
        } else {
            toggleBtn.classList.remove('active');
            toggleBtn.title = 'Auto-center OFF - Click to enable';
            addLogEntry("Auto-center disabled", "info");
        }
    }

    // ==========================================
    // LOCATION MODE FUNCTIONS
    // ==========================================
    function setLocationMode(mode) {
        locationMode = mode;
        
        document.getElementById('gpsToggle').classList.toggle('active', mode === 'gps');
        document.getElementById('manualToggle').classList.toggle('active', mode === 'manual');
        
        const saveBtn = document.getElementById('saveBtn');
        if (mode === 'manual') {
            saveBtn.disabled = !manualPos;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
            addLogEntry("Switched to manual point selection mode", "info");
        } else {
            saveBtn.disabled = !(currentAccuracy && currentAccuracy >= 3 && currentAccuracy <= 20);
            if (!saveBtn.disabled) {
                saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
            }
            addLogEntry("Switched to GPS auto mode", "info");
        }
        
        if (mode === 'manual') {
            accuracyLayer.clearLayers();
        }
        
        if (mode === 'gps' && currentPos) {
            updateCoordinatesDisplay(currentPos[0], currentPos[1], 'GPS Location', currentAccuracy);
        } else if (mode === 'manual' && manualPos) {
            updateCoordinatesDisplay(manualPos[0], manualPos[1], 'Selected Point');
        } else if (mode === 'manual') {
            updateCoordinatesDisplay(null, null, 'Click on map to select a point');
        }
        
        document.getElementById('map').style.cursor = mode === 'manual' ? 'crosshair' : 'default';
    }
    
    function clearManualPoint() {
        manualPos = null;
        manualMarker = null;
        manualLayer.clearLayers();
        document.getElementById('clearPointBtn').disabled = true;
        document.getElementById('saveBtn').disabled = true;
        updateCoordinatesDisplay(null, null, 'Click on map to select a point');
        addLogEntry("Manual point cleared", "info");
    }
    
    function updateCoordinatesDisplay(lat, lng, source, accuracy = null) {
        const coordDisplay = document.getElementById('coordinates');
        
        if (lat !== null && lng !== null) {
            let html = `<div style="font-weight: 600; color: var(--primary);"><i class="fa-solid fa-map-pin"></i> ${source}</div>
                <div style="color: #27ae60; font-weight: bold; margin-top: 6px; font-size: 0.9rem;">
                    ${lat.toFixed(6)}, ${lng.toFixed(6)}
                </div>`;
            
            if (accuracy !== null) {
                html += `<div style="font-size: 0.75rem; color: ${getAccuracyColor(accuracy)}; margin-top: 4px; font-weight: 500;">
                    Accuracy: ${accuracy.toFixed(1)}m
                </div>`;
            }
            
            coordDisplay.innerHTML = html;
        } else {
            coordDisplay.innerHTML = `
                <div style="font-weight: 600; color: var(--primary);"><i class="fa-solid fa-info-circle"></i> ${source || 'Waiting for location...'}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 6px;">
                    ${locationMode === 'gps' ? 'Waiting for GPS signal' : 'Click on map to select a point'}
                </div>
            `;
        }
    }
    
    function getAccuracyColor(accuracy) {
        if (accuracy >= 3 && accuracy <= 20) return '#27ae60';
        if (accuracy < 3) return '#f39c12';
        if (accuracy <= 30) return '#f39c12';
        return '#e74c3c';
    }

    // ==========================================
    // GEOGRAPHICAL DATA FUNCTIONS
    // ==========================================
    function initializeGeographicalDropdowns() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        districtSelect.innerHTML = '<option value="">Select District/City</option>';
        subcountySelect.innerHTML = '<option value="">Select Subcounty</option>';
        parishSelect.innerHTML = '<option value="">Select Parish</option>';
        villageSelect.innerHTML = '<option value="">Select Village</option>';
        
        districts.forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            districtSelect.appendChild(option);
        });
        
        subcountySelect.disabled = true;
        parishSelect.disabled = true;
        villageSelect.disabled = true;
    }
    
    function getSubcountiesForDistrict(district) {
        return [...new Set(geographicalData
            .filter(item => item["DISTRICT/CITY"] === district)
            .map(item => item.SUBCOUNTY)
            .sort())];
    }
    
    function getParishesForSubcounty(district, subcounty) {
        return [...new Set(geographicalData
            .filter(item => item["DISTRICT/CITY"] === district && item.SUBCOUNTY === subcounty)
            .map(item => item.PARISH)
            .sort())];
    }
    
    function getVillagesForParish(district, subcounty, parish) {
        return [...new Set(geographicalData
            .filter(item => item["DISTRICT/CITY"] === district && 
                           item.SUBCOUNTY === subcounty && 
                           item.PARISH === parish)
            .map(item => item.VILLAGES)
            .sort())];
    }
    
    function updateSubcounties() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        const selectedDistrict = districtSelect.value;
        
        if (!selectedDistrict) {
            subcountySelect.disabled = true;
            parishSelect.disabled = true;
            villageSelect.disabled = true;
            
            subcountySelect.innerHTML = '<option value="">Select Subcounty</option>';
            parishSelect.innerHTML = '<option value="">Select Parish</option>';
            villageSelect.innerHTML = '<option value="">Select Village</option>';
            return;
        }
        
        subcountySelect.disabled = false;
        
        subcountySelect.innerHTML = '<option value="">Select Subcounty</option>';
        const subcounties = getSubcountiesForDistrict(selectedDistrict);
        
        subcounties.forEach(subcounty => {
            const option = document.createElement('option');
            option.value = subcounty;
            option.textContent = subcounty;
            subcountySelect.appendChild(option);
        });
        
        parishSelect.disabled = true;
        villageSelect.disabled = true;
        parishSelect.innerHTML = '<option value="">Select Parish</option>';
        villageSelect.innerHTML = '<option value="">Select Village</option>';
    }
    
    function updateParishes() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        const selectedDistrict = districtSelect.value;
        const selectedSubcounty = subcountySelect.value;
        
        if (!selectedDistrict || !selectedSubcounty) {
            parishSelect.disabled = true;
            villageSelect.disabled = true;
            
            parishSelect.innerHTML = '<option value="">Select Parish</option>';
            villageSelect.innerHTML = '<option value="">Select Village</option>';
            return;
        }
        
        parishSelect.disabled = false;
        
        parishSelect.innerHTML = '<option value="">Select Parish</option>';
        const parishes = getParishesForSubcounty(selectedDistrict, selectedSubcounty);
        
        parishes.forEach(parish => {
            const option = document.createElement('option');
            option.value = parish;
            option.textContent = parish;
            parishSelect.appendChild(option);
        });
        
        villageSelect.disabled = true;
        villageSelect.innerHTML = '<option value="">Select Village</option>';
    }
    
    function updateVillages() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        const selectedDistrict = districtSelect.value;
        const selectedSubcounty = subcountySelect.value;
        const selectedParish = parishSelect.value;
        
        if (!selectedDistrict || !selectedSubcounty || !selectedParish) {
            villageSelect.disabled = true;
            villageSelect.innerHTML = '<option value="">Select Village</option>';
            return;
        }
        
        villageSelect.disabled = false;
        
        villageSelect.innerHTML = '<option value="">Select Village</option>';
        const villages = getVillagesForParish(selectedDistrict, selectedSubcounty, selectedParish);
        
        villages.forEach(village => {
            const option = document.createElement('option');
            option.value = village;
            option.textContent = village;
            villageSelect.appendChild(option);
        });
    }

    function toggleManualEntry(fieldType) {
        const selectElement = document.getElementById(fieldType);
        const manualInput = document.getElementById(fieldType + 'Manual');
        
        if (selectElement.style.display === 'none') {
            selectElement.style.display = 'block';
            manualInput.style.display = 'none';
            selectElement.disabled = false;
            
            manualInput.value = '';
            
            if (fieldType === 'districtCity') {
                updateSubcounties();
            } else if (fieldType === 'subcounty') {
                updateParishes();
            } else if (fieldType === 'parish') {
                updateVillages();
            }
        } else {
            selectElement.style.display = 'none';
            manualInput.style.display = 'block';
            selectElement.disabled = true;
            
            selectElement.value = '';
            
            if (fieldType === 'districtCity') {
                document.getElementById('subcounty').disabled = true;
                document.getElementById('subcounty').value = '';
                document.getElementById('parish').disabled = true;
                document.getElementById('parish').value = '';
                document.getElementById('village').disabled = true;
                document.getElementById('village').value = '';
            } else if (fieldType === 'subcounty') {
                document.getElementById('parish').disabled = true;
                document.getElementById('parish').value = '';
                document.getElementById('village').disabled = true;
                document.getElementById('village').value = '';
            } else if (fieldType === 'parish') {
                document.getElementById('village').disabled = true;
                document.getElementById('village').value = '';
            }
        }
    }

    // ==========================================
    // REGISTRATION TYPE FUNCTIONS
    // ==========================================
    let registrationType = 'titled';

    function setRegistrationType(type) {
        registrationType = type;
        
        document.getElementById('titledToggle').classList.toggle('active', type === 'titled');
        document.getElementById('untitledToggle').classList.toggle('active', type === 'untitled');
        
        const titleFields = document.getElementById('titleFields');
        const plotNumberInput = document.getElementById('plotNumber');
        const blockNumberInput = document.getElementById('blockNumber');
        
        if (type === 'titled') {
            titleFields.style.display = 'grid';
            plotNumberInput.disabled = false;
            blockNumberInput.disabled = false;
            plotNumberInput.required = true;
            blockNumberInput.required = true;
        } else {
            titleFields.style.display = 'none';
            plotNumberInput.disabled = true;
            blockNumberInput.disabled = true;
            plotNumberInput.required = false;
            blockNumberInput.required = false;
            plotNumberInput.value = '';
            blockNumberInput.value = '';
        }
        
        addLogEntry(`Registration type set to: ${type}`, "info");
    }

    // ==========================================
    // PROPERTY ID GENERATION
    // ==========================================
    function generatePropertyId() {
        const el = document.getElementById('propertyId');
        if (el) {
            el.value = 'PRO-001';
        }
    }

    async function updatePropertyIdCounter() {
        const records = await db.getAllRecords();
        let maxId = 0;
        
        records.forEach(record => {
            if (record.propertyId && record.propertyId.startsWith('PRO-')) {
                const idMatch = record.propertyId.match(/PRO-(\d+)/);
                if (idMatch) {
                    const idNum = parseInt(idMatch[1]);
                    if (idNum > maxId) {
                        maxId = idNum;
                    }
                }
            }
        });
        
        propertyIdCounter = maxId + 1;
        const newId = `PRO-${propertyIdCounter.toString().padStart(3, '0')}`;
        const el = document.getElementById('propertyId');
        if (el) {
            el.value = newId;
        }
        propertyIdCounter++;
    }

    // ==========================================
    // EVIDENCE PHOTO HANDLING
    // ==========================================
    function capturePhoto() {
        document.getElementById('photoInput').click();
    }
    
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;

        const MAX_WIDTH = 1280;
        const MAX_HEIGHT = 1280;
        const QUALITY = 0.7;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                ctx.drawImage(img, 0, 0, width, height);

                evidencePhoto = canvas.toDataURL('image/jpeg', QUALITY);

                document.getElementById('imagePreview').src = evidencePhoto;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('removePhotoBtn').style.display = 'block';
                
                const originalSize = Math.round(file.size / 1024);
                const compressedSize = Math.round((evidencePhoto.length * 3 / 4) / 1024);
                
                addLogEntry(`Photo compressed: ${originalSize}KB  ${compressedSize}KB`, "success");
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function removePhoto() {
        evidencePhoto = null;
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('removePhotoBtn').style.display = 'none';
        document.getElementById('photoInput').value = '';
        addLogEntry("Evidence photo removed", "info");
    }

    // ==========================================
    // DATA SAVING FUNCTION - FIXED FOR REJECTION NOTIFICATIONS & AUTH
    // ==========================================
    async function saveData() {
        // FORCE CHECK: If global currentFirebaseUser is null, check the SDK directly
        let activeUser = currentFirebaseUser;
        if (!activeUser && firebase.auth && firebase.auth().currentUser) {
            activeUser = firebase.auth().currentUser;
            currentFirebaseUser = activeUser; // Restore global state
        }
        
        let position;
        let positionSource;
        let accuracy = null;
        
        if (locationMode === 'gps') {
            if (!currentPos) {
                alert("Waiting for GPS signal...");
                return;
            }
            
            if (!currentAccuracy || currentAccuracy < 3 || currentAccuracy > 20) {
                alert(`GPS accuracy (${currentAccuracy ? currentAccuracy.toFixed(1) : 'unknown'}m) is outside required range (3-20m).\n\nPlease move to an open area and wait for better GPS accuracy.`);
                return;
            }
            
            position = currentPos;
            positionSource = 'GPS';
            accuracy = currentAccuracy;
        } else {
            if (!manualPos) {
                alert("Please select a point on the map first.");
                return;
            }
            position = manualPos;
            positionSource = 'Manual Selection';
        }

        const propertyId = document.getElementById('propertyId').value.trim();
        const propertyName = document.getElementById('propertyName').value.trim();
        const plotNumber = document.getElementById('plotNumber').value.trim();
        const blockNumber = document.getElementById('blockNumber').value.trim();
        
        const districtCity = document.getElementById('districtCityManual').style.display === 'block' 
            ? document.getElementById('districtCityManual').value.trim()
            : document.getElementById('districtCity').value.trim();
        
        const subcounty = document.getElementById('subcountyManual').style.display === 'block'
            ? document.getElementById('subcountyManual').value.trim()
            : document.getElementById('subcounty').value.trim();
        
        const parish = document.getElementById('parishManual').style.display === 'block'
            ? document.getElementById('parishManual').value.trim()
            : document.getElementById('parish').value.trim();
        
        const village = document.getElementById('villageManual').style.display === 'block'
            ? document.getElementById('villageManual').value.trim()
            : document.getElementById('village').value.trim();
        
        const description = document.getElementById('description').value.trim();
        const dataSource = document.getElementById('dataSource').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const size = parseFloat(document.getElementById('size').value);
        const landUse = document.getElementById('use').value;
        const officerName = document.getElementById('officerName').value.trim();
        
        if (!propertyId) {
            alert("Please generate Property ID.");
            return;
        }
        
        if (!districtCity) {
            alert("Please select or enter District/City.");
            return;
        }
        
        if (!subcounty) {
            alert("Please select or enter Subcounty.");
            return;
        }
        
        if (!parish) {
            alert("Please select or enter Parish.");
            return;
        }
        
        if (!village) {
            alert("Please select or enter Village.");
            return;
        }
        
        if (!dataSource) {
            alert("Please select Data Source.");
            return;
        }
        
        if (!price || !size || price <= 0 || size <= 0) {
            alert("Please enter valid price and size values.");
            return;
        }
        
        if (!landUse) {
            alert("Please select Land Use.");
            return;
        }
        
        if (!officerName) {
            alert("Please enter the Name of Officer (Data Collector).");
            return;
        }
        
        if (registrationType === 'titled' && !plotNumber) {
            alert("For titled properties, Plot Number is required.");
            return;
        }

        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> SAVING...';

        try {
            const existingRecord = await db.getRecordByPropertyId(propertyId);
            
            let isRevised = false;
            let revisionNumber = 0;
            let previousStatus = '';
            let originalSubmissionId = null;

            if (existingRecord) {
                // If the record was previously rejected, clear rejection status and notifications
                if (existingRecord.status === 'rejected') {
                    isRevised = true;
                    previousStatus = 'rejected';
                    revisionNumber = (existingRecord.revisionNumber || 0) + 1;
                    originalSubmissionId = existingRecord.originalSubmissionId || existingRecord.propertyId;
                    
                    // Clear any pending rejection notifications for this property
                    await db.clearRejectionNotifications(propertyId);
                    
                    // Hide rejection modal if it's showing
                    document.getElementById('rejectionFeedback').style.display = 'none';
                    document.getElementById('rejectionNotification').style.display = 'none';
                } else {
                    isRevised = existingRecord.isRevised || false;
                    revisionNumber = existingRecord.revisionNumber || 1;
                    previousStatus = existingRecord.previousStatus || '';
                    originalSubmissionId = existingRecord.originalSubmissionId || null;
                }
            }
            
            if (existingRecord && existingRecord.status !== 'rejected') {
                if (!confirm(`Property ID ${propertyId} already exists. Do you want to update it?`)) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
                    return;
                }
            }

            const record = {
                id: existingRecord ? existingRecord.id : Date.now(),
                propertyId: propertyId,
                propertyName: propertyName,
                registrationType: registrationType,
                plotNumber: plotNumber,
                blockNumber: blockNumber,
                districtCity: districtCity,
                district: districtCity,
                subcounty: subcounty,
                parish: parish,
                village: village,
                description: description,
                dataSource: dataSource,
                landUse: landUse,
                price: price,
                size: size,
                rate: (price / size).toFixed(2),
                latitude: position[0].toFixed(6),
                longitude: position[1].toFixed(6),
                coordinates: `${position[0].toFixed(6)}, ${position[1].toFixed(6)}`,
                photo: evidencePhoto,
                locationMode: locationMode,
                positionSource: positionSource,
                gpsAccuracy: accuracy ? accuracy.toFixed(1) : null,
                officerName: officerName,
                officerEmail: activeUser ? activeUser.email : 'offline_user',
                userId: activeUser ? activeUser.uid : 'offline_id',
                
                date: new Date().toISOString(),
                formattedDate: new Date().toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }),
                
                status: 'pending',
                validationStatus: 'pending',
                
                isRevised: isRevised,
                revisionNumber: revisionNumber,
                previousStatus: previousStatus,
                originalSubmissionId: originalSubmissionId,
                
                syncStatus: activeUser ? 'pending' : 'pending', // Always pending to trigger sync queue when online
                firebaseId: existingRecord ? existingRecord.firebaseId : null,
                
                // Clear any rejection-related fields
                rejectionReason: null,
                rejectionFeedback: null
            };

            await db.saveRecord(record);
            
            if (activeUser) {
                await db.addToSyncQueue(record.id, 'sync', record);
            }

            clearForm();
            
            await updatePropertyIdCounter();
            
            if (locationMode === 'manual') {
                clearManualPoint();
            }

            await refreshDataDisplay();
            
            await updateStorageUsage();
            
            if (activeUser && navigator.onLine) {
                await processSyncQueue();
            }

            await checkNotifications();

            alert(` Property record saved successfully!\n ID: ${record.propertyId}\n Name: ${record.propertyName || 'Not provided'}\n Location: ${record.coordinates}\n Rate: $${record.rate}/Ha`);
            
            addLogEntry(`Property saved: ${record.propertyId}`, "success");

        } catch (error) {
            console.error("Save error:", error);
            alert(`Save failed: ${error.message}`);
            addLogEntry(`Save failed: ${error.message}`, "error");
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
        }
    }

    function clearForm() {
        const officerName = document.getElementById('officerName').value;
        
        document.getElementById('propertyName').value = '';
        document.getElementById('plotNumber').value = '';
        document.getElementById('blockNumber').value = '';
        
        document.getElementById('districtCity').value = '';
        document.getElementById('districtCityManual').style.display = 'none';
        document.getElementById('districtCity').style.display = 'block';
        document.getElementById('districtCity').disabled = false;
        
        document.getElementById('subcounty').value = '';
        document.getElementById('subcountyManual').style.display = 'none';
        document.getElementById('subcounty').style.display = 'block';
        document.getElementById('subcounty').disabled = true;
        
        document.getElementById('parish').value = '';
        document.getElementById('parishManual').style.display = 'none';
        document.getElementById('parish').style.display = 'block';
        document.getElementById('parish').disabled = true;
        
        document.getElementById('village').value = '';
        document.getElementById('villageManual').style.display = 'none';
        document.getElementById('village').style.display = 'block';
        document.getElementById('village').disabled = true;
        
        document.getElementById('description').value = '';
        document.getElementById('dataSource').selectedIndex = 0;
        document.getElementById('price').value = '';
        document.getElementById('size').value = '';
        document.getElementById('use').selectedIndex = 0;
        document.getElementById('officerName').value = officerName;
        removePhoto();
        
        updateSubcounties();
    }

    // ==========================================
    // DATA DISPLAY FUNCTIONS
    // ==========================================
    async function refreshDataDisplay() {
        const records = await db.getAllRecords();
        
        document.getElementById('recordCount').textContent = `${records.length} records`;
        
        updateTable(records);
        
        updateMapMarkers(records);
        
        await updatePropertyIdCounter();
        
        await updateSyncStats();
    }

    function updateTable(records) {
        const tbody = document.querySelector("#dataTable tbody");
        if (!tbody) return;
        
        tbody.innerHTML = "";
        
        records.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
            const row = tbody.insertRow();
            row.dataset.id = item.id;
            
            let syncDisplay = '';
            if (item.syncStatus) {
                switch(item.syncStatus) {
                    case 'synced':
                        syncDisplay = '<span class="sync-status sync-synced" style="font-size: 0.7rem;"><i class="fa-solid fa-cloud-check"></i> Synced</span>';
                        break;
                    case 'queued':
                        syncDisplay = '<span class="sync-status sync-queued" style="font-size: 0.7rem;"><i class="fa-solid fa-clock"></i> Queued</span>';
                        break;
                    case 'pending':
                        syncDisplay = '<span class="sync-status sync-pending" style="font-size: 0.7rem;"><i class="fa-solid fa-hourglass-half"></i> Pending</span>';
                        break;
                    default:
                        syncDisplay = '';
                }
            }
            
            row.innerHTML = `
                <td style="font-weight:600;">${item.propertyId}</td>
                <td>${item.propertyName || ''}</td>
                <td>${item.plotNumber || ''}</td>
                <td>$${item.rate || '0'}/Ha</td>
                <td>${syncDisplay}</td>
                <td>
                    <button onclick="previewRecord(${item.id})" class="action-btn" style="background:#3498db; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:0.8rem;">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </td>
            `;
            
            row.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    previewRecord(item.id);
                }
            });
        });
    }

    function updateMapMarkers(records) {
        if (!savedLayer || !map) {
            console.log("Map not ready yet, skipping marker update...");
            return;
        }
        
        savedLayer.clearLayers();
        
        records.forEach(record => {
            if (record.latitude && record.longitude) {
                const lat = parseFloat(record.latitude);
                const lng = parseFloat(record.longitude);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    let iconColor = getColorForUse(record.landUse);
                    let iconClass = 'fa-map-pin';
                    
                    if (record.status === 'rejected') {
                        iconColor = '#e74c3c';
                        iconClass = 'fa-ban';
                    } else if (record.status === 'approved') {
                        iconColor = '#27ae60';
                        iconClass = 'fa-check-circle';
                    }
                    
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'saved-marker',
                            html: `<div style="
                                width: 24px;
                                height: 24px;
                                background: ${iconColor};
                                border: 2px solid white;
                                border-radius: 50%;
                                box-shadow: 0 0 5px rgba(0,0,0,0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 10px;
                            "><i class="fa-solid ${iconClass}"></i></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        }),
                        title: `${record.propertyName || 'Property'} - $${record.rate}/Ha ${record.status === 'rejected' ? '(REJECTED)' : ''}`
                    }).addTo(savedLayer);
                    
                    let popupContent = `
                        <div style="min-width: 250px;">
                            <h4 style="margin: 0 0 10px 0; color: ${iconColor};">
                                <i class="fa-solid fa-house"></i> ${record.propertyName || 'Property'}
                                ${record.status === 'rejected' ? '<span style="color: #e74c3c; font-size: 0.8em;"> (REJECTED)</span>' : ''}
                                ${record.status === 'approved' ? '<span style="color: #27ae60; font-size: 0.8em;"> (APPROVED)</span>' : ''}
                            </h4>
                            <p><strong>Property ID:</strong> ${record.propertyId}</p>
                            <p><strong>Registration:</strong> ${record.registrationType || 'titled'}</p>
                            <p><strong>Plot:</strong> ${record.plotNumber || 'N/A'}</p>
                            <p><strong>Block:</strong> ${record.blockNumber || 'N/A'}</p>
                            <p><strong>Location:</strong> ${record.village}, ${record.parish}</p>
                            <p><strong>District/City:</strong> ${record.districtCity}</p>
                            <p><strong>Subcounty:</strong> ${record.subcounty}</p>
                            <p><strong>Land Use:</strong> ${record.landUse}</p>
                            <p><strong>Price:</strong> $${record.price}</p>
                            <p><strong>Size:</strong> ${record.size} Ha</p>
                            <p><strong>Rate:</strong> $${record.rate}/Ha</p>
                            <p><strong>Officer:</strong> ${record.officerName}</p>
                            <p><strong>Date:</strong> ${record.formattedDate}</p>
                    `;
                    
                    if (record.photo) {
                        popupContent += `
                            <p><strong>Evidence:</strong></p>
                            <img src="${record.photo}" style="max-width: 150px; border-radius: 4px; margin-top: 5px;">
                        `;
                    }
                    
                    popupContent += `
                            <hr style="margin: 10px 0;">
                            <button onclick="previewRecord(${record.id})" style="width: 100%; padding: 5px; background: ${iconColor}; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                View Property Details
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    marker.recordId = record.id;
                }
            }
        });
    }

    function getColorForUse(landUse) {
        const colors = {
            'Residential': '#3498db',
            'Commercial': '#e74c3c',
            'Agricultural': '#27ae60',
            'Industrial': '#f39c12',
            'Recreational': '#9b59b6',
            'Mixed Use': '#8e44ad',
            'Vacant Land': '#95a5a6',
            'Forest': '#16a085',
            'Wetland': '#2980b9'
        };
        return colors[landUse] || '#3498db';
    }

    async function previewRecord(id) {
        const record = await db.getRecord(id);
        if (!record) return;

        const modal = document.getElementById('dataPreview');
        const content = document.getElementById('previewContent');
        
        if (modal && content) {
            content.innerHTML = `
                <div class="preview-item">
                    <div class="preview-label">Property ID</div>
                    <div class="preview-value">${record.propertyId}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Property Name</div>
                    <div class="preview-value">${record.propertyName || 'Not provided'}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Registration Type</div>
                    <div class="preview-value">${record.registrationType || 'titled'}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Plot Number</div>
                    <div class="preview-value">${record.plotNumber || 'N/A'}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Block Number</div>
                    <div class="preview-value">${record.blockNumber || 'N/A'}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">District/City</div>
                    <div class="preview-value">${record.districtCity}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Subcounty</div>
                    <div class="preview-value">${record.subcounty}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Parish</div>
                    <div class="preview-value">${record.parish}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Village</div>
                    <div class="preview-value">${record.village}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Land Use</div>
                    <div class="preview-value">${record.landUse}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Price</div>
                    <div class="preview-value">$${record.price}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Size</div>
                    <div class="preview-value">${record.size} Ha</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Rate</div>
                    <div class="preview-value">$${record.rate}/Ha</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Coordinates</div>
                    <div class="preview-value">${record.coordinates}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Location Source</div>
                    <div class="preview-value">${record.positionSource}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">GPS Accuracy</div>
                    <div class="preview-value">${record.gpsAccuracy ? record.gpsAccuracy + 'm' : 'N/A'}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Data Source</div>
                    <div class="preview-value">${record.dataSource}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Officer Name</div>
                    <div class="preview-value">${record.officerName}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Officer Email</div>
                    <div class="preview-value">${record.officerEmail || 'Not available'}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Date</div>
                    <div class="preview-value">${record.formattedDate}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Status</div>
                    <div class="preview-value" style="color: ${record.status === 'approved' ? '#27ae60' : record.status === 'rejected' ? '#e74c3c' : '#f39c12'}">
                        ${record.status ? record.status.toUpperCase() : 'PENDING'}
                    </div>
                </div>
                ${record.isRevised ? `
                <div class="preview-item" style="grid-column: span 2; background: #fff3e0; padding: 10px; border-radius: 6px; border-left: 3px solid #f39c12;">
                    <div class="preview-label" style="color: #f39c12;">Revision Information</div>
                    <div class="preview-value">Revision ${record.revisionNumber} - Previously ${record.previousStatus}</div>
                </div>
                ` : ''}
                ${record.rejectionReason ? `
                <div class="preview-item" style="grid-column: span 2; background: #fdeaea; padding: 10px; border-radius: 6px; border-left: 3px solid #e74c3c;">
                    <div class="preview-label" style="color: #e74c3c;">Rejection Reason</div>
                    <div class="preview-value">${record.rejectionReason}</div>
                </div>
                ` : ''}
                ${record.rejectionFeedback ? `
                <div class="preview-item" style="grid-column: span 2; background: #fef9e7; padding: 10px; border-radius: 6px; border-left: 3px solid #f39c12;">
                    <div class="preview-label" style="color: #f39c12;">Rejection Feedback</div>
                    <div class="preview-value">${record.rejectionFeedback}</div>
                </div>
                ` : ''}
                ${record.description ? `
                <div class="preview-item" style="grid-column: span 2;">
                    <div class="preview-label">Description</div>
                    <div class="preview-value">${record.description}</div>
                </div>
                ` : ''}
                ${record.photo ? `
                <div class="preview-item" style="grid-column: span 2;">
                    <div class="preview-label">Evidence Photo</div>
                    <img src="${record.photo}" style="max-width: 100%; border-radius: 8px; margin-top: 5px;">
                </div>
                ` : ''}
                <div class="preview-item" style="grid-column: span 2; margin-top: 15px;">
                    <button onclick="loadRecordIntoForm(${record.id})" class="warning" style="width: 100%;">
                        <i class="fa-solid fa-edit"></i> Edit & Resubmit
                    </button>
                </div>
            `;
            modal.style.display = 'block';
        }
    }

    async function loadRecordIntoForm(id) {
        const record = await db.getRecord(id);
        if (!record) return;

        document.getElementById('propertyId').value = record.propertyId;
        document.getElementById('propertyName').value = record.propertyName || '';
        document.getElementById('plotNumber').value = record.plotNumber || '';
        document.getElementById('blockNumber').value = record.blockNumber || '';
        
        setRegistrationType(record.registrationType || 'titled');
        
        document.getElementById('districtCity').value = record.districtCity || '';
        updateSubcounties();
        
        if (record.subcounty) {
            setTimeout(() => {
                document.getElementById('subcounty').value = record.subcounty;
                updateParishes();
                
                if (record.parish) {
                    setTimeout(() => {
                        document.getElementById('parish').value = record.parish;
                        updateVillages();
                        
                        if (record.village) {
                            setTimeout(() => {
                                document.getElementById('village').value = record.village;
                            }, 100);
                        }
                    }, 100);
                }
            }, 100);
        }
        
        document.getElementById('description').value = record.description || '';
        document.getElementById('dataSource').value = record.dataSource || '';
        document.getElementById('price').value = record.price || '';
        document.getElementById('size').value = record.size || '';
        document.getElementById('use').value = record.landUse || '';
        document.getElementById('officerName').value = record.officerName || '';
        
        if (record.photo) {
            evidencePhoto = record.photo;
            document.getElementById('imagePreview').src = evidencePhoto;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('removePhotoBtn').style.display = 'block';
        }
        
        if (record.locationMode === 'manual') {
            setLocationMode('manual');
        } else {
            setLocationMode('gps');
        }
        
        hidePreview();
        
        alert(`Property ${record.propertyId} loaded into form. You can now edit and resubmit.`);
        addLogEntry(`Property ${record.propertyId} loaded into form for editing`, "info");
    }

    async function deleteRecord(id) {
        if (confirm('Are you sure you want to delete this record? This cannot be undone.')) {
            const record = await db.getRecord(id);
            await db.deleteRecord(id);
            
            if (record.firebaseId && currentFirebaseUser) {
                await db.addToSyncQueue(id, 'delete', record);
            }
            
            document.getElementById('dataPreview').style.display = 'none';
            await refreshDataDisplay();
            addLogEntry("Record deleted", "warning");
            
            if (currentFirebaseUser && navigator.onLine) {
                await processSyncQueue();
            }
        }
    }

    function hidePreview() {
        const modal = document.getElementById('dataPreview');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // ==========================================
    // STORAGE MANAGEMENT
    // ==========================================
    async function updateStorageUsage() {
        const estimate = await db.getStorageEstimate();
        if (estimate) {
            const usageMB = (estimate.usage / 1024 / 1024).toFixed(2);
            const quotaMB = (estimate.quota / 1024 / 1024).toFixed(2);
            const percent = Math.min((estimate.usage / estimate.quota) * 100, 100);
            
            const bar = document.getElementById('storageFill');
            const used = document.getElementById('storageUsed');
            const total = document.getElementById('storageTotal');
            
            if (bar) bar.style.width = `${percent}%`;
            if (used) used.textContent = `${usageMB} MB`;
            if (total) total.textContent = `${quotaMB} MB total`;
        }
    }

    async function clearAllData() {
        if (confirm(" WARNING: This will delete ALL property data, logs, and markers!\n\nThis includes:\n All saved property records\n All activity logs\n All map markers\n All evidence photos\n\nThis action CANNOT be undone!\n\nClick OK to proceed or Cancel to abort.")) {
            addLogEntry("Clear All Data action initiated", "warning");
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay danger-confirmation';
            modal.style.display = 'flex';
            modal.style.zIndex = '5000';
            
            modal.innerHTML = `
                <div class="modal danger-modal">
                    <h3><i class="fa-solid fa-triangle-exclamation"></i> FINAL CONFIRMATION REQUIRED</h3>
                    <p style="margin: 20px 0; font-size: 0.9rem; line-height: 1.5; color: #2c3e50;">You are about to permanently delete ALL data. This action cannot be undone. To proceed, type 'DELETE ALL' in the field below.</p>
                    
                    <div class="field-group" style="margin: 20px 0;">
                        <label for="confirmationInput">Type <span style="color: #e74c3c; font-weight: bold;">DELETE ALL</span> to confirm:</label>
                        <input type="text" id="confirmationInput" placeholder="Type DELETE ALL here" 
                               style="text-align: center; font-weight: bold; border: 2px solid #e74c3c;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                        <button onclick="this.closest('.modal-overlay').remove()" class="secondary">
                            <i class="fa-solid fa-times"></i> Cancel
                        </button>
                        <button id="confirmDangerBtn" class="danger-btn" disabled>
                            <i class="fa-solid fa-check"></i> Delete All Data
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const input = document.getElementById('confirmationInput');
            const confirmBtn = document.getElementById('confirmDangerBtn');
            
            input.addEventListener('input', function() {
                confirmBtn.disabled = this.value !== 'DELETE ALL';
            });
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value === 'DELETE ALL') {
                    performClearAll();
                    modal.remove();
                }
            });
            
            confirmBtn.addEventListener('click', function() {
                if (input.value === 'DELETE ALL') {
                    performClearAll();
                    modal.remove();
                }
            });
            
            setTimeout(() => input.focus(), 100);
        }
    }

    async function performClearAll() {
        try {
            await db.clearDatabase();
            savedLayer.clearLayers();
            await refreshDataDisplay();
            addLogEntry(" ALL PROPERTY DATA CLEARED - This action was intentionally confirmed by user", "error");
            await updateStorageUsage();
            alert(" All data has been cleared successfully!");
        } catch (error) {
            console.error("Clear all error:", error);
            addLogEntry(`Clear all failed: ${error.message}`, "error");
            alert("Failed to clear data: " + error.message);
        }
    }

    // ==========================================
    // EXPORT FUNCTIONS
    // ==========================================
    async function exportData() {
        const records = await db.getAllRecords();
        if (records.length === 0) {
            alert("No data to export");
            return;
        }

        const headers = [
            'Property ID', 'Property Name', 'Registration Type', 'Plot Number', 'Block Number',
            'District/City', 'Subcounty', 'Parish', 'Village', 'Description', 'Data Source',
            'Land Use', 'Price ($)', 'Size (Ha)', 'Rate ($/Ha)', 'Latitude', 'Longitude',
            'GPS Accuracy (m)', 'Location Source', 'Officer Name', 'Officer Email', 'Date', 'Status',
            'Is Revised', 'Revision Number', 'Previous Status', 'Original Submission ID'
        ];
        
        const rows = records.map(r => [
            r.propertyId,
            r.propertyName || '',
            r.registrationType || 'titled',
            r.plotNumber || '',
            r.blockNumber || '',
            r.districtCity || '',
            r.subcounty || '',
            r.parish || '',
            r.village || '',
            r.description || '',
            r.dataSource || '',
            r.landUse || '',
            r.price || 0,
            r.size || 0,
            r.rate || 0,
            r.latitude || 0,
            r.longitude || 0,
            r.gpsAccuracy || '',
            r.positionSource || '',
            r.officerName || '',
            r.officerEmail || '',
            r.formattedDate || '',
            r.status || 'pending',
            r.isRevised || false,
            r.revisionNumber || 1,
            r.previousStatus || '',
            r.originalSubmissionId || ''
        ]);
        
        const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lavmis_export_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLogEntry(`Exported ${records.length} records as CSV`, "success");
    }

    async function exportGeoJSON() {
        const records = await db.getAllRecords();
        if (records.length === 0) {
            alert("No data to export");
            return;
        }

        const features = records.map(r => {
            if (r.latitude && r.longitude) {
                return {
                    type: "Feature",
                    properties: {
                        propertyId: r.propertyId,
                        propertyName: r.propertyName || '',
                        registrationType: r.registrationType || 'titled',
                        plotNumber: r.plotNumber || '',
                        blockNumber: r.blockNumber || '',
                        districtCity: r.districtCity || '',
                        subcounty: r.subcounty || '',
                        parish: r.parish || '',
                        village: r.village || '',
                        landUse: r.landUse || '',
                        price: r.price || 0,
                        size: r.size || 0,
                        rate: r.rate || 0,
                        officerName: r.officerName || '',
                        officerEmail: r.officerEmail || '',
                        date: r.formattedDate || '',
                        status: r.status || 'pending',
                        isRevised: r.isRevised || false,
                        revisionNumber: r.revisionNumber || 1,
                        previousStatus: r.previousStatus || ''
                    },
                    geometry: {
                        type: "Point",
                        coordinates: [parseFloat(r.longitude), parseFloat(r.latitude)]
                    }
                };
            }
            return null;
        }).filter(f => f !== null);

        const geoJSON = {
            type: "FeatureCollection",
            features: features
        };

        const blob = new Blob([JSON.stringify(geoJSON, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lavmis_geojson_${new Date().toISOString().slice(0,10)}.geojson`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLogEntry(`Exported ${features.length} records as GeoJSON`, "success");
    }

    // ==========================================
    // OFFLINE MAPS CACHING
    // ==========================================
    function cacheTiles() {
        if (!navigator.onLine) {
            alert("You must be online to cache map tiles.");
            return;
        }

        const bbox = map.getBounds();
        const currentZoom = map.getZoom();
        
        const maxZoom = Math.min(Math.ceil(currentZoom) + 2, 17);
        const minZoom = Math.floor(currentZoom);

        if (confirm(`Download map tiles for this area? \nZoom Levels: ${minZoom}-${maxZoom}\n\nThis may take a moment.`)) {
            const statusDiv = document.getElementById('cache-status');
            if(statusDiv) statusDiv.innerHTML = "Starting download...";
            
            satelliteTileLayer.seed(bbox, minZoom, maxZoom);
        }
        
        addLogEntry("Map caching requested", "info");
    }

    function clearCache() {
        if (confirm("Clear all cached map tiles? This will delete downloaded map data for offline use.")) {
            alert("In the full version, this would clear the PouchDB cache. Map tiles will need to be re-downloaded when offline.");
            addLogEntry("Map cache cleared", "info");
        }
    }

    // ==========================================
    // MODAL FUNCTIONS
    // ==========================================
    function showBackupModal() {
        document.getElementById('backupModal').style.display = 'flex';
    }

    function showRestoreModal() {
        document.getElementById('restoreModal').style.display = 'flex';
    }

    function hideModal() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.style.display = 'none';
        });
    }

    function backupData(format) {
        if (format === 'json') {
            exportBackupJSON();
        } else if (format === 'csv') {
            exportData();
        }
    }

    async function exportBackupJSON() {
        const records = await db.getAllRecords();
        const logs = await db.getLogs(1000);
        
        const backup = {
            version: '2.0',
            timestamp: new Date().toISOString(),
            app: 'LAVMIS Pro',
            data: records,
            logs: logs,
            metadata: {
                totalRecords: records.length,
                totalLogs: logs.length,
                backupType: 'manual'
            }
        };
        
        const content = JSON.stringify(backup, null, 2);
        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lavmis_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLogEntry(`Backup created: ${records.length} records`, "success");
    }

    async function restoreData() {
        const fileInput = document.getElementById('restoreFile');
        if (!fileInput.files.length) {
            alert("Please select a backup file first.");
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const content = e.target.result;
                let restoredData;
                
                if (file.name.endsWith('.json')) {
                    restoredData = JSON.parse(content);
                    
                    if (!restoredData.data || !Array.isArray(restoredData.data)) {
                        throw new Error('Invalid backup format');
                    }
                    
                    await db.clearDatabase();
                    
                    for (const record of restoredData.data) {
                        await db.saveRecord(record);
                    }
                    
                    if (restoredData.logs && Array.isArray(restoredData.logs)) {
                        for (const log of restoredData.logs) {
                            await db.addLogEntry(log.message, log.type || 'info');
                        }
                    }
                    
                } else {
                    throw new Error('Unsupported file format. Please use JSON backup files.');
                }
                
                alert(` Data restored successfully!\n\nRestored ${restoredData.data.length} property records.`);
                
                await refreshDataDisplay();
                await loadLogs();
                await updateStorageUsage();
                
                addLogEntry(`Data restored from backup: ${restoredData.data.length} records`, "success");
                
            } catch (error) {
                console.error("Restore error:", error);
                alert(`Restore failed: ${error.message}`);
                addLogEntry(`Restore failed: ${error.message}`, "error");
            }
        };
        
        reader.readAsText(file);
    }

    // ==========================================
    // MISCELLANEOUS FUNCTIONS
    // ==========================================
    function clearAllMarkers() {
        if (confirm("Are you sure you want to remove all property markers from the map? This won't delete your saved data.")) {
            savedLayer.clearLayers();
            addLogEntry("All property markers cleared", "warning");
        }
    }

    function hideRejectionFeedback() {
        const modal = document.getElementById('rejectionFeedback');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    async function loadRejectedPropertyIntoForm() {
        const modal = document.getElementById('rejectionFeedback');
        const propertyId = document.getElementById('rejectionPropertyId').textContent;
        
        try {
            const record = await db.getRecordByPropertyId(propertyId);
            if (record) {
                await loadRecordIntoForm(record.id);
                
                modal.style.display = 'none';
                document.getElementById('rejectionNotification').style.display = 'none';
                
                alert(`Property ${propertyId} loaded into form. Please make corrections and resubmit.`);
                addLogEntry(`Rejected property ${propertyId} loaded into form for editing`, "info");
            } else {
                alert('Property not found in local database.');
            }
        } catch (error) {
            console.error('Error loading rejected property:', error);
            alert('Failed to load property: ' + error.message);
        }
    }

    // ==========================================
    // EXPORT FUNCTIONS TO WINDOW
    // ==========================================
    window.attemptLogin = attemptLogin;
    window.initiateLogout = initiateLogout;
    window.saveData = saveData;
    window.setRegistrationType = setRegistrationType;
    window.setLocationMode = setLocationMode;
    window.clearManualPoint = clearManualPoint;
    window.centerOnGPS = centerOnGPS;
    window.toggleAutoCenter = toggleAutoCenter;
    window.capturePhoto = capturePhoto;
    window.handlePhotoUpload = (e) => handlePhotoUpload(e);
    window.removePhoto = removePhoto;
    window.clearAllMarkers = clearAllMarkers;
    window.clearLog = clearLog;
    window.hidePreview = hidePreview;
    window.previewRecord = previewRecord;
    window.loadRecordIntoForm = loadRecordIntoForm;
    window.exportData = exportData;
    window.exportGeoJSON = exportGeoJSON;
    window.clearAllData = clearAllData;
    window.cacheTiles = cacheTiles;
    window.clearCache = clearCache;
    window.syncAllToFirebase = syncAllToFirebase;
    window.restoreFromFirebase = restoreFromFirebase;
    window.backupToFirebase = backupToFirebase;
    window.showBackupModal = showBackupModal;
    window.showRestoreModal = showRestoreModal;
    window.hideModal = hideModal;
    window.backupData = backupData;
    window.restoreData = restoreData;
    window.hideRejectionFeedback = hideRejectionFeedback;
    window.loadRejectedPropertyIntoForm = loadRejectedPropertyIntoForm;
    window.updateSubcounties = updateSubcounties;
    window.updateParishes = updateParishes;
    window.updateVillages = updateVillages;
    window.toggleManualEntry = toggleManualEntry;
    window.markNotificationRead = markNotificationRead;
    window.deleteRecord = deleteRecord;

</script>
</body>
</html>
