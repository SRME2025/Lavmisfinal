<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LAVMIS DATA COLLECTOR MODULE | Offline Satellite</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        :root { 
            --sidebar-width: 480px; 
            --primary: #2c3e50; 
            --accent: #3498db; 
            --success: #27ae60; 
            --valuation: #f39c12; 
            --panel-bg: #ffffff; 
            --warning: #e74c3c;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border: #e0e0e0;
            --light-bg: #f8f9fa;
            --firebase: #FFA611;
        }
        
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%; 
            font-family: 'Segoe UI', 'Roboto', sans-serif; 
            overflow: hidden; 
            display: flex; 
            background-color: #f5f7fa;
            color: var(--text-primary);
        }
        
        /* LOGIN MODAL STYLES - White theme */
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--accent);
            text-align: center;
        }
        
        .login-container h2 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-input-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .login-input-group input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .login-input-group input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .login-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        
        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.3);
        }
        
        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .login-error {
            color: var(--warning);
            font-size: 0.85rem;
            margin-top: 5px;
            min-height: 20px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }
        
        .login-logo i {
            font-size: 36px;
            color: white;
        }
        
        .login-footer {
            margin-top: 25px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        
        .login-attempts {
            font-size: 0.75rem;
            color: var(--valuation);
            margin-top: 10px;
            font-weight: 500;
        }
        
        .locked-out {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* BACKUP PROGRESS MODAL */
        #backupProgressModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .backup-progress-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border-top: 4px solid var(--accent);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .backup-progress-container h3 {
            color: var(--accent);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--light-bg);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .backup-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            text-align: left;
        }
        
        .backup-stat {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .backup-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .backup-stat-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .backup-success {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }
        
        .backup-success i {
            color: var(--success);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        /* HIDE MAIN CONTENT BEFORE LOGIN */
        #mainContent {
            display: none;
            width: 100%;
            height: 100%;
        }
        
        /* SIDEBAR - White Theme */
        #sidebar { 
            width: var(--sidebar-width); 
            background: white; 
            color: var(--text-primary); 
            padding: 20px; 
            overflow-y: auto; 
            z-index: 2000; 
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        
        #map { 
            flex-grow: 1; 
            height: 100%; 
            z-index: 1; 
            background: #f0f2f5; 
            cursor: crosshair;
        }
        
        .status-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .indicator { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            letter-spacing: 0.5px;
        }
        
        .on { background: #e8f6ef; color: var(--success); border: 1px solid #d5f0e1; }
        .off { background: #fdeaea; color: var(--warning); border: 1px solid #f9d6d6; }
        .warning-ind { background: #fef9e7; color: var(--valuation); border: 1px solid #fcf3cf; }
        .firebase-ind { background: #fff3e0; color: var(--firebase); border: 1px solid #ffe0b2; }

        .panel { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: box-shadow 0.2s;
        }
        
        .panel:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .panel h3 {
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .cache-controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 10px; 
        }
        
        /* BUTTONS - Modern White Theme */
        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        button.warning { 
            background: var(--warning); 
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
        }
        
        button.success { 
            background: var(--success); 
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.2);
        }
        
        button.secondary { 
            background: #95a5a6; 
            box-shadow: 0 2px 4px rgba(149, 165, 166, 0.2);
        }
        
        button.point { 
            background: #8e44ad; 
            box-shadow: 0 2px 4px rgba(142, 68, 173, 0.2);
        }
        
        button.info { 
            background: #3498db; 
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);
        }
        
        button.firebase { 
            background: linear-gradient(135deg, #FFA611 0%, #F57C00 100%); 
            box-shadow: 0 2px 4px rgba(255, 166, 17, 0.3);
        }
        
        /* INPUTS & SELECTS - White Theme */
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 8px; 
            border: 1px solid var(--border);
            box-sizing: border-box;
            font-size: 0.9rem;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .small-input {
            font-size: 0.85rem !important;
            padding: 10px !important;
        }
        
        .property-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 10px 0;
        }
        
        .property-fields.full-width {
            grid-template-columns: 1fr;
        }
        
        .field-group {
            margin: 8px 0;
        }
        
        .field-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .required::after {
            content: " *";
            color: var(--warning);
        }
        
        .optional::after {
            content: " (Optional)";
            color: var(--text-secondary);
            font-size: 0.8em;
            font-weight: normal;
        }
        
        .registration-type-toggle {
            display: flex;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .registration-type-toggle button {
            flex: 1;
            border-radius: 0;
            padding: 12px;
            background: transparent;
            color: var(--text-secondary);
            box-shadow: none;
        }
        
        .registration-type-toggle button.active {
            background: var(--accent);
            color: white;
        }
        
        .location-toggle {
            display: flex;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .location-toggle button {
            flex: 1;
            border-radius: 0;
            padding: 12px;
            background: transparent;
            color: var(--text-secondary);
            box-shadow: none;
        }
        
        .location-toggle button.active {
            background: var(--accent);
            color: white;
        }
        
        .gps-status {
            padding: 15px;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
        }
        
        .gps-accuracy-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .gps-accuracy-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s, background 0.5s;
        }
        
        .gps-status-text {
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .table-container { 
            background: var(--light-bg); 
            border-radius: 8px; 
            overflow-x: auto; 
            max-height: 180px;
            font-size: 0.8rem; 
            flex-grow: 1;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        
        .log-container {
            background: var(--light-bg);
            border-radius: 8px;
            overflow-x: auto;
            max-height: 180px;
            font-size: 0.8rem;
            flex-grow: 1;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .log-header {
            padding: 12px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }
        
        .log-content {
            padding: 12px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .log-entry {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid var(--accent);
            font-size: 0.8rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .log-entry.success {
            border-left-color: var(--success);
            background: linear-gradient(to right, #e8f6ef 0%, white 100%);
        }
        
        .log-entry.warning {
            border-left-color: var(--valuation);
            background: linear-gradient(to right, #fef9e7 0%, white 100%);
        }
        
        .log-entry.error {
            border-left-color: var(--warning);
            background: linear-gradient(to right, #fdeaea 0%, white 100%);
        }
        
        .log-entry.firebase {
            border-left-color: var(--firebase);
            background: linear-gradient(to right, #fff3e0 0%, white 100%);
        }
        
        .log-entry.rejected {
            border-left-color: #e74c3c;
            background: linear-gradient(to right, #fdeaea 0%, white 100%);
            animation: pulse-rejected 2s infinite;
        }
        
        .log-entry.notification {
            border-left-color: #9b59b6;
            background: linear-gradient(to right, #f4ecf7 0%, white 100%);
        }
        
        @keyframes pulse-rejected {
            0%, 100% { box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
            50% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }
        }
        
        .log-time {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .log-message {
            color: var(--text-primary);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        th, td { 
            padding: 10px 12px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
        }
        
        th {
            background: white;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover { 
            background: rgba(52, 152, 219, 0.05); 
            cursor: pointer; 
        }
        
        .preview-panel {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .preview-panel h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.9rem;
        }
        
        .preview-item {
            margin-bottom: 8px;
        }
        
        .preview-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .preview-value {
            color: var(--text-primary);
            word-break: break-word;
        }
        
        .evidence-container {
            margin: 15px 0;
        }
        
        .camera-btn {
            width: 100%;
            margin: 5px 0;
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%) !important;
            color: white;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #coordinates {
            font-size: 0.85rem;
            color: var(--text-primary);
            text-align: center;
            padding: 12px;
            background: var(--light-bg);
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid var(--border);
            font-weight: 500;
        }
        
        @media (max-width: 768px) { 
            body { flex-direction: column; } 
            #sidebar { width: 100%; height: 50%; } 
            #map { height: 50%; } 
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-controls button {
            background: white;
            color: var(--primary);
            border-radius: 8px;
            padding: 12px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid var(--border);
            width: 45px;
            height: 45px;
        }
        
        .manual-marker {
            background: none;
            border: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .gps-accuracy-threshold {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }
        
        .auto-center-control {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .auto-center-control button {
            background: white;
            color: var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid var(--border);
        }
        
        .auto-center-control button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .storage-status {
            padding: 15px;
            margin: 15px 0;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }
        
        .storage-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .storage-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(90deg, #27ae60, #f39c12);
            transition: width 0.5s;
        }
        
        .storage-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .storage-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .modal h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-backup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .section-title {
            color: var(--primary);
            font-size: 0.95rem;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light-bg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Danger confirmation modal styles */
        .danger-confirmation {
            z-index: 5000;
        }
        
        .danger-modal {
            background: white;
            border: 2px solid #e74c3c;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.15);
            animation: danger-pulse 2s infinite;
        }
        
        @keyframes danger-pulse {
            0% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.15); }
            50% { box-shadow: 0 0 40px rgba(231, 76, 60, 0.25); }
            100% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.15); }
        }
        
        .danger-modal h3 {
            color: #e74c3c !important;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
            text-align: center;
        }
        
        .danger-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            color: white !important;
            font-weight: 600 !important;
            border: none !important;
        }
        
        .danger-btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important;
        }
        
        /* User info in status bar */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            background: rgba(52, 152, 219, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            color: var(--accent);
            font-weight: 500;
        }
        
        .logout-btn {
            background: transparent !important;
            color: #e74c3c !important;
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
            border: 1px solid #e74c3c !important;
            box-shadow: none !important;
        }
        
        .logout-btn:hover {
            background: #e74c3c !important;
            color: white !important;
        }
        
        /* Auto-backup notification */
        .auto-backup-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 4000;
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideUp 0.3s ease-out;
            border: none;
        }
        
        .firebase-sync-notification {
            background: linear-gradient(135deg, var(--firebase) 0%, #F57C00 100%) !important;
        }
        
        .rejection-notification {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            z-index: 4001;
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .auto-backup-notification i {
            font-size: 1.2rem;
        }
        
        .auto-backup-notification span {
            font-weight: 600;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Leaflet map controls - White theme */
        .leaflet-control-zoom {
            border: 1px solid var(--border) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            border-radius: 8px !important;
            overflow: hidden;
        }
        
        .leaflet-control-zoom a {
            background: white !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--border) !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: var(--light-bg) !important;
        }
        
        .leaflet-control-attribution {
            background: rgba(255, 255, 255, 0.9) !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
        }
        
        /* Toggle switch for manual entry */
        .manual-entry-toggle {
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        .toggle-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
        }
        
        .toggle-link:hover {
            color: #2980b9;
        }
        
        /* Sync status indicator */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .sync-pending { background: #fff3cd; color: #856404; }
        .sync-synced { background: #d4edda; color: #155724; }
        .sync-failed { background: #f8d7da; color: #721c24; }
        .sync-queued { background: #cce5ff; color: #004085; }
        
        /* Firebase status panel */
        .firebase-status {
            padding: 12px;
            margin: 10px 0;
            background: #fff3e0;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid #ffe0b2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .firebase-status.online {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }
        
        .firebase-status.offline {
            background: #ffebee;
            border-color: #ffcdd2;
        }
        
        .firebase-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .firebase-stat {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .firebase-stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .firebase-stat-value {
            font-size: 1rem;
            color: var(--firebase);
            font-weight: 600;
        }
        
        /* Rejection feedback styles */
        .rejection-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 350px;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            z-index: 4002;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .rejection-feedback h4 {
            color: #e74c3c;
            margin: 0 0 10px 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rejection-content {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
        }
        
        .rejection-property-id {
            background: #fdeaea;
            padding: 8px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
            color: #e74c3c;
        }
        
        .rejection-reason {
            background: #fef9e7;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid #f39c12;
        }
        
        .rejection-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Data Collector Notification Styles */
        .collector-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            width: 350px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            overflow: hidden;
            animation: slideInRight 0.3s ease;
            border-left: 5px solid var(--warning);
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        
        .collector-notification.approval {
            border-left-color: var(--success);
        }
        
        .collector-notification-header {
            padding: 15px;
            background: var(--light-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .collector-notification-body {
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-primary);
        }
        
        .collector-notification-footer {
            padding: 10px 15px;
            background: var(--light-bg);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Notification badge */
        .notification-badge {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .notification-icon-btn {
            background: transparent !important;
            color: var(--accent) !important;
            box-shadow: none !important;
            padding: 8px !important;
            width: 40px !important;
            height: 40px !important;
        }
        
        .notification-icon-btn:hover {
            background: rgba(52, 152, 219, 0.1) !important;
        }
        
        .notification-icon-btn.has-notifications {
            color: #e74c3c !important;
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>

<!-- LOGIN MODAL (MANDATORY) -->
<div id="loginModal">
    <div class="login-container">
        <div class="login-logo">
            <i class="fa-solid fa-map-location-dot"></i>
        </div>
        
        <h2><i class="fa-solid fa-lock"></i> LAVMIS ACCESS</h2>
        
        <div class="login-input-group">
            <label for="username"><i class="fa-solid fa-user"></i> EMAIL</label>
            <input type="email" id="username" placeholder="Enter your email" autocomplete="username" required>
        </div>
        
        <div class="login-input-group">
            <label for="password"><i class="fa-solid fa-key"></i> PASSWORD</label>
            <input type="password" id="password" placeholder="Enter password" autocomplete="current-password" required>
        </div>
        
        <div class="login-error" id="loginError"></div>
        
        <div class="login-attempts" id="loginAttempts">
            Attempts remaining: 5
        </div>
        
        <button class="login-button" id="loginButton" onclick="attemptLogin()">
            <i class="fa-solid fa-right-to-bracket"></i> LOGIN TO LAVMIS
        </button>
        
        <div class="login-footer">
            <p><i class="fa-solid fa-triangle-exclamation"></i> Authorized Personnel Only</p>
            <p style="font-size: 0.7rem; color: #7f8c8d;">District Valuation & Market Analysis System</p>
            <p style="font-size: 0.7rem; color: #FFA611; margin-top: 5px;">
                <i class="fa-solid fa-cloud"></i> Firebase Cloud Sync Enabled
            </p>
        </div>
    </div>
</div>

<!-- BACKUP PROGRESS MODAL -->
<div id="backupProgressModal">
    <div class="backup-progress-container">
        <h3><i class="fa-solid fa-download"></i> CREATING BACKUP</h3>
        
        <div class="progress-bar">
            <div class="progress-fill" id="backupProgressFill"></div>
        </div>
        
        <div class="progress-text" id="backupProgressText">Preparing backup...</div>
        
        <div class="backup-stats">
            <div class="backup-stat">
                <div class="backup-stat-label">Records to backup</div>
                <div class="backup-stat-value" id="backupRecordCount">0</div>
            </div>
            <div class="backup-stat">
                <div class="backup-stat-label">Backup Size</div>
                <div class="backup-stat-value" id="backupSize">0 MB</div>
            </div>
        </div>
        
        <div class="backup-success" id="backupSuccess">
            <i class="fa-solid fa-check-circle"></i>
            <div style="font-weight: bold; margin-bottom: 5px;">Backup Completed Successfully!</div>
            <div style="font-size: 0.8rem;" id="backupFileName">Backup file has been saved</div>
        </div>
        
        <div style="margin-top: 20px;">
            <button id="continueLogoutBtn" class="success" onclick="finishLogout()" style="display: none; width: 100%;">
                <i class="fa-solid fa-right-from-bracket"></i> Continue with Logout
            </button>
            <button id="cancelBackupBtn" class="secondary" onclick="cancelBackup()" style="width: 100%;">
                <i class="fa-solid fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- AUTO-BACKUP NOTIFICATION -->
<div class="auto-backup-notification" id="autoBackupNotification">
    <i class="fa-solid fa-shield-alt"></i>
    <div>
        <span>Auto-backup in progress...</span>
        <div style="font-size: 0.8rem; opacity: 0.9;">Data is being backed up before logout</div>
    </div>
</div>

<!-- FIREBASE SYNC NOTIFICATION -->
<div class="auto-backup-notification firebase-sync-notification" id="firebaseSyncNotification">
    <i class="fa-solid fa-cloud-upload-alt"></i>
    <div>
        <span id="firebaseSyncMessage">Firebase sync in progress...</span>
        <div style="font-size: 0.8rem; opacity: 0.9;" id="firebaseSyncDetails">Syncing data to cloud</div>
    </div>
</div>

<!-- REJECTION FEEDBACK NOTIFICATION -->
<div class="auto-backup-notification rejection-notification" id="rejectionNotification" style="display: none;">
    <i class="fa-solid fa-exclamation-triangle"></i>
    <div>
        <span id="rejectionNotificationTitle">Submission Rejected</span>
        <div style="font-size: 0.8rem; opacity: 0.9;" id="rejectionNotificationDetails">Click to view details</div>
    </div>
</div>

<!-- REJECTION FEEDBACK MODAL -->
<div class="rejection-feedback" id="rejectionFeedback">
    <h4><i class="fa-solid fa-exclamation-triangle"></i> SUBMISSION REJECTED</h4>
    <div class="rejection-content">
        <div class="rejection-property-id" id="rejectionPropertyId">PRO-001</div>
        <p><strong>Reason for rejection:</strong></p>
        <div class="rejection-reason" id="rejectionReasonText">Your submission was rejected due to incomplete information.</div>
        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
            <i class="fa-solid fa-lightbulb"></i> Please review the feedback and resubmit with corrections.
        </p>
    </div>
    <div class="rejection-actions">
        <button onclick="hideRejectionFeedback()" class="secondary" style="flex: 1;">
            <i class="fa-solid fa-times"></i> Dismiss
        </button>
        <button onclick="loadRejectedPropertyIntoForm()" class="warning" style="flex: 1;">
            <i class="fa-solid fa-edit"></i> Edit & Resubmit
        </button>
    </div>
</div>

<!-- MAIN CONTENT (HIDDEN UNTIL LOGIN) -->
<div id="mainContent">
    <div id="sidebar">
        <div class="status-bar">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="net-label" class="indicator on">ONLINE</span>
                <span id="firebase-status-ind" class="indicator firebase-ind" style="display: none;">
                    <i class="fa-solid fa-cloud"></i> FIREBASE
                </span>
                <div class="user-info" id="userInfo">
                    <i class="fa-solid fa-user-check"></i>
                    <span id="loggedInUser">User</span>
                    <button class="logout-btn" onclick="initiateLogout()" title="Logout" id="logoutBtn">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
                <!-- Notification button -->
                <div class="notification-badge" id="notificationBadge" style="display: none;">
                    <button class="notification-icon-btn" onclick="showAllNotifications()" id="notificationButton" title="Notifications">
                        <i class="fa-solid fa-bell"></i>
                        <span class="notification-count" id="notificationCount">0</span>
                    </button>
                </div>
            </div>
            <span style="font-size: 1.2rem; font-weight: bold; color: var(--valuation);">LAVMIS DATA COLLECTOR MODULE</span>
        </div>

        <!-- Firebase Status Panel -->
        <div class="panel" id="firebaseStatusPanel" style="display: none;">
            <h3><i class="fa-solid fa-fire"></i> Firebase Cloud Status</h3>
            
            <div class="firebase-status" id="firebaseConnectionStatus">
                <i class="fa-solid fa-cloud"></i>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 600; font-size: 0.9rem;" id="firebaseStatusText">Connecting to Firebase...</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);" id="firebaseStatusDetail">
                        Syncing with cloud database
                    </div>
                </div>
            </div>
            
            <div class="firebase-stats">
                <div class="firebase-stat">
                    <div class="firebase-stat-label">Synced Records</div>
                    <div class="firebase-stat-value" id="syncedRecords">0</div>
                </div>
                <div class="firebase-stat">
                    <div class="firebase-stat-label">Pending Sync</div>
                    <div class="firebase-stat-value" id="pendingSync">0</div>
                </div>
            </div>
            
            <button onclick="syncAllToFirebase()" class="firebase" style="width: 100%; margin-top: 10px;">
                <i class="fa-solid fa-cloud-arrow-up"></i> Sync All to Firebase
            </button>
        </div>

        <div class="panel">
            <h3><i class="fa-solid fa-map"></i> Offline Map Cache</h3>
            <p style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">Zoom into your project area while online, then click "Cache Visible Area" to save imagery for offline use.</p>
            <div class="cache-controls">
                <button onclick="cacheTiles()" style="background: var(--valuation); color: white;">
                    <i class="fa-solid fa-download"></i> Cache Area
                </button>
                <button onclick="clearCache()" class="secondary">
                    <i class="fa-solid fa-trash"></i> Clear Map
                </button>
            </div>
            <div id="cache-status" style="font-size: 0.8rem; margin-top: 10px; color: var(--text-secondary);">
                <i class="fa-solid fa-hard-drive"></i> Storage Used: Calculating...
            </div>
        </div>

        <div class="panel">
            <h3><i class="fa-solid fa-location-crosshairs"></i> Data Capture</h3>
            
            <div class="section-title">
                <i class="fa-solid fa-id-card"></i> Property Information
            </div>
            
            <div class="property-fields">
                <div class="field-group">
                    <label for="propertyId" class="required">Property ID</label>
                    <input type="text" id="propertyId" placeholder="Auto-generated" class="small-input" readonly>
                    <span id="propertySyncStatus" class="sync-status" style="display: none;"></span>
                </div>
                <div class="field-group">
                    <label for="propertyName" class="optional">Property Name</label>
                    <input type="text" id="propertyName" placeholder="Enter Property Name (Optional)" class="small-input">
                </div>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-file-signature"></i> Registration Type
            </div>
            
            <div class="registration-type-toggle" id="registrationTypeToggle">
                <button id="titledToggle" class="active" onclick="setRegistrationType('titled')">
                    <i class="fa-solid fa-file-contract"></i> Titled
                </button>
                <button id="untitledToggle" onclick="setRegistrationType('untitled')">
                    <i class="fa-solid fa-file-alt"></i> Untitled
                </button>
            </div>
            
            <div class="property-fields" id="titleFields">
                <div class="field-group">
                    <label for="plotNumber">Plot Number</label>
                    <input type="text" id="plotNumber" placeholder="Enter Plot Number" class="small-input">
                </div>
                <div class="field-group">
                    <label for="blockNumber">Block Number</label>
                    <input type="text" id="blockNumber" placeholder="Enter Block Number" class="small-input">
                </div>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-location-dot"></i> Location Information
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="districtCity" class="required">District/City</label>
                    <select id="districtCity" class="small-input" onchange="updateSubcounties()">
                        <option value="">Select District/City</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('districtCity')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="districtCityManual" placeholder="Type District/City manually" class="small-input" style="display: none;">
                </div>
            </div>
            
            <div class="property-fields">
                <div class="field-group">
                    <label for="subcounty" class="required">Subcounty</label>
                    <select id="subcounty" class="small-input" onchange="updateParishes()" disabled>
                        <option value="">Select Subcounty</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('subcounty')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="subcountyManual" placeholder="Type Subcounty manually" class="small-input" style="display: none;">
                </div>
                <div class="field-group">
                    <label for="parish" class="required">Parish</label>
                    <select id="parish" class="small-input" onchange="updateVillages()" disabled>
                        <option value="">Select Parish</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('parish')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="parishManual" placeholder="Type Parish manually" class="small-input" style="display: none;">
                </div>
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="village" class="required">Village</label>
                    <select id="village" class="small-input" disabled>
                        <option value="">Select Village</option>
                    </select>
                    <div class="manual-entry-toggle">
                        <span class="toggle-link" onclick="toggleManualEntry('village')">Not in list? Type manually</span>
                    </div>
                    <input type="text" id="villageManual" placeholder="Type Village manually" class="small-input" style="display: none;">
                </div>
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="description" class="optional">Description/Remarks</label>
                    <textarea id="description" placeholder="Enter any remarks or description about the property" rows="3" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: white; color: var(--text-primary); font-size: 0.9rem; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="dataSource" class="required">Data Source</label>
                    <select id="dataSource" class="small-input">
                        <option value="">Select Data Source</option>
                        <option value="Field Survey">Field Survey</option>
                        <option value="Land Registry">Land Registry</option>
                        <option value="Local Government">Local Government</option>
                        <option value="Property Owner">Property Owner</option>
                        <option value="Real Estate Agent">Real Estate Agent</option>
                        <option value="Community Leader">Community Leader</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-chart-line"></i> Location & Valuation
            </div>
            
            <div class="location-toggle">
                <button id="gpsToggle" class="active" onclick="setLocationMode('gps')">
                    <i class="fa-solid fa-satellite"></i> GPS Auto
                </button>
                <button id="manualToggle" onclick="setLocationMode('manual')">
                    <i class="fa-solid fa-map-pin"></i> Map Point
                </button>
            </div>
            
            <div class="gps-status">
                <i class="fa-solid fa-satellite" id="gpsIcon" style="color: var(--accent); font-size: 1.2rem;"></i>
                <div style="flex-grow: 1;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 500;">
                        <span id="gpsStatusText">Acquiring GPS...</span>
                        <span id="gpsAccuracy" style="color: var(--primary);">-- m</span>
                    </div>
                    <div class="gps-accuracy-bar">
                        <div id="gpsAccuracyFill" class="gps-accuracy-fill" style="width: 0%; background: #e74c3c;"></div>
                    </div>
                    <div class="gps-status-text" id="gpsStatusDetail">
                        Need 3-20m accuracy to save data
                    </div>
                </div>
            </div>
            
            <div id="coordinates">Waiting for GPS...</div>
            
            <div style="margin: 15px 0;">
                <button onclick="clearManualPoint()" class="secondary" style="width: 100%;" id="clearPointBtn" disabled>
                    <i class="fa-solid fa-trash"></i> Clear Selected Point
                </button>
            </div>
            
            <div class="property-fields">
                <div class="field-group">
                    <label for="price" class="required">Total Price ($)</label>
                    <input type="number" id="price" placeholder="Total Price" step="0.01">
                </div>
                <div class="field-group">
                    <label for="size" class="required">Size (Ha)</label>
                    <input type="number" id="size" placeholder="Size (Ha)" step="0.01">
                </div>
            </div>
            
            <div class="field-group">
                <label for="use" class="required">Land Use</label>
                <select id="use">
                    <option value="">Select Land Use</option>
                    <option>Residential</option>
                    <option>Commercial</option>
                    <option>Agricultural</option>
                    <option>Industrial</option>
                    <option>Recreational</option>
                    <option>Mixed Use</option>
                    <option>Vacant Land</option>
                    <option>Forest</option>
                    <option>Wetland</option>
                </select>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-camera"></i> Evidence
            </div>
            
            <div class="evidence-container">
                <button class="camera-btn" onclick="capturePhoto()">
                    <i class="fa-solid fa-camera"></i> ADD EVIDENCE PHOTO (Optional)
                </button>
                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoUpload(event)">
                <img id="imagePreview" class="image-preview" alt="Evidence Preview">
                <button id="removePhotoBtn" class="warning" onclick="removePhoto()" style="display: none; width: 100%; margin-top: 10px;">
                    <i class="fa-solid fa-trash"></i> Remove Photo
                </button>
            </div>
            
            <div class="section-title">
                <i class="fa-solid fa-user-tie"></i> Data Collector Information
            </div>
            
            <div class="property-fields full-width">
                <div class="field-group">
                    <label for="officerName" class="required">Name of Officer (Data Collector)</label>
                    <input type="text" id="officerName" placeholder="Enter your full name">
                </div>
            </div>
            
            <button id="saveBtn" onclick="saveData()" class="success" style="width: 100%; margin-top: 15px; padding: 14px;" disabled>
                <i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD
            </button>
        </div>

        <div class="panel">
            <h3><i class="fa-solid fa-database"></i> Storage Status</h3>
            
            <div class="firebase-status" id="syncStatusInfo" style="display: none;">
                <i class="fa-solid fa-cloud"></i>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 600; font-size: 0.9rem;">Cloud Sync Status</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                        <span id="syncStatusText">Checking sync status...</span>
                    </div>
                </div>
            </div>
            
            <div class="storage-status">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: 500;">
                    <span>Local Data Usage</span>
                    <span id="recordCount">0 records</span>
                </div>
                <div class="storage-bar">
                    <div id="storageFill" class="storage-fill" style="width: 0%"></div>
                </div>
                <div class="storage-info">
                    <span id="storageUsed">0 MB</span>
                    <span id="storageTotal">Calculating...</span>
                </div>
            </div>
            
            <div class="storage-actions">
                <button onclick="showBackupModal()" class="info">
                    <i class="fa-solid fa-download"></i> Backup
                </button>
                <button onclick="showRestoreModal()" class="secondary">
                    <i class="fa-solid fa-upload"></i> Restore
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <button onclick="syncAllToFirebase()" class="firebase">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Sync Cloud
                </button>
                <button onclick="restoreFromFirebase()" class="warning">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Restore Cloud
                </button>
            </div>
            
            <button onclick="clearAllData()" class="warning" style="width: 100%; margin-top: 15px;">
                <i class="fa-solid fa-trash"></i> Clear All Data
            </button>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Property ID</th>
                        <th>Name</th>
                        <th>Plot No.</th>
                        <th>Rate/Ha</th>
                        <th>Sync</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="log-container">
            <div class="log-header">
                <h4 style="margin: 0; font-size: 1rem;"><i class="fa-solid fa-clipboard-list"></i> Activity Log</h4>
                <button onclick="clearLog()" class="secondary" style="padding: 6px 10px; font-size: 0.8rem;">
                    <i class="fa-solid fa-trash"></i> Clear
                </button>
            </div>
            <div class="log-content" id="logContent">
                <!-- Log entries will be added here -->
            </div>
        </div>
        
        <div id="dataPreview" class="preview-panel">
            <h4><i class="fa-solid fa-eye"></i> PROPERTY RECORD PREVIEW</h4>
            <div class="preview-grid" id="previewContent">
                <!-- Preview content will be injected here -->
            </div>
            <button onclick="hidePreview()" class="secondary" style="width: 100%; margin-top: 15px;">
                <i class="fa-solid fa-times"></i> Close Preview
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
            <button onclick="exportData()" class="success">
                <i class="fa-solid fa-file-excel"></i> Export Excel
            </button>
            <button onclick="exportGeoJSON()" class="info">
                <i class="fa-solid fa-globe"></i> Export GeoJSON
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div class="gps-accuracy-threshold" id="accuracyThreshold">
        <i class="fa-solid fa-bullseye"></i> GPS Accuracy: 3-20m required
    </div>

    <div class="auto-center-control">
        <button id="autoCenterToggle" onclick="toggleAutoCenter()" title="Auto-center on GPS">
            <i class="fa-solid fa-location-crosshairs"></i>
        </button>
    </div>

    <div class="map-controls">
        <button onclick="centerOnGPS()" title="Center on GPS" id="centerGPSBtn">
            <i class="fa-solid fa-location-arrow"></i>
        </button>
        <button onclick="clearAllMarkers()" class="warning" title="Clear all markers">
            <i class="fa-solid fa-trash"></i>
        </button>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal-overlay">
        <div class="modal">
            <h3><i class="fa-solid fa-download"></i> Data Backup</h3>
            <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5;">Backup your data to a file or to Firebase Cloud.</p>
            
            <div class="data-backup">
                <button onclick="backupData('json')" class="info">
                    <i class="fa-solid fa-code"></i> Backup as JSON
                </button>
                <button onclick="backupData('csv')" class="success">
                    <i class="fa-solid fa-file-csv"></i> Backup as CSV
                </button>
                <button onclick="backupToFirebase()" class="firebase" style="grid-column: span 2;">
                    <i class="fa-solid fa-cloud-upload-alt"></i> Backup to Firebase
                </button>
            </div>
            
            <div style="margin-top: 20px;">
                <h4 style="font-size: 1rem;"><i class="fa-solid fa-file-export"></i> Export Formats</h4>
                <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5;">
                    <p><strong>JSON</strong>: Full data including photos (base64 encoded)</p>
                    <p><strong>CSV</strong>: Tabular data only (photos excluded)</p>
                    <p><strong>Firebase</strong>: Cloud backup with real-time sync</p>
                </div>
            </div>
            
            <button onclick="hideModal()" class="secondary" style="width: 100%; margin-top: 20px;">
                <i class="fa-solid fa-times"></i> Close
            </button>
        </div>
    </div>

    <!-- Restore Modal -->
    <div id="restoreModal" class="modal-overlay">
        <div class="modal">
            <h3><i class="fa-solid fa-upload"></i> Data Restore</h3>
            <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5;">Restore data from a previously created backup file or from Firebase Cloud.</p>
            
            <div style="margin: 20px 0;">
                <input type="file" id="restoreFile" accept=".json,.csv" style="width: 100%; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
                <button onclick="restoreData()" class="success" style="width: 100%; margin-top: 15px;">
                    <i class="fa-solid fa-upload"></i> Restore from File
                </button>
            </div>
            
            <div style="margin: 20px 0;">
                <button onclick="restoreFromFirebase()" class="firebase" style="width: 100%;">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Restore from Firebase
                </button>
            </div>
            
            <div style="background: #fef9e7; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #fcf3cf;">
                <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #f39c12;">
                    <i class="fa-solid fa-triangle-exclamation"></i> Warning
                </h4>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                    Restoring data will replace all existing records. Make sure you have a current backup before proceeding.
                </p>
            </div>
            
            <button onclick="hideModal()" class="secondary" style="width: 100%; margin-top: 20px;">
                <i class="fa-solid fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
<script src="https://unpkg.com/leaflet.tilelayer.pouchdbcached@1.0.0/L.TileLayer.PouchDBCached.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script>
    // ==============================================
    // GLOBAL VARIABLES
    // ==============================================
    let loginSystem = null;
    let map = null;
    let savedLayer = null;
    let liveLayer = null;
    let manualLayer = null;
    let accuracyLayer = null;
    let locationMode = 'gps';
    let registrationType = 'titled';
    let currentPos = null;
    let currentAccuracy = null;
    let manualPos = null;
    let evidencePhoto = null;
    let manualMarker = null;
    let isManualModeActive = false;
    let autoCenterEnabled = true;
    let gpsWatchId = null;
    let lastGpsUpdate = null;
    let logger = null;
    let storageManager = null;
    let satellite = null;
    let propertyIdCounter = 1;
    let firebaseDataManager = null;
    let firebaseApp = null;
    let firebaseDb = null;
    let firebaseAuth = null;
    let firebaseStorage = null;
    let currentFirebaseUser = null;
    let rejectionListener = null;
    let currentRejection = null;
    let notificationListener = null;
    let unreadNotifications = [];
    let notificationCount = 0;
    let currentlyEditingRecordId = null; // Track which record is being edited for resubmission

    // ==============================================
    // FIREBASE CONFIGURATION
    // ==============================================
    const firebaseConfig = {
        apiKey: "AIzaSyA944hBt8QoOLeRKPoRrl2RemV9vlBc6ug",
        authDomain: "lavmis-1410e.firebaseapp.com",
        projectId: "lavmis-1410e",
        storageBucket: "lavmis-1410e.firebasestorage.app",
        messagingSenderId: "710897502113",
        appId: "1:710897502113:web:e5bfefc423af1b51632de0",
        measurementId: "G-ZWTN2R2RB2"
    };

    // ==============================================
    // EMBEDDED GEOGRAPHICAL DATA FROM JSON
    // ==============================================
    const geographicalData = [
        {
            "DISTRICT/CITY": "MUKONO",
            "SUBCOUNTY": "01 KOOME ISLANDS",
            "PARISH": "01 BUGOMBE",
            "VILLAGES": "01 BUGAZI"
        },
        {
            "DISTRICT/CITY": "MUKONO",
            "SUBCOUNTY": "07 KASAWO TOWN COUNCIL",
            "PARISH": "01 KABIMBIRI A WARD",
            "VILLAGES": "08 SINDA/KIVULUBA"
        }
    ];
    
    // Extract unique values from the geographical data
    const districts = [...new Set(geographicalData.map(item => item["DISTRICT/CITY"]))];
    
    // Function to get subcounties for a district
    function getSubcountiesForDistrict(district) {
        return [...new Set(geographicalData
            .filter(item => item["DISTRICT/CITY"] === district)
            .map(item => item.SUBCOUNTY)
            .sort())];
    }
    
    // Function to get parishes for a subcounty
    function getParishesForSubcounty(district, subcounty) {
        return [...new Set(geographicalData
            .filter(item => item["DISTRICT/CITY"] === district && item.SUBCOUNTY === subcounty)
            .map(item => item.PARISH)
            .sort())];
    }
    
    // Function to get villages for a parish
    function getVillagesForParish(district, subcounty, parish) {
        return [...new Set(geographicalData
            .filter(item => item["DISTRICT/CITY"] === district && 
                           item.SUBCOUNTY === subcounty && 
                           item.PARISH === parish)
            .map(item => item.VILLAGES)
            .sort())];
    }
    
    // ==============================================
    // GEOGRAPHICAL DATA DROPDOWN FUNCTIONS
    // ==============================================
    function initializeGeographicalDropdowns() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        // Clear existing options
        districtSelect.innerHTML = '<option value="">Select District/City</option>';
        subcountySelect.innerHTML = '<option value="">Select Subcounty</option>';
        parishSelect.innerHTML = '<option value="">Select Parish</option>';
        villageSelect.innerHTML = '<option value="">Select Village</option>';
        
        // Populate districts
        districts.forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            districtSelect.appendChild(option);
        });
        
        // Disable dependent dropdowns initially
        subcountySelect.disabled = true;
        parishSelect.disabled = true;
        villageSelect.disabled = true;
    }
    
    function updateSubcounties() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        const selectedDistrict = districtSelect.value;
        
        if (!selectedDistrict) {
            subcountySelect.disabled = true;
            parishSelect.disabled = true;
            villageSelect.disabled = true;
            
            subcountySelect.innerHTML = '<option value="">Select Subcounty</option>';
            parishSelect.innerHTML = '<option value="">Select Parish</option>';
            villageSelect.innerHTML = '<option value="">Select Village</option>';
            return;
        }
        
        // Enable subcounty dropdown
        subcountySelect.disabled = false;
        
        // Clear and populate subcounties
        subcountySelect.innerHTML = '<option value="">Select Subcounty</option>';
        const subcounties = getSubcountiesForDistrict(selectedDistrict);
        
        subcounties.forEach(subcounty => {
            const option = document.createElement('option');
            option.value = subcounty;
            option.textContent = subcounty;
            subcountySelect.appendChild(option);
        });
        
        // Clear parish and village dropdowns
        parishSelect.disabled = true;
        villageSelect.disabled = true;
        parishSelect.innerHTML = '<option value="">Select Parish</option>';
        villageSelect.innerHTML = '<option value="">Select Village</option>';
    }
    
    function updateParishes() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        const selectedDistrict = districtSelect.value;
        const selectedSubcounty = subcountySelect.value;
        
        if (!selectedDistrict || !selectedSubcounty) {
            parishSelect.disabled = true;
            villageSelect.disabled = true;
            
            parishSelect.innerHTML = '<option value="">Select Parish</option>';
            villageSelect.innerHTML = '<option value="">Select Village</option>';
            return;
        }
        
        // Enable parish dropdown
        parishSelect.disabled = false;
        
        // Clear and populate parishes
        parishSelect.innerHTML = '<option value="">Select Parish</option>';
        const parishes = getParishesForSubcounty(selectedDistrict, selectedSubcounty);
        
        parishes.forEach(parish => {
            const option = document.createElement('option');
            option.value = parish;
            option.textContent = parish;
            parishSelect.appendChild(option);
        });
        
        // Clear village dropdown
        villageSelect.disabled = true;
        villageSelect.innerHTML = '<option value="">Select Village</option>';
    }
    
    function updateVillages() {
        const districtSelect = document.getElementById('districtCity');
        const subcountySelect = document.getElementById('subcounty');
        const parishSelect = document.getElementById('parish');
        const villageSelect = document.getElementById('village');
        
        const selectedDistrict = districtSelect.value;
        const selectedSubcounty = subcountySelect.value;
        const selectedParish = parishSelect.value;
        
        if (!selectedDistrict || !selectedSubcounty || !selectedParish) {
            villageSelect.disabled = true;
            villageSelect.innerHTML = '<option value="">Select Village</option>';
            return;
        }
        
        // Enable village dropdown
        villageSelect.disabled = false;
        
        // Clear and populate villages
        villageSelect.innerHTML = '<option value="">Select Village</option>';
        const villages = getVillagesForParish(selectedDistrict, selectedSubcounty, selectedParish);
        
        villages.forEach(village => {
            const option = document.createElement('option');
            option.value = village;
            option.textContent = village;
            villageSelect.appendChild(option);
        });
    }

    // ==============================================
    // REGISTRATION TYPE FUNCTIONS
    // ==============================================
    function setRegistrationType(type) {
        registrationType = type;
        
        // Update toggle buttons
        document.getElementById('titledToggle').classList.toggle('active', type === 'titled');
        document.getElementById('untitledToggle').classList.toggle('active', type === 'untitled');
        
        // Enable/disable title fields
        const titleFields = document.getElementById('titleFields');
        const plotNumberInput = document.getElementById('plotNumber');
        const blockNumberInput = document.getElementById('blockNumber');
        
        if (type === 'titled') {
            titleFields.style.display = 'grid';
            plotNumberInput.disabled = false;
            blockNumberInput.disabled = false;
            plotNumberInput.required = true;
            blockNumberInput.required = true;
        } else {
            titleFields.style.display = 'none';
            plotNumberInput.disabled = true;
            blockNumberInput.disabled = true;
            plotNumberInput.required = false;
            blockNumberInput.required = false;
            plotNumberInput.value = '';
            blockNumberInput.value = '';
        }
        
        logger.addLogEntry(`Registration type set to: ${type}`, "info");
    }
    
    // ==============================================
    // MANUAL ENTRY TOGGLE FUNCTIONS
    // ==============================================
    function toggleManualEntry(fieldType) {
        const selectElement = document.getElementById(fieldType);
        const manualInput = document.getElementById(fieldType + 'Manual');
        
        if (selectElement.style.display === 'none') {
            // Switch back to dropdown
            selectElement.style.display = 'block';
            manualInput.style.display = 'none';
            selectElement.disabled = false;
            
            // Clear manual input
            manualInput.value = '';
            
            // Update dependent dropdowns
            if (fieldType === 'districtCity') {
                updateSubcounties();
            } else if (fieldType === 'subcounty') {
                updateParishes();
            } else if (fieldType === 'parish') {
                updateVillages();
            }
        } else {
            // Switch to manual input
            selectElement.style.display = 'none';
            manualInput.style.display = 'block';
            selectElement.disabled = true;
            
            // Clear dropdown selection
            selectElement.value = '';
            
            // Update dependent dropdowns
            if (fieldType === 'districtCity') {
                document.getElementById('subcounty').disabled = true;
                document.getElementById('subcounty').value = '';
                document.getElementById('parish').disabled = true;
                document.getElementById('parish').value = '';
                document.getElementById('village').disabled = true;
                document.getElementById('village').value = '';
            } else if (fieldType === 'subcounty') {
                document.getElementById('parish').disabled = true;
                document.getElementById('parish').value = '';
                document.getElementById('village').disabled = true;
                document.getElementById('village').value = '';
            } else if (fieldType === 'parish') {
                document.getElementById('village').disabled = true;
                document.getElementById('village').value = '';
            }
        }
    }
    
    // ==============================================
    // PROPERTY ID GENERATION
    // ==============================================
    function generatePropertyId() {
        // Get the highest property ID from existing records
        const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        let maxId = 0;
        
        db.forEach(record => {
            // Extract numeric part from Property ID (assuming format like PRO-001, PRO-123, etc.)
            const idMatch = record.propertyId.match(/PRO-(\d+)/);
            if (idMatch) {
                const idNum = parseInt(idMatch[1]);
                if (idNum > maxId) {
                    maxId = idNum;
                }
            }
        });
        
        // Start from maxId + 1, or 1 if no records exist
        propertyIdCounter = maxId + 1;
        
        // Generate new ID
        const newId = `PRO-${propertyIdCounter.toString().padStart(3, '0')}`;
        document.getElementById('propertyId').value = newId;
        propertyIdCounter++;
    }

    // ==============================================
    // DATA COLLECTOR NOTIFICATION SYSTEM
    // ==============================================
    function setupDataCollectorNotifications() {
        if (!firebaseDataManager || !firebaseDataManager.userEmail) {
            console.log('Cannot setup notifications: User not authenticated');
            return;
        }
        
        // Clear any existing listener
        if (notificationListener) {
            notificationListener();
        }
        
        const userEmail = firebaseDataManager.userEmail;
        console.log('Setting up notifications for:', userEmail);
        
        // Listen for notifications for the current user
        notificationListener = firebaseDb.collection('notifications')
            .where('recipientEmail', '==', userEmail)
            .where('read', '==', false)
            .orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const notification = change.doc.data();
                        const notificationId = change.doc.id;
                        
                        // Add to unread notifications
                        unreadNotifications.push({
                            id: notificationId,
                            ...notification
                        });
                        
                        // Update notification count
                        updateNotificationCount();
                        
                        // Show notification
                        showDataCollectorNotification(notification, notificationId);
                        
                        // Log notification
                        logger.addLogEntry(`New notification: ${notification.type}`, "notification");
                    }
                });
            }, error => {
                console.error("Error listening to notifications:", error);
                // Try to reconnect after delay
                setTimeout(() => {
                    if (firebaseDataManager && firebaseDataManager.userEmail) {
                        setupDataCollectorNotifications();
                    }
                }, 5000);
            });
        
        console.log('Notification listener set up successfully');
    }
    
    function showDataCollectorNotification(notification, notificationId) {
        const notificationDiv = document.createElement('div');
        notificationDiv.className = `collector-notification ${notification.type === 'approval_notification' ? 'approval' : ''}`;
        
        let icon = 'fa-info-circle';
        let title = 'Notification';
        
        if (notification.type === 'rejection_feedback') {
            icon = 'fa-times-circle';
            title = 'Submission Requires Revision';
        } else if (notification.type === 'approval_notification') {
            icon = 'fa-check-circle';
            title = 'Submission Approved!';
        } else if (notification.type === 'correction_request') {
            icon = 'fa-edit';
            title = 'Correction Requested';
        } else if (notification.type === 'general_announcement') {
            icon = 'fa-bullhorn';
            title = 'Announcement';
        }
        
        notificationDiv.innerHTML = `
            <div class="collector-notification-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fa-solid ${icon}" style="color: var(--accent); font-size: 1.2rem;"></i>
                    <div>
                        <strong style="color: var(--primary);">${title}</strong>
                        <div style="font-size: 0.85rem; color: #666;">${formatNotificationTime(notification.timestamp)}</div>
                    </div>
                </div>
                <button onclick="dismissNotification('${notificationId}', this)" style="background: none; border: none; color: #666; cursor: pointer; font-size: 1rem;">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="collector-notification-body">
                <div style="margin-bottom: 10px;">
                    ${notification.message || notification.feedback || notification.content || 'You have a new notification.'}
                </div>
                ${notification.propertyId ? `
                    <div style="font-size: 0.9rem; color: var(--accent);">
                        <i class="fa-solid fa-hashtag"></i> Property ID: ${notification.propertyId}
                    </div>
                ` : ''}
                ${notification.adminName ? `
                    <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                        <i class="fa-solid fa-user-shield"></i> From: ${notification.adminName}
                    </div>
                ` : ''}
            </div>
            <div class="collector-notification-footer">
                <button onclick="dismissNotification('${notificationId}', this)" style="padding: 6px 15px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                    Dismiss
                </button>
                ${notification.actionRequired ? `
                    <button onclick="loadRejectedPropertyIntoForm('${notification.propertyId}'); dismissNotification('${notificationId}', this)" style="padding: 6px 15px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        Review Property
                    </button>
                ` : ''}
            </div>
        `;
        
        // Add to page
        document.body.appendChild(notificationDiv);
        
        // Auto dismiss after 15 seconds for non-actionable notifications
        if (!notification.actionRequired) {
            setTimeout(() => {
                if (notificationDiv.parentElement) {
                    dismissNotification(notificationId, notificationDiv);
                }
            }, 15000);
        }
    }
    
    function formatNotificationTime(timestamp) {
        if (!timestamp) return 'Just now';
        
        const now = new Date();
        const notificationTime = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const diffMs = now - notificationTime;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
        
        return notificationTime.toLocaleDateString();
    }
    
    async function dismissNotification(notificationId, element) {
        try {
            // Mark as read in database
            await firebaseDb.collection('notifications').doc(notificationId).update({
                read: true,
                readAt: new Date().toISOString()
            });
            
            // Remove from local array
            unreadNotifications = unreadNotifications.filter(n => n.id !== notificationId);
            
            // Update notification count
            updateNotificationCount();
            
            // Remove from UI
            const notificationDiv = element.closest('.collector-notification') || element;
            if (notificationDiv.parentElement) {
                notificationDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notificationDiv.parentElement) {
                        notificationDiv.remove();
                    }
                }, 300);
            }
        } catch (error) {
            console.error("Error dismissing notification:", error);
        }
    }
    
    function viewPropertyForRevision(propertyId) {
        loadRejectedPropertyIntoForm(propertyId);
    }
    
    function updateNotificationCount() {
        notificationCount = unreadNotifications.length;
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationCountEl = document.getElementById('notificationCount');
        const notificationButton = document.getElementById('notificationButton');
        
        if (notificationCount > 0) {
            notificationBadge.style.display = 'inline-flex';
            notificationCountEl.textContent = notificationCount > 9 ? '9+' : notificationCount;
            
            // Add pulse animation if there are unread notifications
            if (!notificationButton.classList.contains('has-notifications')) {
                notificationButton.classList.add('has-notifications');
            }
        } else {
            notificationBadge.style.display = 'none';
            notificationButton.classList.remove('has-notifications');
        }
    }
    
    function showAllNotifications() {
        if (unreadNotifications.length === 0) {
            alert('You have no new notifications.');
            return;
        }
        
        // Create a modal to show all notifications
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.style.zIndex = '5000';
        
        let notificationsHTML = '';
        unreadNotifications.forEach(notification => {
            let icon = 'fa-info-circle';
            let title = 'Notification';
            
            if (notification.type === 'rejection_feedback') {
                icon = 'fa-times-circle';
                title = 'Submission Requires Revision';
            } else if (notification.type === 'approval_notification') {
                icon = 'fa-check-circle';
                title = 'Submission Approved!';
            } else if (notification.type === 'correction_request') {
                icon = 'fa-edit';
                title = 'Correction Requested';
            }
            
            notificationsHTML += `
                <div class="log-entry notification" style="margin-bottom: 10px;">
                    <div class="log-time">${formatNotificationTime(notification.timestamp)}</div>
                    <div class="log-message">
                        <strong><i class="fa-solid ${icon}"></i> ${title}</strong><br>
                        ${notification.message || notification.feedback || notification.content || 'Notification'}
                        ${notification.propertyId ? `<br><small><i class="fa-solid fa-hashtag"></i> Property ID: ${notification.propertyId}</small>` : ''}
                        ${notification.adminName ? `<br><small><i class="fa-solid fa-user-shield"></i> From: ${notification.adminName}</small>` : ''}
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="dismissNotification('${notification.id}', this.closest('.log-entry'))" style="padding: 4px 10px; font-size: 0.75rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                            Dismiss
                        </button>
                        ${notification.actionRequired && notification.propertyId ? `
                        <button onclick="loadRejectedPropertyIntoForm('${notification.propertyId}'); dismissNotification('${notification.id}', this.closest('.log-entry'))" style="padding: 4px 10px; font-size: 0.75rem; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Review Property
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div class="modal" style="max-width: 600px;">
                <h3><i class="fa-solid fa-bell"></i> Notifications (${notificationCount})</h3>
                <div style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                    ${notificationsHTML || '<p style="text-align: center; color: #666; padding: 20px;">No notifications</p>'}
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="dismissAllNotifications()" class="warning" style="flex: 1;">
                        <i class="fa-solid fa-check-double"></i> Mark All as Read
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove()" class="secondary" style="flex: 1;">
                        <i class="fa-solid fa-times"></i> Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    async function dismissAllNotifications() {
        try {
            const userEmail = firebaseDataManager.userEmail;
            if (!userEmail) return;
            
            // Get all unread notifications
            const snapshot = await firebaseDb.collection('notifications')
                .where('recipientEmail', '==', userEmail)
                .where('read', '==', false)
                .get();
            
            const batch = firebaseDb.batch();
            snapshot.forEach(doc => {
                batch.update(doc.ref, {
                    read: true,
                    readAt: new Date().toISOString()
                });
            });
            
            await batch.commit();
            
            // Clear local array
            unreadNotifications = [];
            updateNotificationCount();
            
            // Remove all notification elements
            document.querySelectorAll('.collector-notification').forEach(el => {
                el.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => el.remove(), 300);
            });
            
            // Close modal
            document.querySelector('.modal-overlay').remove();
            
            logger.addLogEntry(`Marked all notifications as read`, "info");
            
        } catch (error) {
            console.error("Error dismissing all notifications:", error);
            alert("Failed to mark all notifications as read. Please try again.");
        }
    }
    
    function cleanupNotificationListener() {
        if (notificationListener) {
            notificationListener();
            notificationListener = null;
        }
        unreadNotifications = [];
        notificationCount = 0;
        updateNotificationCount();
    }

    // ==============================================
    // LOAD REJECTED PROPERTY INTO FORM (DEEP LINKING)
    // ==============================================
    function loadRejectedPropertyIntoForm(propertyId = null) {
        const idToLoad = propertyId || (currentRejection ? currentRejection.propertyId : null);
        if (!idToLoad) {
            alert("No property ID specified for editing.");
            return;
        }
        
        const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        const property = db.find(item => item.propertyId === idToLoad);
        
        if (!property) {
            alert(`Property ${idToLoad} not found in local storage.`);
            return;
        }
        
        // Store the record ID for resubmission logic
        currentlyEditingRecordId = property.id;
        
        // Populate form fields
        document.getElementById('propertyId').value = property.propertyId;
        document.getElementById('propertyName').value = property.propertyName || '';
        
        // Set registration type
        setRegistrationType(property.registrationType || 'titled');
        if (property.plotNumber) document.getElementById('plotNumber').value = property.plotNumber;
        if (property.blockNumber) document.getElementById('blockNumber').value = property.blockNumber;
        
        // Handle geographical dropdowns
        populateGeographicalDropdowns(property);
        
        // Populate other fields
        document.getElementById('description').value = property.description || '';
        document.getElementById('dataSource').value = property.dataSource || '';
        document.getElementById('price').value = property.price || '';
        document.getElementById('size').value = property.size || '';
        document.getElementById('use').value = property.landUse || '';
        document.getElementById('officerName').value = property.officerName || '';
        
        // Handle evidence photo - if it's a URL, show it; if it's base64, convert and show
        if (property.photo) {
            evidencePhoto = property.photo;
            document.getElementById('imagePreview').src = property.photo;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('removePhotoBtn').style.display = 'block';
        } else if (property.evidence) {
            // Handle old base64 evidence field
            evidencePhoto = property.evidence;
            document.getElementById('imagePreview').src = property.evidence;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('removePhotoBtn').style.display = 'block';
        } else {
            evidencePhoto = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('removePhotoBtn').style.display = 'none';
        }
        
        // Update location mode and coordinates
        if (property.locationMode === 'manual') {
            setLocationMode('manual');
            manualPos = [parseFloat(property.latitude), parseFloat(property.longitude)];
            
            // Update manual marker
            manualLayer.clearLayers();
            manualMarker = L.marker(manualPos, {
                icon: L.divIcon({
                    className: 'manual-marker',
                    html: `<div style="
                        width: 32px;
                        height: 32px;
                        background: rgba(142, 68, 173, 0.8);
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 0 10px rgba(142, 68, 173, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                    "><i class="fa-solid fa-map-pin"></i></div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                }),
                zIndexOffset: 1000
            }).addTo(manualLayer);
            
            updateCoordinatesDisplay(manualPos[0], manualPos[1], 'Selected Point');
            document.getElementById('clearPointBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
        } else {
            setLocationMode('gps');
        }
        
        // Center map on property location
        if (property.latitude && property.longitude) {
            map.setView([property.latitude, property.longitude], 18);
        }
        
        // Update save button to show resubmission mode
        document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-rotate"></i> UPDATE & RESUBMIT';
        document.getElementById('saveBtn').classList.remove('success');
        document.getElementById('saveBtn').classList.add('info');
        
        // Show notification
        alert(`Property ${property.propertyId} loaded into form for editing. Please make the necessary corrections and click "UPDATE & RESUBMIT".\n\nRejection Reason: ${property.rejectionReason || 'Not specified'}`);
        
        // Hide rejection feedback modal if open
        hideRejectionFeedback();
        
        // Log action
        logger.addLogEntry(`Loaded rejected property into form for editing: ${property.propertyId}`, "info");
        
        // Scroll to form
        document.querySelector('.panel h3').scrollIntoView({ behavior: 'smooth' });
    }
    
    function populateGeographicalDropdowns(property) {
        // District/City
        const districtSelect = document.getElementById('districtCity');
        const districtManual = document.getElementById('districtCityManual');
        
        // Check if value exists in dropdown
        let districtFound = false;
        for (let i = 0; i < districtSelect.options.length; i++) {
            if (districtSelect.options[i].value === property.districtCity) {
                districtSelect.value = property.districtCity;
                districtFound = true;
                break;
            }
        }
        
        if (!districtFound && property.districtCity) {
            // Use manual input
            districtSelect.style.display = 'none';
            districtManual.style.display = 'block';
            districtManual.value = property.districtCity;
        } else {
            districtSelect.style.display = 'block';
            districtManual.style.display = 'none';
        }
        
        // Update dependent dropdowns
        updateSubcounties();
        
        // Subcounty
        const subcountySelect = document.getElementById('subcounty');
        const subcountyManual = document.getElementById('subcountyManual');
        
        if (districtSelect.value && property.subcounty) {
            let subcountyFound = false;
            for (let i = 0; i < subcountySelect.options.length; i++) {
                if (subcountySelect.options[i].value === property.subcounty) {
                    subcountySelect.value = property.subcounty;
                    subcountyFound = true;
                    break;
                }
            }
            
            if (!subcountyFound) {
                subcountySelect.style.display = 'none';
                subcountyManual.style.display = 'block';
                subcountyManual.value = property.subcounty;
            } else {
                subcountySelect.style.display = 'block';
                subcountyManual.style.display = 'none';
            }
            
            updateParishes();
        }
        
        // Parish
        const parishSelect = document.getElementById('parish');
        const parishManual = document.getElementById('parishManual');
        
        if (subcountySelect.value && property.parish) {
            let parishFound = false;
            for (let i = 0; i < parishSelect.options.length; i++) {
                if (parishSelect.options[i].value === property.parish) {
                    parishSelect.value = property.parish;
                    parishFound = true;
                    break;
                }
            }
            
            if (!parishFound) {
                parishSelect.style.display = 'none';
                parishManual.style.display = 'block';
                parishManual.value = property.parish;
            } else {
                parishSelect.style.display = 'block';
                parishManual.style.display = 'none';
            }
            
            updateVillages();
        }
        
        // Village
        const villageSelect = document.getElementById('village');
        const villageManual = document.getElementById('villageManual');
        
        if (parishSelect.value && property.village) {
            let villageFound = false;
            for (let i = 0; i < villageSelect.options.length; i++) {
                if (villageSelect.options[i].value === property.village) {
                    villageSelect.value = property.village;
                    villageFound = true;
                    break;
                }
            }
            
            if (!villageFound) {
                villageSelect.style.display = 'none';
                villageManual.style.display = 'block';
                villageManual.value = property.village;
            } else {
                villageSelect.style.display = 'block';
                villageManual.style.display = 'none';
            }
        }
    }

    // ==============================================
    // FIREBASE STORAGE UPLOAD FUNCTION
    // ==============================================
    async function uploadToFirebaseStorage(propertyId, base64String) {
        if (!base64String || base64String.length < 100) return null;

        try {
            // 1. Create a reference to the storage bucket
            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`property_photos/${propertyId}_${Date.now()}.jpg`);

            // 2. Convert Base64 to Blob
            const response = await fetch(base64String);
            const blob = await response.blob();

            // 3. Upload and get the URL
            const snapshot = await fileRef.put(blob);
            const downloadURL = await snapshot.ref.getDownloadURL();
            
            return downloadURL;
        } catch (error) {
            console.error("Storage Error:", error);
            throw new Error("Photo upload failed. Check connection.");
        }
    }

    // ==============================================
    // FIREBASE DATA MANAGER (UPDATED WITH FEEDBACK LISTENER)
    // ==============================================
    class FirebaseDataManager {
        constructor() {
            if (!firebaseApp) {
                console.error('Firebase not initialized');
                return;
            }
            
            this.db = firebaseDb;
            this.storage = firebaseStorage;
            this.auth = firebaseAuth;
            this.userId = null;
            this.userEmail = null;
            this.isOnline = navigator.onLine;
            this.syncQueue = [];
            this.isSyncing = false;
            this.lastSyncTime = null;
            this.feedbackListener = null;
            this.rejectedProperties = new Set();
            
            // Set up auth state listener
            this.setupAuthListener();
            
            // Set up network status listener
            this.setupNetworkListener();
            
            // Initialize offline queue
            this.loadSyncQueue();
            
            // Start periodic sync
            this.startPeriodicSync();
        }
        
        setupAuthListener() {
            this.auth.onAuthStateChanged((user) => {
                if (user) {
                    this.userId = user.uid;
                    this.userEmail = user.email;
                    console.log('Firebase: User authenticated:', user.email);
                    
                    // Update UI
                    this.updateFirebaseStatus(true);
                    
                    // Start syncing any queued data
                    this.processSyncQueue();
                    
                    // Update sync stats
                    this.updateSyncStats();
                    
                    // Start listening for feedback
                    this.startFeedbackListener();
                    
                    // Setup data collector notifications
                    setupDataCollectorNotifications();
                    
                } else {
                    this.userId = null;
                    this.userEmail = null;
                    console.log('Firebase: User signed out');
                    this.updateFirebaseStatus(false);
                    
                    // Stop feedback listener
                    this.stopFeedbackListener();
                    
                    // Clean up notification listener
                    cleanupNotificationListener();
                }
            });
        }
        
        setupNetworkListener() {
            window.addEventListener('online', () => {
                this.isOnline = true;
                console.log('Firebase: Back online, starting sync');
                this.updateFirebaseStatus(this.userId !== null);
                this.processSyncQueue();
                
                // Restart feedback listener if needed
                if (this.userId && !this.feedbackListener) {
                    this.startFeedbackListener();
                }
                
                // Restart notification listener if needed
                if (this.userId && !notificationListener) {
                    setupDataCollectorNotifications();
                }
            });
            
            window.addEventListener('offline', () => {
                this.isOnline = false;
                console.log('Firebase: Offline mode');
                this.updateFirebaseStatus(false);
            });
        }
        
        loadSyncQueue() {
            const queue = localStorage.getItem('lavmis_sync_queue');
            if (queue) {
                this.syncQueue = JSON.parse(queue);
            }
        }
        
        saveSyncQueue() {
            localStorage.setItem('lavmis_sync_queue', JSON.stringify(this.syncQueue));
        }
        
        updateFirebaseStatus(isConnected) {
            const statusPanel = document.getElementById('firebaseStatusPanel');
            const statusIndicator = document.getElementById('firebase-status-ind');
            const statusElement = document.getElementById('firebaseConnectionStatus');
            const statusText = document.getElementById('firebaseStatusText');
            const statusDetail = document.getElementById('firebaseStatusDetail');
            const syncInfo = document.getElementById('syncStatusInfo');
            
            if (isConnected && this.userId) {
                statusPanel.style.display = 'block';
                statusIndicator.style.display = 'flex';
                statusIndicator.innerHTML = '<i class="fa-solid fa-cloud"></i> FIREBASE';
                
                if (this.isOnline) {
                    statusElement.className = 'firebase-status online';
                    statusElement.innerHTML = `
                        <i class="fa-solid fa-cloud-check"></i>
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 600; font-size: 0.9rem;">Connected to Firebase</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                User: ${this.userEmail}
                            </div>
                        </div>
                    `;
                    
                    if (syncInfo) {
                        syncInfo.style.display = 'flex';
                        syncInfo.className = 'firebase-status online';
                        syncInfo.innerHTML = `
                            <i class="fa-solid fa-cloud-check"></i>
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 0.9rem;">Cloud Sync Active</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    Real-time cloud synchronization enabled
                                </div>
                            </div>
                        `;
                    }
                } else {
                    statusElement.className = 'firebase-status offline';
                    statusElement.innerHTML = `
                        <i class="fa-solid fa-cloud-slash"></i>
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 600; font-size: 0.9rem;">Offline Mode</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Changes will sync when back online
                            </div>
                        </div>
                    `;
                    
                    if (syncInfo) {
                        syncInfo.style.display = 'flex';
                        syncInfo.className = 'firebase-status offline';
                        syncInfo.innerHTML = `
                            <i class="fa-solid fa-cloud-slash"></i>
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 0.9rem;">Working Offline</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    Data queued for sync (${this.syncQueue.length} items)
                                </div>
                            </div>
                        `;
                    }
                }
            } else {
                statusPanel.style.display = 'none';
                statusIndicator.style.display = 'none';
                
                if (syncInfo) {
                    syncInfo.style.display = 'none';
                }
            }
        }
        
        // ==============================================
        // FEEDBACK LISTENER IMPLEMENTATION
        // ==============================================
        startFeedbackListener() {
            if (!this.userId || !this.isOnline || this.feedbackListener) {
                return;
            }
            
            console.log('Firebase: Starting feedback listener for user:', this.userEmail);
            
            // Listen for rejected submissions
            this.feedbackListener = this.db.collection('properties')
                .where('userEmail', '==', this.userEmail)
                .where('status', '==', 'rejected')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "modified" || change.type === "added") {
                            const data = change.doc.data();
                            const docId = change.doc.id;
                            
                            // Check if we've already processed this rejection
                            if (this.rejectedProperties.has(docId)) {
                                return;
                            }
                            
                            this.rejectedProperties.add(docId);
                            
                            // Show notification
                            this.showRejectionNotification(data, docId);
                            
                            // Log the rejection
                            logger.addLogEntry(`REJECTED: ${data.propertyId} - ${data.rejectionReason || 'No reason provided'}`, "rejected");
                            
                            // Update local record status if it exists
                            this.updateLocalRejectionStatus(data, docId);
                        }
                    });
                }, error => {
                    console.error('Firebase feedback listener error:', error);
                    // Try to restart listener after delay
                    setTimeout(() => this.startFeedbackListener(), 5000);
                });
        }
        
        stopFeedbackListener() {
            if (this.feedbackListener) {
                this.feedbackListener();
                this.feedbackListener = null;
                console.log('Firebase: Feedback listener stopped');
            }
        }
        
        showRejectionNotification(data, docId) {
            // Store rejection data globally for access
            currentRejection = {
                propertyId: data.propertyId,
                propertyName: data.propertyName || 'Unnamed Property',
                rejectionReason: data.rejectionReason || 'No reason provided',
                firebaseId: docId,
                localId: data.localId,
                reviewer: data.reviewedBy || 'Unknown Reviewer',
                reviewedAt: data.reviewedAt || new Date().toISOString()
            };
            
            // Show notification
            const notification = document.getElementById('rejectionNotification');
            const title = document.getElementById('rejectionNotificationTitle');
            const details = document.getElementById('rejectionNotificationDetails');
            
            title.textContent = `Submission Rejected: ${data.propertyId}`;
            details.textContent = data.rejectionReason ? data.rejectionReason.substring(0, 50) + '...' : 'Click to view details';
            
            notification.style.display = 'flex';
            notification.style.animation = 'slideUp 0.3s ease-out';
            
            // Make notification clickable
            notification.onclick = () => {
                this.showRejectionFeedbackModal(data, docId);
            };
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (notification.style.display === 'flex') {
                    notification.style.animation = 'slideUp 0.3s ease-out reverse';
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 300);
                }
            }, 10000);
        }
        
        showRejectionFeedbackModal(data, docId) {
            const modal = document.getElementById('rejectionFeedback');
            const propertyIdEl = document.getElementById('rejectionPropertyId');
            const reasonEl = document.getElementById('rejectionReasonText');
            
            propertyIdEl.textContent = data.propertyId;
            reasonEl.textContent = data.rejectionReason || 'No reason provided.';
            
            // Store current rejection data
            currentRejection = {
                propertyId: data.propertyId,
                propertyName: data.propertyName || 'Unnamed Property',
                rejectionReason: data.rejectionReason || 'No reason provided',
                firebaseId: docId,
                localId: data.localId,
                reviewer: data.reviewedBy || 'Unknown Reviewer',
                reviewedAt: data.reviewedAt || new Date().toISOString()
            };
            
            modal.style.display = 'block';
            
            // Hide notification
            const notification = document.getElementById('rejectionNotification');
            notification.style.display = 'none';
        }
        
        updateLocalRejectionStatus(data, firebaseId) {
            // Find and update local record
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            let updated = false;
            
            // Try to match by firebaseId first
            let index = db.findIndex(item => item.firebaseId === firebaseId);
            
            // If not found by firebaseId, try to match by propertyId
            if (index === -1 && data.propertyId) {
                index = db.findIndex(item => item.propertyId === data.propertyId);
            }
            
            // If not found by propertyId, try to match by localId
            if (index === -1 && data.localId) {
                index = db.findIndex(item => item.id === data.localId);
            }
            
            if (index !== -1) {
                // Update local record with rejection info
                db[index].status = 'rejected';
                db[index].rejectionReason = data.rejectionReason;
                db[index].reviewedBy = data.reviewedBy;
                db[index].reviewedAt = data.reviewedAt;
                db[index].firebaseId = firebaseId; // Ensure firebaseId is set
                
                localStorage.setItem('lavmis_pro_db', JSON.stringify(db));
                updated = true;
                
                // Update table to show rejection status
                updateTable();
                
                // Update marker on map
                this.updateMarkerRejectionStatus(db[index]);
            }
            
            return updated;
        }
        
        updateMarkerRejectionStatus(record) {
            // Find and update the marker for this record
            savedLayer.eachLayer(layer => {
                if (layer.recordId === record.id) {
                    // Update marker color to indicate rejection
                    const iconColor = '#e74c3c'; // Red for rejected
                    layer.setIcon(L.divIcon({
                        className: 'rejected-marker',
                        html: `<div style="
                            width: 24px;
                            height: 24px;
                            background: ${iconColor};
                            border: 2px solid white;
                            border-radius: 50%;
                            box-shadow: 0 0 5px rgba(0,0,0,0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 10px;
                        "><i class="fa-solid fa-ban"></i></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    }));
                    
                    // Update popup content
                    let popupContent = layer.getPopup().getContent();
                    if (popupContent.includes('rejectionReason')) {
                        // Already updated
                        return;
                    }
                    
                    // Add rejection info to popup
                    const rejectionSection = `
                        <div style="background: #fdeaea; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 3px solid #e74c3c;">
                            <h5 style="margin: 0 0 5px 0; color: #e74c3c;"><i class="fa-solid fa-exclamation-triangle"></i> REJECTED</h5>
                            <p style="margin: 0; font-size: 0.9rem;"><strong>Reason:</strong> ${record.rejectionReason || 'No reason provided'}</p>
                            ${record.reviewedBy ? `<p style="margin: 5px 0 0 0; font-size: 0.8rem;"><strong>Reviewed by:</strong> ${record.reviewedBy}</p>` : ''}
                        </div>
                    `;
                    
                    // Insert rejection section before the buttons
                    const buttonSectionIndex = popupContent.indexOf('<hr style="margin: 10px 0;">');
                    if (buttonSectionIndex !== -1) {
                        popupContent = popupContent.substring(0, buttonSectionIndex) + 
                                      rejectionSection + 
                                      popupContent.substring(buttonSectionIndex);
                        layer.getPopup().setContent(popupContent);
                    }
                }
            });
        }
        
        async savePropertyToFirebase(propertyData, existingFirebaseId = null) {
            if (!this.userId) {
                throw new Error('User not authenticated. Please log in again.');
            }
            
            // Determine if this is a resubmission of a rejected property
            const isResubmission = propertyData.status === 'pending' && 
                                  propertyData.previousStatus === 'rejected';
            
            // Add status field for review workflow
            const firebaseRecord = {
                ...propertyData,
                userId: this.userId,
                userEmail: this.userEmail,
                status: 'pending', // Reset to pending for review
                resubmittedAt: isResubmission ? new Date().toISOString() : null,
                previousRejectionReason: isResubmission ? propertyData.rejectionReason : null,
                rejectionReason: null, // Clear rejection reason on resubmission
                reviewedBy: null, // Clear reviewer info
                reviewedAt: null, // Clear review date
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                syncStatus: 'pending',
                localId: propertyData.id
            };
            
            // Remove the local ID for Firebase
            delete firebaseRecord.id;
            
            if (this.isOnline) {
                try {
                    let docRef;
                    
                    if (existingFirebaseId) {
                        // Update existing Firestore document
                        docRef = this.db.collection('properties').doc(existingFirebaseId);
                        await docRef.update(firebaseRecord);
                        console.log('Firebase: Property updated with ID:', existingFirebaseId);
                    } else {
                        // Save to Firestore as new document
                        docRef = await this.db.collection('properties').add(firebaseRecord);
                        console.log('Firebase: Property saved with ID:', docRef.id);
                    }
                    
                    // Update local storage with Firebase ID
                    const localRecord = { 
                        ...propertyData, 
                        firebaseId: existingFirebaseId || docRef.id,
                        syncStatus: 'synced',
                        syncedAt: new Date().toISOString(),
                        status: 'pending', // Reset status
                        rejectionReason: null, // Clear rejection reason
                        reviewedBy: null,
                        reviewedAt: null
                    };
                    this.updateLocalStorage(propertyData.id, localRecord);
                    
                    const message = isResubmission ? 
                        'Property resubmitted for review' : 
                        'Property submitted for review';
                    this.showFirebaseNotification(message, 'success');
                    
                    return { success: true, firebaseId: existingFirebaseId || docRef.id, isResubmission: isResubmission };
                } catch (error) {
                    console.error('Firebase save error:', error);
                    
                    // Queue for later sync
                    this.addToSyncQueue('create', propertyData);
                    
                    // Update local record with sync status
                    const localRecord = { ...propertyData, syncStatus: 'queued', status: 'pending' };
                    this.updateLocalStorage(propertyData.id, localRecord);
                    
                    this.showFirebaseNotification('Property queued for sync (offline)', 'warning');
                    
                    throw error;
                }
            } else {
                // Queue for sync when online
                this.addToSyncQueue('create', propertyData);
                
                // Update local record with sync status
                const localRecord = { ...propertyData, syncStatus: 'queued', status: 'pending' };
                this.updateLocalStorage(propertyData.id, localRecord);
                
                this.showFirebaseNotification('Property saved locally (offline mode)', 'info');
                
                return { success: true, message: 'Queued for sync when online' };
            }
        }
        
        addToSyncQueue(operation, data) {
            const queueItem = {
                id: Date.now(),
                operation: operation,
                data: data,
                timestamp: new Date().toISOString(),
                attempts: 0
            };
            
            this.syncQueue.push(queueItem);
            this.saveSyncQueue();
            
            console.log(`Firebase: Added to sync queue (${operation}):`, data.propertyId);
            this.updateSyncStats();
        }
        
        async processSyncQueue() {
            if (!this.isOnline || !this.userId || this.isSyncing || this.syncQueue.length === 0) {
                return;
            }
            
            this.isSyncing = true;
            console.log(`Firebase: Processing ${this.syncQueue.length} queued items`);
            
            const successfulItems = [];
            const failedItems = [];
            
            // Show sync notification
            this.showFirebaseNotification(`Syncing ${this.syncQueue.length} items to Firebase...`, 'info');
            
            for (const item of this.syncQueue) {
                try {
                    if (item.operation === 'create') {
                        const firebaseRecord = {
                            ...item.data,
                            userId: this.userId,
                            userEmail: this.userEmail,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            syncStatus: 'synced',
                            originallyQueuedAt: item.timestamp
                        };
                        
                        delete firebaseRecord.id;
                        
                        const docRef = await this.db.collection('properties').add(firebaseRecord);
                        
                        // Update local storage with Firebase ID
                        const localRecord = { 
                            ...item.data, 
                            firebaseId: docRef.id,
                            syncStatus: 'synced',
                            syncedAt: new Date().toISOString(),
                            status: 'pending'
                        };
                        this.updateLocalStorage(item.data.id, localRecord);
                        
                        successfulItems.push(item.id);
                        console.log('Firebase: Synced queued property:', item.data.propertyId);
                    }
                } catch (error) {
                    console.error('Firebase sync error for item:', item.id, error);
                    item.attempts++;
                    
                    if (item.attempts < 3) {
                        failedItems.push(item);
                    } else {
                        console.error('Firebase: Failed after 3 attempts:', item.id);
                        // Mark as permanently failed
                        this.markAsFailed(item.data.id);
                    }
                }
            }
            
            // Remove successfully synced items
            this.syncQueue = this.syncQueue.filter(item => 
                !successfulItems.includes(item.id)
            );
            
            // Update failed items (with increased attempt count)
            this.syncQueue = this.syncQueue.map(item => {
                const failed = failedItems.find(f => f.id === item.id);
                return failed ? failed : item;
            });
            
            this.saveSyncQueue();
            this.isSyncing = false;
            this.lastSyncTime = new Date();
            
            // Update UI
            this.updateSyncStats();
            
            if (successfulItems.length > 0) {
                this.showFirebaseNotification(`${successfulItems.length} records synced to Firebase`, 'success');
                updateTable(); // Refresh table to show updated sync status
            }
            
            if (failedItems.length > 0) {
                this.showFirebaseNotification(`${failedItems.length} items failed to sync`, 'error');
            }
        }
        
        updateLocalStorage(localId, updatedRecord) {
            let db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            const index = db.findIndex(item => item.id === localId);
            
            if (index !== -1) {
                db[index] = { ...db[index], ...updatedRecord };
                localStorage.setItem('lavmis_pro_db', JSON.stringify(db));
            }
        }
        
        markAsFailed(localId) {
            let db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            const index = db.findIndex(item => item.id === localId);
            
            if (index !== -1) {
                db[index].syncStatus = 'failed';
                db[index].syncError = 'Failed after 3 attempts';
                localStorage.setItem('lavmis_pro_db', JSON.stringify(db));
            }
        }
        
        updateSyncStats() {
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            const syncedCount = db.filter(item => item.syncStatus === 'synced').length;
            const pendingCount = db.filter(item => 
                item.syncStatus === 'pending' || item.syncStatus === 'queued'
            ).length;
            
            document.getElementById('syncedRecords').textContent = syncedCount;
            document.getElementById('pendingSync').textContent = pendingCount;
            
            // Update sync status text
            const syncStatusText = document.getElementById('syncStatusText');
            if (syncStatusText) {
                if (pendingCount > 0) {
                    syncStatusText.innerHTML = `${pendingCount} records pending sync`;
                } else if (syncedCount > 0) {
                    syncStatusText.innerHTML = `All ${syncedCount} records synced`;
                } else {
                    syncStatusText.innerHTML = 'No records to sync';
                }
            }
        }
        
        showFirebaseNotification(message, type = 'info') {
            const notification = document.getElementById('firebaseSyncNotification');
            const messageEl = document.getElementById('firebaseSyncMessage');
            const detailsEl = document.getElementById('firebaseSyncDetails');
            
            if (!notification || !messageEl) return;
            
            // Set message
            messageEl.textContent = message;
            
            // Set details based on type
            switch(type) {
                case 'success':
                    detailsEl.textContent = 'Successfully synchronized with Firebase';
                    notification.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
                    break;
                case 'warning':
                    detailsEl.textContent = 'Will sync when back online';
                    notification.style.background = 'linear-gradient(135deg, #f39c12 0%, #f1c40f 100%)';
                    break;
                case 'error':
                    detailsEl.textContent = 'Sync failed. Will retry later';
                    notification.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                    break;
                default:
                    detailsEl.textContent = 'Syncing data to cloud database';
                    notification.style.background = 'linear-gradient(135deg, var(--firebase) 0%, #F57C00 100%)';
            }
            
            // Show notification
            notification.style.display = 'flex';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.style.animation = 'slideUp 0.3s ease-out';
                }, 300);
            }, 3000);
        }
        
        async backupAllToFirebase() {
            if (!this.userId) {
                throw new Error('User not authenticated');
            }
            
            const localDb = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            
            if (localDb.length === 0) {
                return { success: true, message: 'No data to backup' };
            }
            
            // Show progress notification
            this.showFirebaseNotification(`Backing up ${localDb.length} records to Firebase...`, 'info');
            
            const backupRef = this.db.collection('backups').doc();
            const backupData = {
                userId: this.userId,
                userEmail: this.userEmail,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                recordCount: localDb.length,
                data: localDb.map(record => {
                    const { id, firebaseId, ...rest } = record;
                    return rest;
                }),
                backupType: 'full',
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    timestamp: new Date().toISOString()
                }
            };
            
            try {
                await backupRef.set(backupData);
                console.log('Firebase: Full backup created:', backupRef.id);
                
                // Update all local records with Firebase IDs
                let syncedCount = 0;
                for (const record of localDb) {
                    if (!record.firebaseId || record.syncStatus !== 'synced') {
                        try {
                            const firebaseRecord = {
                                ...record,
                                userId: this.userId,
                                userEmail: this.userEmail,
                                status: record.status || 'pending',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                syncStatus: 'synced',
                                backupId: backupRef.id,
                                localId: record.id
                            };
                            
                            delete firebaseRecord.id;
                            delete firebaseRecord.firebaseId;
                            
                            let docRef;
                            if (record.firebaseId) {
                                // Update existing document
                                docRef = this.db.collection('properties').doc(record.firebaseId);
                                await docRef.update(firebaseRecord);
                            } else {
                                // Create new document
                                docRef = await this.db.collection('properties').add(firebaseRecord);
                            }
                            
                            this.updateLocalStorage(record.id, { 
                                firebaseId: docRef.id,
                                syncStatus: 'synced',
                                syncedAt: new Date().toISOString(),
                                status: record.status || 'pending'
                            });
                            
                            syncedCount++;
                        } catch (error) {
                            console.error('Error syncing individual record:', error);
                            // Mark as queued for retry
                            this.addToSyncQueue('create', record);
                        }
                    } else {
                        syncedCount++;
                    }
                }
                
                this.updateSyncStats();
                this.showFirebaseNotification(`Backup completed: ${syncedCount}/${localDb.length} records synced`, 'success');
                
                return { 
                    success: true, 
                    backupId: backupRef.id,
                    recordCount: localDb.length,
                    syncedCount: syncedCount
                };
            } catch (error) {
                console.error('Firebase backup error:', error);
                this.showFirebaseNotification(`Backup failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async restoreFromFirebase() {
            if (!this.userId) {
                throw new Error('User not authenticated');
            }
            
            if (!confirm("This will restore ALL your data from Firebase Cloud. This action will replace any local data. Continue?")) {
                return;
            }
            
            this.showFirebaseNotification('Restoring data from Firebase...', 'info');
            
            try {
                // Get user's properties from Firebase
                const snapshot = await this.db.collection('properties')
                    .where('userId', '==', this.userId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const restoredData = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    restoredData.push({
                        ...data,
                        firebaseId: doc.id,
                        id: Date.now() + Math.random(), // Generate new local ID
                        syncStatus: 'synced',
                        syncedAt: new Date().toISOString()
                    });
                });
                
                // Save to local storage
                localStorage.setItem('lavmis_pro_db', JSON.stringify(restoredData));
                
                // Clear and replot markers
                savedLayer.clearLayers();
                restoredData.forEach(plotPoint);
                updateTable();
                
                // Update storage display
                if (storageManager) {
                    storageManager.updateStorageDisplay();
                }
                
                this.updateSyncStats();
                this.showFirebaseNotification(`Restored ${restoredData.length} records from Firebase`, 'success');
                
                logger.addLogEntry(`Data restored from Firebase: ${restoredData.length} records`, "success");
                
                return {
                    success: true,
                    recordCount: restoredData.length,
                    data: restoredData
                };
            } catch (error) {
                console.error('Firebase restore error:', error);
                this.showFirebaseNotification(`Restore failed: ${error.message}`, 'error');
                logger.addLogEntry(`Firebase restore failed: ${error.message}`, "error");
                throw error;
            }
        }
        
        async syncAllToFirebase() {
            if (!this.userId) {
                alert('Please log in to sync with Firebase');
                return;
            }
            
            const localDb = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            const unsyncedRecords = localDb.filter(record => 
                !record.syncStatus || record.syncStatus !== 'synced'
            );
            
            if (unsyncedRecords.length === 0) {
                this.showFirebaseNotification('All records are already synced', 'info');
                return;
            }
            
            if (!confirm(`Sync ${unsyncedRecords.length} unsynced records to Firebase Cloud?`)) {
                return;
            }
            
            this.showFirebaseNotification(`Syncing ${unsyncedRecords.length} records...`, 'info');
            
            let syncedCount = 0;
            let failedCount = 0;
            
            for (const record of unsyncedRecords) {
                try {
                    await this.savePropertyToFirebase(record);
                    syncedCount++;
                } catch (error) {
                    failedCount++;
                    console.error('Sync error for record:', record.propertyId, error);
                }
            }
            
            this.updateSyncStats();
            updateTable();
            
            if (syncedCount > 0) {
                this.showFirebaseNotification(`Successfully synced ${syncedCount} records`, 'success');
            }
            
            if (failedCount > 0) {
                this.showFirebaseNotification(`${failedCount} records failed to sync`, 'error');
            }
        }
        
        startPeriodicSync() {
            // Sync every 5 minutes if online
            setInterval(() => {
                if (this.isOnline && this.userId && this.syncQueue.length > 0 && !this.isSyncing) {
                    this.processSyncQueue();
                }
            }, 5 * 60 * 1000); // 5 minutes
        }
    }

    // ==============================================
    // REJECTION FEEDBACK UI FUNCTIONS
    // ==============================================
    function hideRejectionFeedback() {
        const modal = document.getElementById('rejectionFeedback');
        modal.style.display = 'none';
    }
    
    function goToRejectedProperty() {
        if (!currentRejection) {
            hideRejectionFeedback();
            return;
        }
        
        loadRejectedPropertyIntoForm(currentRejection.propertyId);
        hideRejectionFeedback();
    }

    // ==============================================
    // LOGIN SYSTEM
    // ==============================================
    class LoginSystem {
        constructor() {
            this.maxAttempts = 5;
            this.remainingAttempts = this.maxAttempts;
            this.lockoutTime = 5 * 60 * 1000;
            this.isLocked = false;
            this.lockoutTimer = null;
            this.autoBackupInProgress = false;
            this.isLoggingOut = false;
            
            // Initialize Firebase
            this.initializeFirebase();
            
            // Setup enter key for login
            this.setupLoginEvents();
            
            // Check for existing Firebase session
            this.checkFirebaseSession();
        }
        
        initializeFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDb = firebase.firestore();
                firebaseAuth = firebase.auth();
                firebaseStorage = firebase.storage();
                
                // Enable offline persistence
                firebaseDb.enablePersistence()
                    .catch((err) => {
                        console.error('Firebase persistence error:', err);
                    });
                    
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }
        
        setupLoginEvents() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginButton = document.getElementById('loginButton');
            
            // Enter key support
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    passwordInput.focus();
                }
            });
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.attemptFirebaseLogin();
                }
            });
            
            // Auto-focus on username
            setTimeout(() => usernameInput.focus(), 100);
        }
        
        checkFirebaseSession() {
            if (!firebaseAuth) {
                console.error('Firebase Auth not initialized');
                return;
            }
            
            // Check Firebase auth state
            firebaseAuth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    this.loginSuccess(user.email, true);
                } else {
                    // User is signed out
                    this.checkLocalLockout();
                }
            });
        }
        
        checkLocalLockout() {
            // Check for local lockout (for failed attempts)
            const lockout = localStorage.getItem('lavmis_lockout');
            if (lockout) {
                const lockoutData = JSON.parse(lockout);
                const now = Date.now();
                
                if (now < lockoutData.until) {
                    this.lockout(lockoutData.until - now);
                    return;
                } else {
                    localStorage.removeItem('lavmis_lockout');
                }
            }
            
            // Check for remaining attempts
            const attempts = localStorage.getItem('lavmis_attempts');
            if (attempts) {
                this.remainingAttempts = parseInt(attempts);
                this.updateAttemptsDisplay();
            }
        }
        
        attemptFirebaseLogin() {
            if (this.isLocked) {
                return;
            }
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            
            // Clear previous error
            errorElement.textContent = '';
            
            // Validate inputs
            if (!username || !password) {
                errorElement.textContent = 'Please enter both email and password';
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(username)) {
                errorElement.textContent = 'Please enter a valid email address';
                return;
            }
            
            // Disable button while checking
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> AUTHENTICATING...';
            
            // Firebase authentication
            firebaseAuth.signInWithEmailAndPassword(username, password)
                .then((userCredential) => {
                    // Signed in successfully
                    const user = userCredential.user;
                    this.loginSuccess(user.email, false);
                })
                .catch((error) => {
                    // Handle Firebase errors
                    this.handleFirebaseError(error);
                    
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> LOGIN TO LAVMIS';
                });
        }
        
        handleFirebaseError(error) {
            this.remainingAttempts--;
            localStorage.setItem('lavmis_attempts', this.remainingAttempts.toString());
            
            const errorElement = document.getElementById('loginError');
            let errorMessage = '';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email format';
                    break;
                case 'auth/user-disabled':
                    errorMessage = 'This account has been disabled';
                    break;
                case 'auth/user-not-found':
                    errorMessage = 'No account found with this email';
                    break;
                case 'auth/wrong-password':
                    errorMessage = 'Incorrect password';
                    break;
                case 'auth/too-many-requests':
                    errorMessage = 'Too many failed attempts. Try again later';
                    this.lockout(this.lockoutTime);
                    return;
                default:
                    errorMessage = `Authentication failed: ${error.message}`;
            }
            
            if (this.remainingAttempts <= 0) {
                // Lockout user
                const lockoutUntil = Date.now() + this.lockoutTime;
                const lockoutData = {
                    until: lockoutUntil,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('lavmis_lockout', JSON.stringify(lockoutData));
                this.lockout(this.lockoutTime);
                
                errorElement.textContent = 'Too many failed attempts. System locked for 5 minutes.';
                errorElement.style.color = '#e74c3c';
                
                // Shake animation
                document.querySelector('.login-container').classList.add('locked-out');
                setTimeout(() => {
                    document.querySelector('.login-container').classList.remove('locked-out');
                }, 500);
            } else {
                errorElement.textContent = `${errorMessage}. ${this.remainingAttempts} attempt(s) remaining.`;
                errorElement.style.color = '#f39c12';
                
                // Clear password field
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
            
            this.updateAttemptsDisplay();
        }
        
        lockout(timeRemaining) {
            this.isLocked = true;
            
            const loginContainer = document.querySelector('.login-container');
            const loginButton = document.getElementById('loginButton');
            const errorElement = document.getElementById('loginError');
            
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fa-solid fa-lock"></i> SYSTEM LOCKED';
            
            const minutes = Math.floor(timeRemaining / 60000);
            const seconds = Math.floor((timeRemaining % 60000) / 1000);
            
            errorElement.textContent = `Too many failed attempts. Please try again in ${minutes}:${seconds.toString().padStart(2, '0')}`;
            errorElement.style.color = '#e74c3c';
            
            // Update countdown
            this.lockoutTimer = setInterval(() => {
                timeRemaining -= 1000;
                
                if (timeRemaining <= 0) {
                    clearInterval(this.lockoutTimer);
                    this.isLocked = false;
                    localStorage.removeItem('lavmis_lockout');
                    
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> LOGIN TO LAVMIS';
                    
                    errorElement.textContent = '';
                    this.remainingAttempts = this.maxAttempts;
                    this.updateAttemptsDisplay();
                } else {
                    const minutes = Math.floor(timeRemaining / 60000);
                    const seconds = Math.floor((timeRemaining % 60000) / 1000);
                    errorElement.textContent = `Too many failed attempts. Please try again in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        updateAttemptsDisplay() {
            const attemptsElement = document.getElementById('loginAttempts');
            
            if (this.isLocked) {
                attemptsElement.style.display = 'none';
            } else {
                attemptsElement.style.display = 'block';
                attemptsElement.textContent = `Attempts remaining: ${this.remainingAttempts}`;
                
                // Color code based on attempts
                if (this.remainingAttempts <= 2) {
                    attemptsElement.style.color = '#e74c3c';
                    attemptsElement.style.fontWeight = 'bold';
                } else if (this.remainingAttempts <= 3) {
                    attemptsElement.style.color = '#f39c12';
                } else {
                    attemptsElement.style.color = '#f39c12';
                }
            }
        }
        
        loginSuccess(email, fromSession = false) {
            // Reset attempts
            this.remainingAttempts = this.maxAttempts;
            localStorage.removeItem('lavmis_attempts');
            localStorage.removeItem('lavmis_lockout');
            
            // Show main app
            this.showMainApp(email);
            
            // Log the login
            if (!fromSession && typeof logger !== 'undefined') {
                logger.addLogEntry(`User "${email}" logged in successfully`, "success");
            }
        }
        
        showMainApp(email) {
            // Hide login modal
            document.getElementById('loginModal').style.display = 'none';
            
            // Show main content
            document.getElementById('mainContent').style.display = 'flex';
            
            // Update user info in status bar
            document.getElementById('loggedInUser').textContent = email;
            
            // Initialize the main application
            initializeApp();
        }
        
        initiateLogout() {
            if (this.autoBackupInProgress) {
                return;
            }
            
            this.isLoggingOut = true;
            
            // Check if there's data to backup
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            
            if (db.length === 0) {
                // No data to backup, proceed with logout
                this.confirmLogoutWithoutBackup();
            } else {
                // Show backup confirmation modal
                this.showBackupConfirmationModal();
            }
        }
        
        showBackupConfirmationModal() {
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            const backupCount = db.length;
            
            // Show backup progress modal
            const modal = document.getElementById('backupProgressModal');
            const recordCount = document.getElementById('backupRecordCount');
            const backupSize = document.getElementById('backupSize');
            const cancelBtn = document.getElementById('cancelBackupBtn');
            
            // Update stats
            recordCount.textContent = backupCount;
            
            // Calculate approximate size
            const dataStr = JSON.stringify(db);
            const sizeInMB = (new Blob([dataStr]).size / 1024 / 1024).toFixed(2);
            backupSize.textContent = `${sizeInMB} MB`;
            
            // Show modal
            modal.style.display = 'flex';
            
            // Update cancel button text
            cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i> Skip Backup & Logout';
            cancelBtn.onclick = () => {
                this.confirmLogoutWithoutBackup();
            };
            
            // Start backup process
            this.createBackupForLogout();
        }
        
        createBackupForLogout() {
            this.autoBackupInProgress = true;
            
            const progressFill = document.getElementById('backupProgressFill');
            const progressText = document.getElementById('backupProgressText');
            const continueBtn = document.getElementById('continueLogoutBtn');
            const backupSuccess = document.getElementById('backupSuccess');
            const backupFileName = document.getElementById('backupFileName');
            
            // Reset UI
            progressFill.style.width = '0%';
            progressText.textContent = 'Starting backup process...';
            continueBtn.style.display = 'none';
            backupSuccess.style.display = 'none';
            
            // Simulate backup progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressFill.style.width = `${progress}%`;
                
                if (progress <= 30) {
                    progressText.textContent = 'Collecting property data...';
                } else if (progress <= 60) {
                    progressText.textContent = 'Processing evidence photos...';
                } else if (progress <= 90) {
                    progressText.textContent = 'Creating backup file...';
                } else {
                    progressText.textContent = 'Finalizing backup...';
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    
                    // Create actual backup
                    this.performActualBackup().then((filename) => {
                        // Show success message
                        progressText.textContent = 'Backup completed successfully!';
                        backupSuccess.style.display = 'block';
                        backupFileName.textContent = `Backup saved as: ${filename}`;
                        
                        // Show continue button
                        continueBtn.style.display = 'block';
                        
                        // Log the backup
                        if (typeof logger !== 'undefined') {
                            const email = document.getElementById('loggedInUser').textContent;
                            logger.addLogEntry(`Auto-backup created before logout: ${filename}`, "success");
                        }
                        
                        this.autoBackupInProgress = false;
                    }).catch((error) => {
                        progressText.textContent = `Backup failed: ${error.message}`;
                        progressText.style.color = '#e74c3c';
                        this.autoBackupInProgress = false;
                        
                        // Still show continue button
                        continueBtn.style.display = 'block';
                        continueBtn.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> Logout Anyway';
                    });
                }
            }, 200);
        }
        
        performActualBackup() {
            return new Promise((resolve, reject) => {
                try {
                    const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
                    const logs = JSON.parse(localStorage.getItem('lavmis_logs') || '[]');
                    const userEmail = document.getElementById('loggedInUser').textContent;
                    
                    const backup = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        app: 'LAVMIS Pro',
                        userEmail: userEmail,
                        data: db,
                        logs: logs,
                        metadata: {
                            totalRecords: db.length,
                            totalLogs: logs.length,
                            backupType: 'auto_logout'
                        }
                    };
                    
                    const content = JSON.stringify(backup, null, 2);
                    const filename = `lavmis_auto_backup_${userEmail}_${new Date().toISOString().slice(0,10)}_${Date.now()}.json`;
                    
                    // Download file
                    const blob = new Blob([content], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    resolve(filename);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        confirmLogoutWithoutBackup() {
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            
            if (db.length > 0) {
                // Show warning for skipping backup
                if (!confirm(` WARNING: You are about to logout WITHOUT creating a backup!\n\nYou have ${db.length} property records that will NOT be backed up.\n\nAre you sure you want to continue without backing up?`)) {
                    this.isLoggingOut = false;
                    document.getElementById('backupProgressModal').style.display = 'none';
                    return;
                }
            }
            
            // Proceed with logout
            this.finishLogout();
        }
        
        finishLogout() {
            // Hide backup modal
            document.getElementById('backupProgressModal').style.display = 'none';
            
            // Sign out from Firebase
            if (firebaseAuth) {
                firebaseAuth.signOut();
            }
            
            // Log the logout
            if (typeof logger !== 'undefined') {
                const email = document.getElementById('loggedInUser').textContent;
                logger.addLogEntry(`User "${email}" logged out`, "info");
            }
            
            // Reset application state
            resetAppState();
            
            // Show login modal again
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            // Reset login form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').textContent = '';
            
            // Reset logout state
            this.isLoggingOut = false;
            this.autoBackupInProgress = false;
            
            // Focus on username
            setTimeout(() => document.getElementById('username').focus(), 100);
        }
        
        cancelBackup() {
            document.getElementById('backupProgressModal').style.display = 'none';
            this.autoBackupInProgress = false;
            this.isLoggingOut = false;
        }
    }

    // ==============================================
    // LOGGING SYSTEM
    // ==============================================
    class Logger {
        constructor() {
            this.maxLogEntries = 100;
            this.logContainer = document.getElementById('logContent');
            this.initializeLog();
        }
        
        initializeLog() {
            let logs = JSON.parse(localStorage.getItem('lavmis_logs') || '[]');
            logs.forEach(log => this.addLogEntry(log.message, log.type, log.timestamp, false));
        }
        
        addLogEntry(message, type = 'info', timestamp = null, saveToStorage = true) {
            const logEntry = {
                timestamp: timestamp || new Date().toISOString(),
                message: message,
                type: type
            };
            
            // Add to UI
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            logElement.innerHTML = `
                <div class="log-time">${this.formatTime(logEntry.timestamp)}</div>
                <div class="log-message">${message}</div>
            `;
            
            this.logContainer.insertBefore(logElement, this.logContainer.firstChild);
            
            // Limit number of displayed logs
            if (this.logContainer.children.length > this.maxLogEntries) {
                this.logContainer.removeChild(this.logContainer.lastChild);
            }
            
            // Save to storage
            if (saveToStorage) {
                let logs = JSON.parse(localStorage.getItem('lavmis_logs') || '[]');
                logs.unshift(logEntry);
                if (logs.length > this.maxLogEntries) {
                    logs = logs.slice(0, this.maxLogEntries);
                }
                localStorage.setItem('lavmis_logs', JSON.stringify(logs));
            }
            
            // Auto-scroll to top
            this.logContainer.scrollTop = 0;
        }
        
        formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + 
                   ' ' + date.toLocaleDateString([], {month: 'short', day: 'numeric'});
        }
        
        clearLog() {
            if (confirm("Clear all log entries?")) {
                localStorage.removeItem('lavmis_logs');
                this.logContainer.innerHTML = '';
                this.addLogEntry("Log cleared", "info");
            }
        }
    }

    // ==============================================
    // STORAGE MANAGEMENT
    // ==============================================
    class StorageManager {
        constructor() {
            this.updateStorageDisplay();
            setInterval(() => this.updateStorageDisplay(), 30000);
        }
        
        updateStorageDisplay() {
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            document.getElementById('recordCount').textContent = `${db.length} property records`;
            
            const dataSize = this.calculateDataSize();
            const storageFill = document.getElementById('storageFill');
            const storageUsed = document.getElementById('storageUsed');
            const storageTotal = document.getElementById('storageTotal');
            
            storageUsed.textContent = `${dataSize.toFixed(2)} MB`;
            
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    const totalMB = (estimate.quota / 1024 / 1024).toFixed(2);
                    const usedPercent = (dataSize / totalMB * 100);
                    
                    storageTotal.textContent = `${totalMB} MB total`;
                    storageFill.style.width = `${Math.min(usedPercent, 100)}%`;
                });
            }
        }
        
        calculateDataSize() {
            let totalSize = 0;
            
            const db = localStorage.getItem('lavmis_pro_db');
            if (db) {
                totalSize += new Blob([db]).size;
            }
            
            const logs = localStorage.getItem('lavmis_logs');
            if (logs) {
                totalSize += new Blob([logs]).size;
            }
            
            const evidenceData = this.getEvidenceDataSize();
            totalSize += evidenceData;
            
            return totalSize / 1024 / 1024;
        }
        
        getEvidenceDataSize() {
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            let totalSize = 0;
            
            db.forEach(record => {
                if (record.photo) {
                    // If it's a URL, we don't know the size
                    // If it's base64, calculate approximate size
                    if (record.photo.startsWith('data:')) {
                        totalSize += record.photo.length * 0.75;
                    }
                } else if (record.evidence) {
                    // Old base64 evidence field
                    totalSize += record.evidence.length * 0.75;
                }
            });
            
            return totalSize;
        }
        
        backupData(format = 'json') {
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            const logs = JSON.parse(localStorage.getItem('lavmis_logs') || '[]');
            const userEmail = document.getElementById('loggedInUser').textContent;
            
            const backup = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                app: 'LAVMIS Pro',
                userEmail: userEmail,
                data: db,
                logs: logs,
                metadata: {
                    totalRecords: db.length,
                    totalLogs: logs.length
                }
            };
            
            let content, filename, mimeType;
            
            if (format === 'json') {
                content = JSON.stringify(backup, null, 2);
                filename = `lavmis_properties_backup_${new Date().toISOString().slice(0,10)}.json`;
                mimeType = 'application/json';
            } else if (format === 'csv') {
                const csvData = db.map(record => ({
                    'Property ID': record.propertyId,
                    'Property Name': record.propertyName || '',
                    'Registration Type': record.registrationType || '',
                    'Plot Number': record.plotNumber || '',
                    'Block Number': record.blockNumber || '',
                    'District/City': record.districtCity || record.district || '',
                    'Subcounty': record.subcounty || '',
                    'Parish': record.parish || '',
                    'Village': record.village || '',
                    'Description': record.description || '',
                    'Date': record.formattedDate,
                    'Data Source': record.dataSource || '',
                    'Land Use': record.landUse,
                    'Price ($)': record.price,
                    'Size (Ha)': record.size,
                    'Rate ($/Ha)': record.rate,
                    'Latitude': record.latitude,
                    'Longitude': record.longitude,
                    'GPS Accuracy (m)': record.gpsAccuracy || 'N/A',
                    'Location Source': record.positionSource,
                    'Officer Name': record.officerName || '',
                    'Has Evidence': record.photo ? 'Yes' : 'No',
                    'Status': record.status || 'pending',
                    'Rejection Reason': record.rejectionReason || '',
                    'Sync Status': record.syncStatus || 'unknown',
                    'Firebase ID': record.firebaseId || 'N/A'
                }));
                
                const ws = XLSX.utils.json_to_sheet(csvData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "PropertyData");
                content = XLSX.write(wb, { bookType: 'csv', type: 'binary' });
                filename = `lavmis_properties_backup_${new Date().toISOString().slice(0,10)}.csv`;
                mimeType = 'text/csv';
                
                const buffer = new ArrayBuffer(content.length);
                const view = new Uint8Array(buffer);
                for (let i = 0; i < content.length; i++) {
                    view[i] = content.charCodeAt(i) & 0xFF;
                }
                content = buffer;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            logger.addLogEntry(`Property data backed up as ${format.toUpperCase()}`, 'success');
            this.updateStorageDisplay();
        }
        
        restoreData(file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    let restoredData;
                    
                    if (file.name.endsWith('.json')) {
                        restoredData = JSON.parse(content);
                        
                        if (!restoredData.data || !Array.isArray(restoredData.data)) {
                            throw new Error('Invalid backup format');
                        }
                        
                        localStorage.setItem('lavmis_pro_db', JSON.stringify(restoredData.data));
                        
                        if (restoredData.logs && Array.isArray(restoredData.logs)) {
                            localStorage.setItem('lavmis_logs', JSON.stringify(restoredData.logs));
                        }
                        
                    } else if (file.name.endsWith('.csv')) {
                        const workbook = XLSX.read(content, { type: 'binary' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const csvData = XLSX.utils.sheet_to_json(worksheet);
                        
                        const restoredRecords = csvData.map(row => ({
                            id: Date.now() + Math.random(),
                            date: new Date().toISOString(),
                            formattedDate: row.Date || new Date().toLocaleDateString(),
                            propertyId: row['Property ID'] || '',
                            propertyName: row['Property Name'] || '',
                            registrationType: row['Registration Type'] || 'titled',
                            plotNumber: row['Plot Number'] || '',
                            blockNumber: row['Block Number'] || '',
                            districtCity: row['District/City'] || '',
                            district: row['District/City'] || '',
                            subcounty: row.Subcounty || '',
                            parish: row.Parish || '',
                            village: row.Village || '',
                            description: row.Description || '',
                            dataSource: row['Data Source'] || '',
                            landUse: row['Land Use'] || 'Unknown',
                            price: parseFloat(row['Price ($)']) || 0,
                            size: parseFloat(row['Size (Ha)']) || 0,
                            rate: parseFloat(row['Rate ($/Ha)']) || 0,
                            latitude: parseFloat(row.Latitude) || 0,
                            longitude: parseFloat(row.Longitude) || 0,
                            coordinates: `${parseFloat(row.Latitude) || 0}, ${parseFloat(row.Longitude) || 0}`,
                            photo: null,
                            locationMode: 'imported',
                            positionSource: row['Location Source'] || 'CSV Import',
                            gpsAccuracy: row['GPS Accuracy (m)'] || null,
                            officerName: row['Officer Name'] || '',
                            status: row.Status || 'pending',
                            rejectionReason: row['Rejection Reason'] || null,
                            syncStatus: 'pending',
                            firebaseId: row['Firebase ID'] || null
                        }));
                        
                        localStorage.setItem('lavmis_pro_db', JSON.stringify(restoredRecords));
                    }
                    
                    location.reload();
                    logger.addLogEntry(`Property data restored from ${file.name}`, "success");
                    
                } catch (error) {
                    logger.addLogEntry(`Restore failed: ${error.message}`, "error");
                    alert(`Restore failed: ${error.message}`);
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }
        }
        
        clearAllData() {
            if (!confirm(" WARNING: This will delete ALL property data, logs, and markers!\n\nThis includes:\n All saved property records\n All activity logs\n All map markers\n All evidence photos\n\nThis action CANNOT be undone!\n\nClick OK to proceed or Cancel to abort.")) {
                logger.addLogEntry("Clear All Data action cancelled by user", "warning");
                return;
            }
            
            this.showDangerConfirmation(
                "FINAL CONFIRMATION REQUIRED",
                "You are about to permanently delete ALL data. This action cannot be undone. To proceed, type 'DELETE ALL' in the field below.",
                "Delete All Data",
                () => {
                    const db = localStorage.getItem('lavmis_pro_db');
                    const logs = localStorage.getItem('lavmis_logs');
                    
                    sessionStorage.setItem('last_backup_db', db);
                    sessionStorage.setItem('last_backup_logs', logs);
                    
                    localStorage.removeItem('lavmis_pro_db');
                    localStorage.removeItem('lavmis_logs');
                    localStorage.removeItem('lavmis_sync_queue');
                    
                    savedLayer.clearLayers();
                    liveLayer.clearLayers();
                    manualLayer.clearLayers();
                    accuracyLayer.clearLayers();
                    
                    updateTable();
                    logger.logContainer.innerHTML = '';
                    logger.addLogEntry(" ALL PROPERTY DATA CLEARED - This action was intentionally confirmed by user", "error");
                    this.updateStorageDisplay();
                    
                    if (firebaseDataManager) {
                        firebaseDataManager.updateSyncStats();
                    }
                    
                    setTimeout(() => {
                        const undo = confirm(" All data has been cleared successfully!\n\nYou have a brief window to UNDO this action.\n\nClick OK to UNDO (restore data)\nClick Cancel to keep data cleared");
                        
                        if (undo) {
                            this.undoClear();
                        } else {
                            logger.addLogEntry("Data clearing confirmed - no undo requested", "warning");
                            sessionStorage.removeItem('last_backup_db');
                            sessionStorage.removeItem('last_backup_logs');
                        }
                    }, 100);
                }
            );
        }
        
        showDangerConfirmation(title, message, confirmText, callback) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay danger-confirmation';
            modal.style.display = 'flex';
            modal.style.zIndex = '5000';
            
            modal.innerHTML = `
                <div class="modal danger-modal">
                    <h3><i class="fa-solid fa-triangle-exclamation"></i> ${title}</h3>
                    <p style="margin: 20px 0; font-size: 0.9rem; line-height: 1.5; color: #2c3e50;">${message}</p>
                    
                    <div class="field-group" style="margin: 20px 0;">
                        <label for="confirmationInput">Type <span style="color: #e74c3c; font-weight: bold;">DELETE ALL</span> to confirm:</label>
                        <input type="text" id="confirmationInput" placeholder="Type DELETE ALL here" 
                               style="text-align: center; font-weight: bold; border: 2px solid #e74c3c;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                        <button onclick="this.closest('.modal-overlay').remove()" class="secondary">
                            <i class="fa-solid fa-times"></i> Cancel
                        </button>
                        <button id="confirmDangerBtn" class="danger-btn" disabled>
                            <i class="fa-solid fa-check"></i> ${confirmText}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const input = document.getElementById('confirmationInput');
            const confirmBtn = document.getElementById('confirmDangerBtn');
            
            input.addEventListener('input', function() {
                confirmBtn.disabled = this.value !== 'DELETE ALL';
            });
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value === 'DELETE ALL') {
                    callback();
                    modal.remove();
                }
            });
            
            confirmBtn.addEventListener('click', function() {
                if (input.value === 'DELETE ALL') {
                    callback();
                    modal.remove();
                }
            });
            
            setTimeout(() => input.focus(), 100);
        }
        
        undoClear() {
            const db = sessionStorage.getItem('last_backup_db');
            const logs = sessionStorage.getItem('last_backup_logs');
            
            if (db) {
                localStorage.setItem('lavmis_pro_db', db);
                const parsedDb = JSON.parse(db);
                parsedDb.forEach(plotPoint);
                updateTable();
            }
            
            if (logs) {
                localStorage.setItem('lavmis_logs', logs);
                logger.initializeLog();
            }
            
            logger.addLogEntry("Property data restore completed", "success");
            this.updateStorageDisplay();
            
            if (firebaseDataManager) {
                firebaseDataManager.updateSyncStats();
            }
        }
    }

    // ==============================================
    // APPLICATION INITIALIZATION
    // ==============================================
    function initializeApp() {
        map = L.map('map', { 
            zoomControl: false,
            zoomSnap: 0.1,
            zoomDelta: 0.5
        }).setView([0.3476, 32.5825], 13);
        
        savedLayer = L.featureGroup().addTo(map);
        liveLayer = L.layerGroup().addTo(map);
        manualLayer = L.layerGroup().addTo(map);
        accuracyLayer = L.layerGroup().addTo(map);
        
        satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            useCache: true,
            crossOrigin: true,
            cacheMaxAge: 604800000
        }).addTo(map);
        
        initializeGeographicalDropdowns();
        generatePropertyId();
        
        logger = new Logger();
        logger.addLogEntry("LAVMIS Pro application started", "success");
        
        storageManager = new StorageManager();
        firebaseDataManager = new FirebaseDataManager();
        
        let db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        db.forEach(plotPoint);
        updateTable();
        
        setRegistrationType('titled');
        setLocationMode('gps');
        startGPS();
        
        document.getElementById('autoCenterToggle').classList.add('active');
        storageManager.updateStorageDisplay();
        
        map.on('click', function(e) {
            if (locationMode === 'manual' && isManualModeActive) {
                manualPos = [e.latlng.lat, e.latlng.lng];
                
                manualLayer.clearLayers();
                
                manualMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'manual-marker',
                        html: `<div style="
                            width: 32px;
                            height: 32px;
                            background: rgba(142, 68, 173, 0.8);
                            border: 3px solid white;
                            border-radius: 50%;
                            box-shadow: 0 0 10px rgba(142, 68, 173, 0.8);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                        "><i class="fa-solid fa-map-pin"></i></div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    }),
                    zIndexOffset: 1000
                }).addTo(manualLayer);
                
                updateCoordinatesDisplay(manualPos[0], manualPos[1], 'Selected Point');
                
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('clearPointBtn').disabled = false;
                
                map.setView(e.latlng, Math.max(map.getZoom(), 16));
                
                logger.addLogEntry("Point selected on map: " + manualPos.map(c => c.toFixed(6)).join(", "), "info");
            }
        });
        
        const email = document.getElementById('loggedInUser').textContent;
        logger.addLogEntry(`User "${email}" logged in successfully`, "success");
        
        setupBeforeUnloadHandler();
    }
    
    function setupBeforeUnloadHandler() {
        window.addEventListener('beforeunload', function(e) {
            const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            if (db.length > 0 && !loginSystem.isLoggingOut) {
                showAutoBackupNotification();
                
                try {
                    const emergencyBackup = {
                        timestamp: Date.now(),
                        data: db,
                        recordCount: db.length
                    };
                    sessionStorage.setItem('lavmis_emergency_backup', JSON.stringify(emergencyBackup));
                } catch (error) {
                    console.error('Failed to create emergency backup:', error);
                }
                
                e.preventDefault();
                e.returnValue = 'You have unsaved data. A backup has been created.';
                return 'You have unsaved data. A backup has been created.';
            }
        });
    }
    
    function showAutoBackupNotification() {
        const notification = document.getElementById('autoBackupNotification');
        notification.style.display = 'flex';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 2000);
    }
    
    function resetAppState() {
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
            gpsWatchId = null;
        }
        
        currentPos = null;
        currentAccuracy = null;
        manualPos = null;
        evidencePhoto = null;
        manualMarker = null;
        isManualModeActive = false;
        autoCenterEnabled = true;
        lastGpsUpdate = null;
        
        if (map) {
            map.remove();
            map = null;
        }
        
        savedLayer = null;
        liveLayer = null;
        manualLayer = null;
        accuracyLayer = null;
        
        logger = null;
        storageManager = null;
        satellite = null;
        
        if (firebaseDataManager) {
            firebaseDataManager.stopFeedbackListener();
        }
        firebaseDataManager = null;
        currentFirebaseUser = null;
        currentRejection = null;
        currentlyEditingRecordId = null;
        
        cleanupNotificationListener();
    }

    // ==============================================
    // GPS FUNCTIONS
    // ==============================================
    function startGPS() {
        if (!navigator.geolocation) {
            updateGpsStatus(null);
            logger.addLogEntry("GPS hardware not available", "error");
            alert("GPS is not available on this device.");
            return;
        }
        
        const options = {
            enableHighAccuracy: true,
            maximumAge: 2000,
            timeout: 10000
        };
        
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
        }
        
        gpsWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const timestamp = position.timestamp;
                
                currentPos = [lat, lng];
                lastGpsUpdate = timestamp;
                
                if (!lastGpsUpdate || (timestamp - lastGpsUpdate) > 30000) {
                    logger.addLogEntry(`GPS position updated: ${accuracy.toFixed(1)}m accuracy`, "info");
                    lastGpsUpdate = timestamp;
                }
                
                updateGpsStatus(accuracy, currentPos);
                
                if (locationMode === 'gps') {
                    liveLayer.clearLayers();
                    
                    L.circleMarker(currentPos, {
                        radius: 8,
                        color: '#fff',
                        fillColor: '#3498db',
                        fillOpacity: 0.9,
                        weight: 2
                    }).addTo(liveLayer);
                    
                    updateCoordinatesDisplay(currentPos[0], currentPos[1], 'GPS Location', accuracy);
                    
                    if (autoCenterEnabled) {
                        map.setView(currentPos, Math.max(map.getZoom(), 16));
                    }
                }
            },
            (error) => {
                console.error('GPS Error:', error);
                
                let errorMsg = 'GPS Error: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'GPS permission denied. Please enable location services.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'GPS position unavailable. Check device GPS.';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'GPS timeout. Retrying...';
                        setTimeout(startGPS, 1000);
                        break;
                    default:
                        errorMsg = `GPS Error: ${error.message}`;
                }
                
                logger.addLogEntry(errorMsg, "error");
                updateGpsStatus(null);
                updateCoordinatesDisplay(null, null, errorMsg);
                
                if (currentPos) {
                    liveLayer.clearLayers();
                    L.circleMarker(currentPos, {
                        radius: 8,
                        color: '#fff',
                        fillColor: '#e74c3c',
                        fillOpacity: 0.7,
                        weight: 2
                    }).addTo(liveLayer);
                    updateCoordinatesDisplay(currentPos[0], currentPos[1], 'Last Known Location', currentAccuracy);
                }
            },
            options
        );
    }
    
    function updateGpsStatus(accuracy, position = null) {
        const accuracyText = document.getElementById('gpsAccuracy');
        const accuracyFill = document.getElementById('gpsAccuracyFill');
        const gpsIcon = document.getElementById('gpsIcon');
        const statusText = document.getElementById('gpsStatusText');
        const statusDetail = document.getElementById('gpsStatusDetail');
        const saveBtn = document.getElementById('saveBtn');
        
        currentAccuracy = accuracy;
        
        if (accuracy === null) {
            accuracyText.textContent = '-- m';
            accuracyFill.style.width = '0%';
            accuracyFill.style.background = '#e74c3c';
            gpsIcon.className = 'fa-solid fa-satellite-slash';
            statusText.textContent = 'GPS Not Available';
            statusDetail.textContent = 'Waiting for GPS signal...';
            saveBtn.disabled = true;
            return;
        }
        
        accuracyText.textContent = `${accuracy.toFixed(1)} m`;
        
        let accuracyPercent;
        if (accuracy <= 3) {
            accuracyPercent = 100;
        } else if (accuracy >= 50) {
            accuracyPercent = 0;
        } else {
            accuracyPercent = Math.max(0, 100 - ((accuracy - 3) / 47 * 100));
        }
        
        accuracyFill.style.width = `${accuracyPercent}%`;
        
        if (accuracy >= 3 && accuracy <= 20) {
            accuracyFill.style.background = '#27ae60';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'GPS Ready';
            statusDetail.textContent = 'Good accuracy for data collection';
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
        } else if (accuracy < 3) {
            accuracyFill.style.background = '#f39c12';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'High Accuracy';
            statusDetail.textContent = 'Accuracy too high (possible mock location)';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Accuracy Too High';
        } else if (accuracy <= 30) {
            accuracyFill.style.background = '#f39c12';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'Moderate Accuracy';
            statusDetail.textContent = 'Move for better GPS signal';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> WAIT FOR BETTER GPS';
        } else {
            accuracyFill.style.background = '#e74c3c';
            gpsIcon.className = 'fa-solid fa-satellite';
            statusText.textContent = 'Poor Accuracy';
            statusDetail.textContent = 'Move to open area for better GPS';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> NEED BETTER GPS';
        }
        
        if (position) {
            updateAccuracyCircle(position, accuracy);
        }
    }
    
    function updateAccuracyCircle(position, accuracy) {
        accuracyLayer.clearLayers();
        
        if (accuracy && accuracy <= 100) {
            const circle = L.circle(position, {
                radius: accuracy,
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.1,
                weight: 1,
                dashArray: '5, 5'
            }).addTo(accuracyLayer);
            
            L.marker(position, {
                icon: L.divIcon({
                    className: 'accuracy-label',
                    html: `<div style="
                        background: rgba(52, 152, 219, 0.8);
                        color: white;
                        padding: 2px 6px;
                        border-radius: 10px;
                        font-size: 10px;
                        white-space: nowrap;
                    ">${accuracy.toFixed(1)}m</div>`,
                    iconSize: [60, 20],
                    iconAnchor: [30, 20]
                })
            }).addTo(accuracyLayer);
        }
    }
    
    function centerOnGPS() {
        if (currentPos) {
            map.setView(currentPos, Math.max(map.getZoom(), 16));
            logger.addLogEntry("Map centered on current GPS position", "info");
        } else {
            alert("No GPS position available. Waiting for GPS signal...");
        }
    }
    
    function toggleAutoCenter() {
        autoCenterEnabled = !autoCenterEnabled;
        const toggleBtn = document.getElementById('autoCenterToggle');
        
        if (autoCenterEnabled) {
            toggleBtn.classList.add('active');
            toggleBtn.title = 'Auto-center ON - Click to disable';
            logger.addLogEntry("Auto-center enabled", "info");
            
            if (currentPos) {
                map.setView(currentPos, Math.max(map.getZoom(), 16));
            }
        } else {
            toggleBtn.classList.remove('active');
            toggleBtn.title = 'Auto-center OFF - Click to enable';
            logger.addLogEntry("Auto-center disabled", "info");
        }
    }

    // ==============================================
    // LOCATION MODE FUNCTIONS
    // ==============================================
    function setLocationMode(mode) {
        locationMode = mode;
        isManualModeActive = (mode === 'manual');
        
        document.getElementById('gpsToggle').classList.toggle('active', mode === 'gps');
        document.getElementById('manualToggle').classList.toggle('active', mode === 'manual');
        
        const saveBtn = document.getElementById('saveBtn');
        if (mode === 'manual') {
            saveBtn.disabled = !manualPos;
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
            logger.addLogEntry("Switched to manual point selection mode", "info");
        } else {
            saveBtn.disabled = !(currentAccuracy && currentAccuracy >= 3 && currentAccuracy <= 20);
            if (!saveBtn.disabled) {
                saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
            }
            logger.addLogEntry("Switched to GPS auto mode", "info");
        }
        
        if (mode === 'manual') {
            accuracyLayer.clearLayers();
        }
        
        if (mode === 'gps' && currentPos) {
            updateCoordinatesDisplay(currentPos[0], currentPos[1], 'GPS Location', currentAccuracy);
        } else if (mode === 'manual' && manualPos) {
            updateCoordinatesDisplay(manualPos[0], manualPos[1], 'Selected Point');
        } else if (mode === 'manual') {
            updateCoordinatesDisplay(null, null, 'Click on map to select a point');
        }
        
        document.getElementById('map').style.cursor = mode === 'manual' ? 'crosshair' : 'default';
    }
    
    function clearManualPoint() {
        manualPos = null;
        manualMarker = null;
        manualLayer.clearLayers();
        document.getElementById('clearPointBtn').disabled = true;
        document.getElementById('saveBtn').disabled = true;
        updateCoordinatesDisplay(null, null, 'Click on map to select a point');
        logger.addLogEntry("Manual point cleared", "info");
    }
    
    function updateCoordinatesDisplay(lat, lng, source, accuracy = null) {
        const coordDisplay = document.getElementById('coordinates');
        
        if (lat !== null && lng !== null) {
            let html = `<div style="font-weight: 600; color: var(--primary);"><i class="fa-solid fa-map-pin"></i> ${source}</div>
                <div style="color: #27ae60; font-weight: bold; margin-top: 6px; font-size: 0.9rem;">
                    ${lat.toFixed(6)}, ${lng.toFixed(6)}
                </div>`;
            
            if (accuracy !== null) {
                html += `<div style="font-size: 0.75rem; color: ${getAccuracyColor(accuracy)}; margin-top: 4px; font-weight: 500;">
                    Accuracy: ${accuracy.toFixed(1)}m
                </div>`;
            }
            
            coordDisplay.innerHTML = html;
        } else {
            coordDisplay.innerHTML = `
                <div style="font-weight: 600; color: var(--primary);"><i class="fa-solid fa-info-circle"></i> ${source || 'Waiting for location...'}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 6px;">
                    ${locationMode === 'gps' ? 'Waiting for GPS signal' : 'Click on map to select a point'}
                </div>
            `;
        }
    }
    
    function getAccuracyColor(accuracy) {
        if (accuracy >= 3 && accuracy <= 20) return '#27ae60';
        if (accuracy < 3) return '#f39c12';
        if (accuracy <= 30) return '#f39c12';
        return '#e74c3c';
    }

    // ==============================================
    // EVIDENCE PHOTO HANDLING WITH COMPRESSION AND FIREBASE STORAGE
    // ==============================================
    function capturePhoto() {
        document.getElementById('photoInput').click();
    }
    
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    const max_size = 1024;
                    if (width > height) {
                        if (width > max_size) {
                            height *= max_size / width;
                            width = max_size;
                        }
                    } else {
                        if (height > max_size) {
                            width *= max_size / height;
                            height = max_size;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Save as base64 for local preview
                    evidencePhoto = canvas.toDataURL('image/jpeg', 0.7);

                    document.getElementById('imagePreview').src = evidencePhoto;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('removePhotoBtn').style.display = 'block';
                    
                    const sizeInKb = Math.round((evidencePhoto.length * 3 / 4) / 1024);
                    logger.addLogEntry(`Photo compressed to approx. ${sizeInKb}KB`, "success");
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }
    
    function removePhoto() {
        evidencePhoto = null;
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('removePhotoBtn').style.display = 'none';
        document.getElementById('photoInput').value = '';
        logger.addLogEntry("Evidence photo removed", "info");
    }

    // ==============================================
    // DATA SAVING FUNCTION WITH RESUBMISSION LOGIC AND ROBUST FIREBASE STORAGE
    // ==============================================
    async function saveData() {
        let position;
        let positionSource;
        let accuracy = null;
        
        if (locationMode === 'gps') {
            if (!currentPos) {
                alert("Waiting for GPS signal...");
                return;
            }
            
            if (!currentAccuracy || currentAccuracy < 3 || currentAccuracy > 20) {
                alert(`GPS accuracy (${currentAccuracy ? currentAccuracy.toFixed(1) : 'unknown'}m) is outside required range (3-20m).\n\nPlease move to an open area and wait for better GPS accuracy.`);
                return;
            }
            
            position = currentPos;
            positionSource = 'GPS';
            accuracy = currentAccuracy;
        } else {
            if (!manualPos) {
                alert("Please select a point on the map first.");
                return;
            }
            position = manualPos;
            positionSource = 'Manual Selection';
        }

        // Get manual entry values if used
        const districtCity = document.getElementById('districtCityManual').style.display === 'block' 
            ? document.getElementById('districtCityManual').value.trim()
            : document.getElementById('districtCity').value.trim();
        
        const subcounty = document.getElementById('subcountyManual').style.display === 'block'
            ? document.getElementById('subcountyManual').value.trim()
            : document.getElementById('subcounty').value.trim();
        
        const parish = document.getElementById('parishManual').style.display === 'block'
            ? document.getElementById('parishManual').value.trim()
            : document.getElementById('parish').value.trim();
        
        const village = document.getElementById('villageManual').style.display === 'block'
            ? document.getElementById('villageManual').value.trim()
            : document.getElementById('village').value.trim();

        // Validate required fields
        const propertyId = document.getElementById('propertyId').value.trim();
        const propertyName = document.getElementById('propertyName').value.trim();
        const plotNumber = document.getElementById('plotNumber').value.trim();
        const blockNumber = document.getElementById('blockNumber').value.trim();
        const description = document.getElementById('description').value.trim();
        const dataSource = document.getElementById('dataSource').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const size = parseFloat(document.getElementById('size').value);
        const landUse = document.getElementById('use').value;
        const officerName = document.getElementById('officerName').value.trim();
        
        if (!propertyId) {
            alert("Please generate Property ID.");
            return;
        }
        
        if (!districtCity) {
            alert("Please select or enter District/City.");
            return;
        }
        
        if (!subcounty) {
            alert("Please select or enter Subcounty.");
            return;
        }
        
        if (!parish) {
            alert("Please select or enter Parish.");
            return;
        }
        
        if (!village) {
            alert("Please select or enter Village.");
            return;
        }
        
        if (!dataSource) {
            alert("Please select Data Source.");
            return;
        }
        
        if (!price || !size || price <= 0 || size <= 0) {
            alert("Please enter valid price and size values.");
            return;
        }
        
        if (!landUse) {
            alert("Please select Land Use.");
            return;
        }
        
        if (!officerName) {
            alert("Please enter the Name of Officer (Data Collector).");
            return;
        }
        
        if (registrationType === 'titled' && !plotNumber) {
            alert("For titled properties, Plot Number is required.");
            return;
        }

        // Check if we're editing an existing record (resubmission)
        const existingRecord = currentlyEditingRecordId ? 
            JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]').find(r => r.id === currentlyEditingRecordId) : 
            null;
        
        const isResubmission = existingRecord && existingRecord.status === 'rejected';
        
        // Disable save button and show upload status
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        
        let finalPhotoValue = null;
        
        // NEW: ROBUST PHOTO HANDLING LOGIC WITH ONLINE CHECK AND FALLBACK
        if (evidencePhoto && evidencePhoto.startsWith('data:')) {
            // 1. Check if online first
            if (navigator.onLine) {
                try {
                    saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> UPLOADING PHOTO...';
                    
                    // Create a timeout promise (stop waiting after 10 seconds)
                    const timeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Upload timed out")), 10000)
                    );
                    
                    // Race the upload against the timeout
                    finalPhotoValue = await Promise.race([
                        uploadToFirebaseStorage(propertyId, evidencePhoto),
                        timeout
                    ]);
                    
                    logger.addLogEntry(`Photo uploaded to Firebase: ${propertyId}`, "success");
                } catch (error) {
                    console.error(error);
                    logger.addLogEntry(`Upload failed (${error.message}). Saving locally.`, "warning");
                    // Fallback: Save the Base64 image locally so evidence isn't lost
                    finalPhotoValue = evidencePhoto; 
                }
            } else {
                // Offline: Save Base64 image locally immediately
                logger.addLogEntry("Offline: Saving photo locally.", "info");
                finalPhotoValue = evidencePhoto;
            }
        } else if (existingRecord && existingRecord.photo) {
            // Keep existing photo URL/Data
            finalPhotoValue = existingRecord.photo;
        } else if (existingRecord && existingRecord.evidence) {
            // Handle old base64 evidence field for resubmission
            finalPhotoValue = existingRecord.evidence;
        }
        
        saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> SAVING DATA...';
        
        const record = {
            id: existingRecord ? existingRecord.id : Date.now(), // Keep same ID for resubmission
            date: existingRecord ? existingRecord.date : new Date().toISOString(),
            formattedDate: existingRecord ? existingRecord.formattedDate : new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }),
            propertyId: propertyId,
            propertyName: propertyName,
            registrationType: registrationType,
            plotNumber: plotNumber,
            blockNumber: blockNumber,
            districtCity: districtCity,
            district: districtCity,
            subcounty: subcounty,
            parish: parish,
            village: village,
            description: description,
            dataSource: dataSource,
            landUse: landUse,
            price: price,
            size: size,
            rate: (price / size).toFixed(2),
            latitude: position[0].toFixed(6),
            longitude: position[1].toFixed(6),
            coordinates: `${position[0].toFixed(6)}, ${position[1].toFixed(6)}`,
            photo: finalPhotoValue, // Store Firebase Storage URL or local Base64
            photoStoredIn: finalPhotoValue && finalPhotoValue.startsWith('https://') ? 'firebase' : 'local',
            locationMode: locationMode,
            positionSource: positionSource,
            gpsAccuracy: accuracy ? accuracy.toFixed(1) : null,
            officerName: officerName,
            
            // CRITICAL RESUBMISSION LOGIC
            status: 'pending', // Reset to pending for review
            previousStatus: isResubmission ? 'rejected' : null,
            previousRejectionReason: isResubmission ? existingRecord.rejectionReason : null,
            rejectionReason: null, // Clear rejection reason on resubmission
            reviewedBy: null, // Clear reviewer info
            reviewedAt: null, // Clear review date
            resubmittedAt: isResubmission ? new Date().toISOString() : null,
            resubmissionCount: isResubmission ? (existingRecord.resubmissionCount || 0) + 1 : 0,
            
            syncStatus: 'pending',
            firebaseId: existingRecord ? existingRecord.firebaseId : null // Keep same Firebase ID for updates
        };

        // Save to local storage
        let db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        
        if (existingRecord) {
            // Update existing record
            const index = db.findIndex(r => r.id === existingRecord.id);
            if (index !== -1) {
                db[index] = record;
            }
        } else {
            // Add new record
            db.push(record);
        }
        
        localStorage.setItem('lavmis_pro_db', JSON.stringify(db));

        // Save to Firebase
        try {
            if (firebaseDataManager) {
                const existingFirebaseId = existingRecord ? existingRecord.firebaseId : null;
                const result = await firebaseDataManager.savePropertyToFirebase(record, existingFirebaseId);
                
                if (result.firebaseId) {
                    // Update local record with Firebase ID
                    const index = db.findIndex(r => r.id === record.id);
                    if (index !== -1) {
                        db[index].firebaseId = result.firebaseId;
                        db[index].syncStatus = 'synced';
                        db[index].syncedAt = new Date().toISOString();
                        localStorage.setItem('lavmis_pro_db', JSON.stringify(db));
                        
                        updatePropertySyncStatus('synced');
                    }
                } else {
                    // Update local record with queued status
                    const index = db.findIndex(r => r.id === record.id);
                    if (index !== -1) {
                        db[index].syncStatus = 'queued';
                        localStorage.setItem('lavmis_pro_db', JSON.stringify(db));
                        
                        updatePropertySyncStatus('queued');
                    }
                }
            }
        } catch (error) {
            console.error('Firebase save error:', error);
            updatePropertySyncStatus('pending');
        }

        // Update map and table
        if (existingRecord) {
            // Remove old marker and add updated one
            savedLayer.eachLayer(layer => {
                if (layer.recordId === record.id) {
                    savedLayer.removeLayer(layer);
                }
            });
        }
        plotPoint(record);
        updateTable();
        
        // Reset form and editing state
        clearForm();
        resetEditMode();
        
        // Generate new Property ID for next record (unless editing)
        if (!existingRecord) {
            generatePropertyId();
        }
        
        // Clear manual point after saving
        if (locationMode === 'manual') {
            clearManualPoint();
        }
        
        // Update sync stats
        if (firebaseDataManager) {
            firebaseDataManager.updateSyncStats();
        }
        
        // Update storage display
        if (storageManager) {
            storageManager.updateStorageDisplay();
        }
        
        // Reset save button
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
        
        const successMessage = isResubmission ? 
            ` Property record UPDATED and RESUBMITTED for review!\n ID: ${record.propertyId}\n Name: ${record.propertyName || 'Not provided'}\n Plot: ${record.plotNumber || 'Untitled'}\n Location: ${record.coordinates}\n Accuracy: ${accuracy ? accuracy.toFixed(1) + 'm' : 'Manual'}\n Rate: $${record.rate}/Ha\n\nYour corrections have been submitted for re-review.` :
            ` Property record saved and submitted for review!\n ID: ${record.propertyId}\n Name: ${record.propertyName || 'Not provided'}\n Plot: ${record.plotNumber || 'Untitled'}\n Location: ${record.coordinates}\n Accuracy: ${accuracy ? accuracy.toFixed(1) + 'm' : 'Manual'}\n Rate: $${record.rate}/Ha\n\nYour submission will be reviewed by an administrator.`;
        
        alert(successMessage);
        
        // Log appropriate message
        if (isResubmission) {
            logger.addLogEntry(`Property ${record.propertyId} resubmitted for review (Correction #${record.resubmissionCount})`, "success");
        } else {
            logger.addLogEntry(`New property saved: ${record.propertyId}`, "success");
        }
    }
    
    function resetEditMode() {
        currentlyEditingRecordId = null;
        document.getElementById('saveBtn').innerHTML = '<i class="fa-solid fa-save"></i> SAVE PROPERTY RECORD';
        document.getElementById('saveBtn').classList.remove('info');
        document.getElementById('saveBtn').classList.add('success');
    }
    
    function updatePropertySyncStatus(status) {
        const syncStatusElement = document.getElementById('propertySyncStatus');
        if (!syncStatusElement) return;
        
        syncStatusElement.style.display = 'inline-flex';
        
        switch(status) {
            case 'synced':
                syncStatusElement.className = 'sync-status sync-synced';
                syncStatusElement.innerHTML = '<i class="fa-solid fa-cloud-check"></i> Synced';
                break;
            case 'queued':
                syncStatusElement.className = 'sync-status sync-queued';
                syncStatusElement.innerHTML = '<i class="fa-solid fa-clock"></i> Queued';
                break;
            case 'pending':
                syncStatusElement.className = 'sync-status sync-pending';
                syncStatusElement.innerHTML = '<i class="fa-solid fa-hourglass-half"></i> Pending';
                break;
            default:
                syncStatusElement.style.display = 'none';
        }
    }
    
    function clearForm() {
        // Only clear if not in edit mode
        if (!currentlyEditingRecordId) {
            document.getElementById('propertyName').value = '';
            document.getElementById('plotNumber').value = '';
            document.getElementById('blockNumber').value = '';
            
            document.getElementById('districtCity').value = '';
            document.getElementById('districtCityManual').style.display = 'none';
            document.getElementById('districtCity').style.display = 'block';
            document.getElementById('districtCity').disabled = false;
            
            document.getElementById('subcounty').value = '';
            document.getElementById('subcountyManual').style.display = 'none';
            document.getElementById('subcounty').style.display = 'block';
            document.getElementById('subcounty').disabled = true;
            
            document.getElementById('parish').value = '';
            document.getElementById('parishManual').style.display = 'none';
            document.getElementById('parish').style.display = 'block';
            document.getElementById('parish').disabled = true;
            
            document.getElementById('village').value = '';
            document.getElementById('villageManual').style.display = 'none';
            document.getElementById('village').style.display = 'block';
            document.getElementById('village').disabled = true;
            
            document.getElementById('description').value = '';
            document.getElementById('dataSource').selectedIndex = 0;
            document.getElementById('price').value = '';
            document.getElementById('size').value = '';
            document.getElementById('use').selectedIndex = 0;
            document.getElementById('officerName').value = '';
            removePhoto();
            
            updateSubcounties();
            
            const syncStatusElement = document.getElementById('propertySyncStatus');
            if (syncStatusElement) {
                syncStatusElement.style.display = 'none';
            }
        }
    }

    // ==============================================
    // MAPPING FUNCTIONS
    // ==============================================
    function plotPoint(record) {
        let iconColor = getColorForUse(record.landUse);
        let iconClass = 'fa-map-pin';
        
        if (record.status === 'rejected') {
            iconColor = '#e74c3c';
            iconClass = 'fa-ban';
        }
        
        const marker = L.marker([record.latitude, record.longitude], {
            icon: L.divIcon({
                className: 'saved-marker',
                html: `<div style="
                    width: 24px;
                    height: 24px;
                    background: ${iconColor};
                    border: 2px solid white;
                    border-radius: 50%;
                    box-shadow: 0 0 5px rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 10px;
                "><i class="fa-solid ${iconClass}"></i></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            }),
            title: `${record.propertyName || 'Property'} - $${record.rate}/Ha ${record.status === 'rejected' ? '(REJECTED)' : ''}`
        }).addTo(savedLayer);
        
        let syncBadge = '';
        if (record.syncStatus) {
            let syncClass = '';
            let syncIcon = '';
            let syncText = '';
            
            switch(record.syncStatus) {
                case 'synced':
                    syncClass = 'sync-synced';
                    syncIcon = 'fa-cloud-check';
                    syncText = 'Synced';
                    break;
                case 'queued':
                    syncClass = 'sync-queued';
                    syncIcon = 'fa-clock';
                    syncText = 'Queued';
                    break;
                case 'pending':
                    syncClass = 'sync-pending';
                    syncIcon = 'fa-hourglass-half';
                    syncText = 'Pending';
                    break;
            }
            
            if (syncClass) {
                syncBadge = `<div class="sync-status ${syncClass}" style="margin-top: 5px;">
                    <i class="fa-solid ${syncIcon}"></i> ${syncText}
                </div>`;
            }
        }
        
        let rejectionSection = '';
        if (record.status === 'rejected' && record.rejectionReason) {
            rejectionSection = `
                <div style="background: #fdeaea; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 3px solid #e74c3c;">
                    <h5 style="margin: 0 0 5px 0; color: #e74c3c;"><i class="fa-solid fa-exclamation-triangle"></i> REJECTED</h5>
                    <p style="margin: 0; font-size: 0.9rem;"><strong>Reason:</strong> ${record.rejectionReason}</p>
                    ${record.reviewedBy ? `<p style="margin: 5px 0 0 0; font-size: 0.8rem;"><strong>Reviewed by:</strong> ${record.reviewedBy}</p>` : ''}
                    ${record.resubmissionCount ? `<p style="margin: 5px 0 0 0; font-size: 0.8rem;"><strong>Resubmissions:</strong> ${record.resubmissionCount}</p>` : ''}
                </div>
            `;
        } else if (record.resubmissionCount && record.resubmissionCount > 0) {
            rejectionSection = `
                <div style="background: #e8f6ef; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 3px solid #27ae60;">
                    <h5 style="margin: 0 0 5px 0; color: #27ae60;"><i class="fa-solid fa-rotate"></i> RESUBMITTED</h5>
                    <p style="margin: 0; font-size: 0.9rem;"><strong>Correction #${record.resubmissionCount}</strong></p>
                    <p style="margin: 5px 0 0 0; font-size: 0.8rem;"><strong>Previous rejection:</strong> ${record.previousRejectionReason || 'Not specified'}</p>
                </div>
            `;
        }
        
        let popupContent = `
            <div style="min-width: 250px;">
                <h4 style="margin: 0 0 10px 0; color: ${iconColor};">
                    <i class="fa-solid fa-house"></i> ${record.propertyName || 'Property'}
                    ${record.status === 'rejected' ? '<span style="color: #e74c3c; font-size: 0.8em;"> (REJECTED)</span>' : ''}
                    ${record.resubmissionCount && record.resubmissionCount > 0 ? '<span style="color: #27ae60; font-size: 0.8em;"> (RESUBMITTED)</span>' : ''}
                </h4>
                <p><strong>Property ID:</strong> ${record.propertyId}</p>
                <p><strong>Registration:</strong> ${record.registrationType || 'titled'}</p>
                <p><strong>Plot:</strong> ${record.plotNumber || 'N/A'}</p>
                <p><strong>Block:</strong> ${record.blockNumber || 'N/A'}</p>
                <p><strong>Location:</strong> ${record.village}, ${record.parish}</p>
                <p><strong>District/City:</strong> ${record.districtCity}</p>
                <p><strong>Subcounty:</strong> ${record.subcounty}</p>
                <p><strong>Data Source:</strong> ${record.dataSource}</p>
                <p><strong>Land Use:</strong> ${record.landUse}</p>
                <p><strong>Price:</strong> $${record.price}</p>
                <p><strong>Size:</strong> ${record.size} Ha</p>
                <p><strong>Rate:</strong> $${record.rate}/Ha</p>
                <p><strong>Officer:</strong> ${record.officerName}</p>
                <p><strong>Date:</strong> ${record.formattedDate}</p>
                <p><strong>Coordinates:</strong> ${record.coordinates}</p>
                <p><strong>Source:</strong> ${record.positionSource}</p>
                ${record.gpsAccuracy ? `<p><strong>GPS Accuracy:</strong> ${record.gpsAccuracy}m</p>` : ''}
                ${record.description ? `<p><strong>Description:</strong> ${record.description}</p>` : ''}
                ${rejectionSection}
                ${syncBadge}
        `;
        
        if (record.photo) {
            popupContent += `
                <p><strong>Evidence:</strong></p>
                <img src="${record.photo}" style="max-width: 150px; border-radius: 4px; margin-top: 5px;">
            `;
        } else if (record.evidence) {
            // Handle old base64 evidence field
            popupContent += `
                <p><strong>Evidence:</strong></p>
                <img src="${record.evidence}" style="max-width: 150px; border-radius: 4px; margin-top: 5px;">
            `;
        }
        
        popupContent += `
                <hr style="margin: 10px 0;">
                <button onclick="showPreview(${record.id})" style="width: 100%; padding: 5px; background: ${iconColor}; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    View Property Details
                </button>
                ${record.status === 'rejected' ? `
                <button onclick="loadRejectedPropertyIntoForm('${record.propertyId}')" style="width: 100%; padding: 5px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">
                    <i class="fa-solid fa-edit"></i> Edit & Resubmit
                </button>
                ` : ''}
            </div>
        `;
        
        marker.bindPopup(popupContent);
        marker.recordId = record.id;
        
        marker.on('click', function() {
            showPreview(record.id);
        });
    }
    
    function getColorForUse(landUse) {
        const colors = {
            'Residential': '#3498db',
            'Commercial': '#e74c3c',
            'Agricultural': '#27ae60',
            'Industrial': '#f39c12',
            'Recreational': '#9b59b6',
            'Mixed Use': '#8e44ad',
            'Vacant Land': '#95a5a6',
            'Forest': '#16a085',
            'Wetland': '#2980b9'
        };
        return colors[landUse] || '#3498db';
    }
    
    function clearAllMarkers() {
        if (confirm("Are you sure you want to remove all property markers from the map? This won't delete your saved data.")) {
            savedLayer.clearLayers();
            let db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
            db.forEach(plotPoint);
            logger.addLogEntry("All property markers cleared", "warning");
        }
    }

    // ==============================================
    // DATA TABLE AND PREVIEW
    // ==============================================
    function updateTable() {
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = "";
        let db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        
        db.reverse().forEach(item => {
            const row = tbody.insertRow();
            row.dataset.id = item.id;
            
            let syncDisplay = '';
            if (item.syncStatus) {
                switch(item.syncStatus) {
                    case 'synced':
                        syncDisplay = '<span class="sync-status sync-synced" style="font-size: 0.7rem;"><i class="fa-solid fa-cloud-check"></i></span>';
                        break;
                    case 'queued':
                        syncDisplay = '<span class="sync-status sync-queued" style="font-size: 0.7rem;"><i class="fa-solid fa-clock"></i></span>';
                        break;
                    case 'pending':
                        syncDisplay = '<span class="sync-status sync-pending" style="font-size: 0.7rem;"><i class="fa-solid fa-hourglass-half"></i></span>';
                        break;
                    default:
                        syncDisplay = '';
                }
            }
            
            let rejectionIndicator = '';
            if (item.status === 'rejected') {
                rejectionIndicator = ' <span class="sync-status sync-failed" style="font-size: 0.7rem;"><i class="fa-solid fa-ban"></i></span>';
            } else if (item.resubmissionCount && item.resubmissionCount > 0) {
                rejectionIndicator = ' <span class="sync-status sync-queued" style="font-size: 0.7rem;"><i class="fa-solid fa-rotate"></i></span>';
            }
            
            row.innerHTML = `
                <td>${item.propertyId}${rejectionIndicator}</td>
                <td>${item.propertyName || 'Unnamed'}</td>
                <td>${item.plotNumber || 'N/A'}</td>
                <td>$${item.rate}</td>
                <td>${syncDisplay}</td>
                <td>
                    <button onclick="goToLocation(${item.latitude}, ${item.longitude})" title="Go to property location" style="padding: 6px; border-radius: 4px;">
                        <i class="fa-solid fa-location-arrow"></i>
                    </button>
                    <button onclick="showPreview(${item.id})" title="View property details" style="padding: 6px; border-radius: 4px; margin-left: 5px;">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    ${item.status === 'rejected' ? `
                    <button onclick="loadRejectedPropertyIntoForm('${item.propertyId}')" title="Edit & Resubmit" style="padding: 6px; border-radius: 4px; margin-left: 5px; background: #e74c3c; color: white;">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    ` : ''}
                </td>
            `;
            
            row.addEventListener('click', function() {
                showPreview(item.id);
            });
        });
    }
    
    function showPreview(id) {
        let db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        let item = db.find(d => d.id === id);
        if (!item) return;
        
        let photoHtml = '';
        if (item.photo) {
            photoHtml = `
                <div class="preview-item" style="grid-column: span 2;">
                    <div class="preview-label">Evidence Photo</div>
                    <img src="${item.photo}" style="max-width: 150px; border-radius: 8px; margin-top: 5px;">
                    ${item.photoStoredIn === 'local' ? '<div style="font-size: 0.75rem; color: #f39c12; margin-top: 5px;"><i class="fa-solid fa-info-circle"></i> Stored locally (offline mode)</div>' : ''}
                </div>
            `;
        } else if (item.evidence) {
            photoHtml = `
                <div class="preview-item" style="grid-column: span 2;">
                    <div class="preview-label">Evidence Photo</div>
                    <img src="${item.evidence}" style="max-width: 150px; border-radius: 8px; margin-top: 5px;">
                    <div style="font-size: 0.75rem; color: #f39c12; margin-top: 5px;"><i class="fa-solid fa-info-circle"></i> Stored locally (legacy format)</div>
                </div>
            `;
        }
        
        let rejectionHtml = '';
        if (item.status === 'rejected' && item.rejectionReason) {
            rejectionHtml = `
                <div class="preview-item" style="grid-column: span 2; background: #fdeaea; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #e74c3c;">
                    <div class="preview-label" style="color: #e74c3c; font-weight: bold;"><i class="fa-solid fa-exclamation-triangle"></i> REJECTED</div>
                    <div class="preview-value" style="color: #e74c3c;">${item.rejectionReason}</div>
                    ${item.reviewedBy ? `<div class="preview-value" style="font-size: 0.8rem; margin-top: 5px;"><strong>Reviewed by:</strong> ${item.reviewedBy}</div>` : ''}
                </div>
            `;
        } else if (item.resubmissionCount && item.resubmissionCount > 0) {
            rejectionHtml = `
                <div class="preview-item" style="grid-column: span 2; background: #e8f6ef; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #27ae60;">
                    <div class="preview-label" style="color: #27ae60; font-weight: bold;"><i class="fa-solid fa-rotate"></i> RESUBMITTED (Correction #${item.resubmissionCount})</div>
                    ${item.previousRejectionReason ? `<div class="preview-value" style="font-size: 0.8rem; margin-top: 5px;"><strong>Previous rejection:</strong> ${item.previousRejectionReason}</div>` : ''}
                </div>
            `;
        }
        
        let syncHtml = '';
        if (item.syncStatus) {
            let syncColor = '';
            let syncText = '';
            switch(item.syncStatus) {
                case 'synced':
                    syncColor = '#27ae60';
                    syncText = 'Synced to Firebase';
                    break;
                case 'queued':
                    syncColor = '#f39c12';
                    syncText = 'Queued for sync';
                    break;
                case 'pending':
                    syncColor = '#f39c12';
                    syncText = 'Pending sync';
                    break;
            }
            if (syncText) {
                syncHtml = `
                    <div class="preview-item" style="grid-column: span 2;">
                        <div class="preview-label">Sync Status</div>
                        <div class="preview-value" style="color: ${syncColor};">
                            <i class="fa-solid fa-cloud"></i> ${syncText}
                        </div>
                    </div>
                `;
            }
        }
        
        document.getElementById('previewContent').innerHTML = `
            <div class="preview-item">
                <div class="preview-label">Property ID</div>
                <div class="preview-value">${item.propertyId}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Property Name</div>
                <div class="preview-value">${item.propertyName || 'Not provided'}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Registration Type</div>
                <div class="preview-value">${item.registrationType || 'titled'}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Plot Number</div>
                <div class="preview-value">${item.plotNumber || 'N/A'}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Block Number</div>
                <div class="preview-value">${item.blockNumber || 'N/A'}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">District/City</div>
                <div class="preview-value">${item.districtCity}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Subcounty</div>
                <div class="preview-value">${item.subcounty}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Parish</div>
                <div class="preview-value">${item.parish}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Village</div>
                <div class="preview-value">${item.village}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Data Source</div>
                <div class="preview-value">${item.dataSource}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Land Use</div>
                <div class="preview-value">${item.landUse}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Total Price</div>
                <div class="preview-value">$${item.price}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Size</div>
                <div class="preview-value">${item.size} Ha</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Rate per Ha</div>
                <div class="preview-value">$${item.rate}/Ha</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Coordinates</div>
                <div class="preview-value">${item.coordinates}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Location Source</div>
                <div class="preview-value">${item.positionSource}</div>
            </div>
            ${item.gpsAccuracy ? `
            <div class="preview-item">
                <div class="preview-label">GPS Accuracy</div>
                <div class="preview-value">${item.gpsAccuracy}m</div>
            </div>
            ` : ''}
            <div class="preview-item">
                <div class="preview-label">Officer Name</div>
                <div class="preview-value">${item.officerName}</div>
            </div>
            <div class="preview-item">
                <div class="preview-label">Date</div>
                <div class="preview-value">${item.formattedDate}</div>
            </div>
            ${item.description ? `
            <div class="preview-item" style="grid-column: span 2;">
                <div class="preview-label">Description</div>
                <div class="preview-value">${item.description}</div>
            </div>
            ` : ''}
            ${photoHtml}
            ${rejectionHtml}
            ${syncHtml}
        `;
        
        document.getElementById('dataPreview').style.display = 'block';
    }
    
    function hidePreview() {
        document.getElementById('dataPreview').style.display = 'none';
    }
    
    function goToLocation(lat, lng) {
        map.setView([lat, lng], 18);
        logger.addLogEntry(`Map centered on property at ${lat.toFixed(6)}, ${lng.toFixed(6)}`, "info");
    }

    // ==============================================
    // EXPORT FUNCTIONS
    // ==============================================
    function exportData() {
        const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        if (db.length === 0) {
            alert("No data to export.");
            return;
        }
        
        const wb = XLSX.utils.book_new();
        const ws_data = [
            ["Property ID", "Property Name", "Registration Type", "Plot Number", "Block Number", 
             "District/City", "Subcounty", "Parish", "Village", "Description", 
             "Data Source", "Land Use", "Price ($)", "Size (Ha)", "Rate ($/Ha)", 
             "Latitude", "Longitude", "GPS Accuracy (m)", "Location Source", 
             "Officer Name", "Date", "Status", "Rejection Reason", "Sync Status", "Firebase ID"]
        ];
        
        db.forEach(item => {
            ws_data.push([
                item.propertyId,
                item.propertyName || '',
                item.registrationType || 'titled',
                item.plotNumber || '',
                item.blockNumber || '',
                item.districtCity || '',
                item.subcounty || '',
                item.parish || '',
                item.village || '',
                item.description || '',
                item.dataSource || '',
                item.landUse || '',
                item.price,
                item.size,
                item.rate,
                item.latitude,
                item.longitude,
                item.gpsAccuracy || 'N/A',
                item.positionSource,
                item.officerName || '',
                item.formattedDate,
                item.status || 'pending',
                item.rejectionReason || '',
                item.syncStatus || 'unknown',
                item.firebaseId || 'N/A'
            ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Property Data");
        
        const date = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `lavmis_export_${date}.xlsx`);
        
        logger.addLogEntry(`Exported ${db.length} records to Excel`, "success");
    }
    
    function exportGeoJSON() {
        const db = JSON.parse(localStorage.getItem('lavmis_pro_db') || '[]');
        if (db.length === 0) {
            alert("No data to export.");
            return;
        }
        
        const features = db.map(item => ({
            type: "Feature",
            geometry: {
                type: "Point",
                coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
            },
            properties: {
                propertyId: item.propertyId,
                propertyName: item.propertyName || '',
                registrationType: item.registrationType || 'titled',
                plotNumber: item.plotNumber || '',
                blockNumber: item.blockNumber || '',
                districtCity: item.districtCity || '',
                subcounty: item.subcounty || '',
                parish: item.parish || '',
                village: item.village || '',
                description: item.description || '',
                dataSource: item.dataSource || '',
                landUse: item.landUse || '',
                price: item.price,
                size: item.size,
                rate: item.rate,
                gpsAccuracy: item.gpsAccuracy || null,
                positionSource: item.positionSource,
                officerName: item.officerName || '',
                date: item.formattedDate,
                status: item.status || 'pending',
                rejectionReason: item.rejectionReason || '',
                syncStatus: item.syncStatus || 'unknown',
                firebaseId: item.firebaseId || null
            }
        }));
        
        const geoJSON = {
            type: "FeatureCollection",
            features: features
        };
        
        const content = JSON.stringify(geoJSON, null, 2);
        const blob = new Blob([content], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lavmis_geojson_${new Date().toISOString().slice(0,10)}.geojson`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        logger.addLogEntry(`Exported ${db.length} records as GeoJSON`, "success");
    }

    // ==============================================
    // MODAL FUNCTIONS
    // ==============================================
    function showBackupModal() {
        document.getElementById('backupModal').style.display = 'flex';
    }
    
    function showRestoreModal() {
        document.getElementById('restoreModal').style.display = 'flex';
    }
    
    function hideModal() {
        document.getElementById('backupModal').style.display = 'none';
        document.getElementById('restoreModal').style.display = 'none';
    }
    
    function backupData(format) {
        storageManager.backupData(format);
        hideModal();
    }
    
    function restoreData() {
        const fileInput = document.getElementById('restoreFile');
        if (fileInput.files.length === 0) {
            alert("Please select a backup file first.");
            return;
        }
        
        if (!confirm("This will replace all existing data. Are you sure?")) {
            return;
        }
        
        storageManager.restoreData(fileInput.files[0]);
        hideModal();
    }
    
    function backupToFirebase() {
        if (!firebaseDataManager || !firebaseDataManager.userId) {
            alert("Please log in to backup to Firebase.");
            hideModal();
            return;
        }
        
        if (confirm("This will backup all your data to Firebase Cloud. Continue?")) {
            firebaseDataManager.backupAllToFirebase()
                .then(result => {
                    alert(`Backup completed successfully!\n\nRecord count: ${result.recordCount}\nSynced: ${result.syncedCount}\nBackup ID: ${result.backupId}`);
                })
                .catch(error => {
                    alert(`Backup failed: ${error.message}`);
                });
        }
        hideModal();
    }
    
    function restoreFromFirebase() {
        if (!firebaseDataManager || !firebaseDataManager.userId) {
            alert("Please log in to restore from Firebase.");
            hideModal();
            return;
        }
        
        firebaseDataManager.restoreFromFirebase()
            .then(result => {
                alert(`Restored ${result.recordCount} records from Firebase successfully!`);
            })
            .catch(error => {
                alert(`Restore failed: ${error.message}`);
            });
        hideModal();
    }
    
    function clearAllData() {
        storageManager.clearAllData();
    }
    
    function clearLog() {
        logger.clearLog();
    }

    // ==============================================
    // MAP CACHE FUNCTIONS
    // ==============================================
    function cacheTiles() {
        const bounds = map.getBounds();
        const zoom = map.getZoom();
        
        if (satellite.cache) {
            satellite.cacheArea(bounds, zoom);
            logger.addLogEntry("Caching visible map area for offline use", "info");
            document.getElementById('cache-status').innerHTML = '<i class="fa-solid fa-sync fa-spin"></i> Caching in progress...';
            
            setTimeout(() => {
                if (satellite.cache) {
                    const usage = satellite.cache.getStorageUsed();
                    document.getElementById('cache-status').innerHTML = `<i class="fa-solid fa-hard-drive"></i> Storage Used: ${(usage / 1024 / 1024).toFixed(2)} MB`;
                }
            }, 2000);
        }
    }
    
    function clearCache() {
        if (satellite.cache) {
            satellite.cache.clear();
            logger.addLogEntry("Map cache cleared", "warning");
            document.getElementById('cache-status').innerHTML = '<i class="fa-solid fa-hard-drive"></i> Storage Used: 0 MB';
        }
    }

    // ==============================================
    // INITIALIZATION
    // ==============================================
    document.addEventListener('DOMContentLoaded', function() {
        loginSystem = new LoginSystem();
        
        // Set up global functions for button onclick handlers
        window.attemptLogin = function() {
            loginSystem.attemptFirebaseLogin();
        };
        
        window.initiateLogout = function() {
            loginSystem.initiateLogout();
        };
        
        window.finishLogout = function() {
            loginSystem.finishLogout();
        };
        
        window.cancelBackup = function() {
            loginSystem.cancelBackup();
        };
        
        window.setRegistrationType = setRegistrationType;
        window.toggleManualEntry = toggleManualEntry;
        window.setLocationMode = setLocationMode;
        window.clearManualPoint = clearManualPoint;
        window.capturePhoto = capturePhoto;
        window.handlePhotoUpload = handlePhotoUpload;
        window.removePhoto = removePhoto;
        window.saveData = saveData;
        window.cacheTiles = cacheTiles;
        window.clearCache = clearCache;
        window.centerOnGPS = centerOnGPS;
        window.toggleAutoCenter = toggleAutoCenter;
        window.clearAllMarkers = clearAllMarkers;
        window.showPreview = showPreview;
        window.hidePreview = hidePreview;
        window.goToLocation = goToLocation;
        window.showBackupModal = showBackupModal;
        window.showRestoreModal = showRestoreModal;
        window.hideModal = hideModal;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.backupToFirebase = backupToFirebase;
        window.restoreFromFirebase = restoreFromFirebase;
        window.clearAllData = clearAllData;
        window.clearLog = clearLog;
        window.exportData = exportData;
        window.exportGeoJSON = exportGeoJSON;
        window.loadRejectedPropertyIntoForm = loadRejectedPropertyIntoForm;
        window.hideRejectionFeedback = hideRejectionFeedback;
        window.syncAllToFirebase = function() {
            if (firebaseDataManager) {
                firebaseDataManager.syncAllToFirebase();
            } else {
                alert("Firebase not initialized. Please log in.");
            }
        };
        window.showAllNotifications = showAllNotifications;
        
        // Add update functions for geographical dropdowns
        window.updateSubcounties = updateSubcounties;
        window.updateParishes = updateParishes;
        window.updateVillages = updateVillages;
        
        // Set up network status indicator
        window.addEventListener('online', () => {
            document.getElementById('net-label').className = 'indicator on';
            document.getElementById('net-label').textContent = 'ONLINE';
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('net-label').className = 'indicator off';
            document.getElementById('net-label').textContent = 'OFFLINE';
        });
        
        // Initialize network status
        if (navigator.onLine) {
            document.getElementById('net-label').className = 'indicator on';
            document.getElementById('net-label').textContent = 'ONLINE';
        } else {
            document.getElementById('net-label').className = 'indicator off';
            document.getElementById('net-label').textContent = 'OFFLINE';
        }
    });
</script>
</body>
</html>
